<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Foundations of Astronomical Data Science: Join</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/dc/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicons/dc/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicons/dc/favicon-16x16.png"><link rel="manifest" href="../favicons/dc/site.webmanifest"><link rel="mask-icon" href="../favicons/dc/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav data"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="dc-logo" alt="Data Carpentry" src="../assets/images/data-logo.svg"></div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../06-join.html';">Learner View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav data" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Data Carpentry" src="../assets/images/data-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Foundations of Astronomical Data Science
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Foundations of Astronomical Data Science
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" href="calculating_MIST_isochrone.html">Making the Isochrone DataFrame</a></li><li><a class="dropdown-item" href="link-list.html">Link List</a></li><li><a class="dropdown-item" href="prereqs.html">Prerequisites</a></li><hr><li><a class="dropdown-item" href="discuss.html">Discussion</a></li><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Foundations of Astronomical Data Science
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 59%" class="percentage">
    59%
  </div>
  <div class="progress data">
    <div class="progress-bar data" role="progressbar" style="width: 59%" aria-valuenow="59" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../06-join.html">Learner View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-query.html">1. Basic Queries</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-coords.html">2. Coordinate Transformations</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-transform.html">3. Plotting and Tabular Data</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-motion.html">4. Plotting and Pandas</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-select.html">5. Transform and Select</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        6. Join
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#getting-photometry-data">Getting photometry data</a></li>
<li><a href="#the-best-neighbor-table">The best neighbor table</a></li>
<li><a href="#the-pan-starrs-table">The Pan-STARRS table</a></li>
<li><a href="#joining-tables">Joining tables</a></li>
<li><a href="#adding-the-best-neighbor-table">Adding the best neighbor table</a></li>
<li><a href="#adding-the-pan-starrs-table">Adding the Pan-STARRS table</a></li>
<li><a href="#selecting-by-coordinates-and-proper-motion">Selecting by coordinates and proper motion</a></li>
<li><a href="#checking-the-match">Checking the match</a></li>
<li><a href="#saving-the-dataframe">Saving the DataFrame</a></li>
<li><a href="#another-file-format---csv">Another file format - CSV</a></li>
<li><a href="#summary">Summary</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="07-photo.html">7. Photometry</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="08-plot.html">8. Visualization</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <li><a href="calculating_MIST_isochrone.html">Making the Isochrone DataFrame</a></li><li><a href="link-list.html">Link List</a></li><li><a href="prereqs.html">Prerequisites</a></li><hr><li><a class="dropdown-item" href="discuss.html">Discussion</a></li><li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/05-select.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/07-photo.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/05-select.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Transform and Select
        </a>
        <a class="chapter-link float-end" href="../instructor/07-photo.html" rel="next">
          Next: Photometry...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Join</h1>
        <p>Last updated on 2025-07-16 |

        <a href="https://github.com/datacarpentry/astronomy-python/edit/main/episodes/06-join.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 90 minutes</p>

        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How do we use <code>JOIN</code> to combine information from multiple
tables?</li>
<li>How can we make a selection within a joined table?</li>
<li>How should we save the result?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Write ADQL queries involving <code>JOIN</code> operations.</li>
<li>Save data in CSV format.</li>
</ul></div>
</div>
</div>
</div>
</div>
<p>The next step in our analysis is to select candidate stars based on
photometry data. The following figure from the Price-Whelan and Bonaca
paper is a color-magnitude diagram for the stars selected based on
proper motion:</p>
<figure><img width="300" src="../fig/gd1-3.png" alt="Color-magnitude diagram for the stars selected based on proper motion, from Price-Whelan and Bonaca paper." class="figure mx-auto d-block"></figure><p>In red is a <a href="https://en.wikipedia.org/wiki/Stellar_isochrone" class="external-link">stellar
isochrone</a>, showing where we expect the stars in GD-1 to fall based
on the metallicity and age of their original globular cluster.</p>
<p>By selecting stars in the shaded area, we can further distinguish the
main sequence of GD-1 from younger background stars.</p>
<div id="outline" class="callout checklist">
<div class="callout-square">
<i class="callout-icon" data-feather="check-square"></i>
</div>
<span class="callout-header">Checklist</span>
<div id="outline" class="callout-inner">
<h3 class="callout-title">Outline</h3>
<div class="callout-content">
<ol style="list-style-type: decimal"><li><p>We will reload the candidate stars we identified in the previous
episode.</p></li>
<li><p>Then we will run a query on the Gaia server that uploads the
table of candidates and uses a <code>JOIN</code> operation to select
photometry data for the candidate stars.</p></li>
<li><p>We will write the results to a file for use in the next
episode.</p></li>
</ol></div>
</div>
</div>
<div id="starting-from-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<span class="callout-header">Prerequisite</span>
<div id="starting-from-this-episode" class="callout-inner">
<h3 class="callout-title">Starting from this episode</h3>
<div class="callout-content">
<p>If you are starting a new notebook for this episode, expand this
section for information you will need to get started.</p>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> Read me </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" aria-labelledby="headingSpoiler1" data-bs-parent="#accordionSpoiler1">
<div class="accordion-body">
<p>In the previous episode, we define a rectangle around stars in GD-1
in spatial coordinates and in proper motion which we transformed into
ICRS coordinates and created point lists of the polygon vertices. We
will use that data for this episode. Whether you are working from a new
notebook or coming back from a checkpoint, reloading the data will save
you from having to run the query again.</p>
<p>If you are starting this episode here or starting this episode in a
new notebook, you will need run the following lines of code.</p>
<p>This imports previously imported functions:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">from</span> astroquery.gaia <span class="im">import</span> Gaia</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">from</span> episode_functions <span class="im">import</span> <span class="op">*</span></span></code></pre>
</div>
<p>The following code loads in the data (instructions for downloading
data can be found in the <a href="index.html#setup">setup instructions</a>).
You may need to add a the path to the filename variable below
(e.g. <code>filename = 'student_download/backup-data/gd1_data.hdf'</code>)</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_data.hdf'</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>point_series <span class="op">=</span> pd.read_hdf(filename, <span class="st">'point_series'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>sky_point_list <span class="op">=</span> point_series[<span class="st">'sky_point_list'</span>]</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>pmra_min <span class="op">=</span> point_series[<span class="st">'pmra_min'</span>]</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>pmra_max <span class="op">=</span> point_series[<span class="st">'pmra_max'</span>]</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>pmdec_min <span class="op">=</span> point_series[<span class="st">'pmdec_min'</span>]</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>pmdec_max <span class="op">=</span> point_series[<span class="st">'pmdec_max'</span>]</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>point_series</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="getting-photometry-data">Getting photometry data<a class="anchor" aria-label="anchor" href="#getting-photometry-data"></a></h2>
<hr class="half-width"><p>The Gaia dataset contains some photometry data, including the
variable <code>bp_rp</code>, which contains BP-RP color (the difference
in mean flux between the BP and RP bands). We use this variable to
select stars with <code>bp_rp</code> between -0.75 and 2, which excludes
many class M dwarf stars.</p>
<p>But we can do better than that. Assuming GD-1 is a globular cluster,
all of the stars formed at the same time from the same material, so the
stars’ photometric properties should be consistent with a single
isochrone in a color magnitude diagram. We can use photometric color and
apparent magnitude to select stars with the age and metal richness we
expect in GD-1. However, the broad Gaia photometric bands (G, BP, RP)
are not optimized for this task, instead we will use the more narrow
photometric bands available from the Pan-STARRS survey to obtain the
<code>g-i</code> color and apparent <code>g</code>-band magnitude.</p>
<p>Conveniently, the Gaia server provides data from Pan-STARRS as a
table in the same database we have been using, so we can access it by
making ADQL queries.</p>
<div id="a-caveat-about-matching-stars-between-catalogs" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="a-caveat-about-matching-stars-between-catalogs" class="callout-inner">
<h3 class="callout-title">A caveat about matching stars between
catalogs</h3>
<div class="callout-content">
<p>In general, choosing a star from the Gaia catalog and finding the
corresponding star in the Pan-STARRS catalog is not easy. This kind of
cross matching is not always possible, because a star might appear in
one catalog and not the other. And even when both stars are present,
there might not be a clear one-to-one relationship between stars in the
two catalogs. Additional <a href="https://docs.astropy.org/en/stable/coordinates/matchsep.html#matching-catalogs" class="external-link">catalog
matching tools</a> are available from the Astropy coordinates
package.</p>
<p>Fortunately, people have worked on this problem, and the Gaia
database includes cross-matching tables that suggest a best neighbor in
the Pan-STARRS catalog for many stars in the Gaia catalog.</p>
<p><a href="https://gea.esac.esa.int/archive/documentation/GDR2/Catalogue_consolidation/chap_cu9val_cu9val/ssec_cu9xma/sssec_cu9xma_extcat.html" class="external-link">This
document describes the cross matching process</a>. Briefly, it uses a
cone search to find possible matches in approximately the right
position, then uses attributes like color and magnitude to choose pairs
of observations most likely to be the same star.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="the-best-neighbor-table">The best neighbor table<a class="anchor" aria-label="anchor" href="#the-best-neighbor-table"></a></h2>
<hr class="half-width"><p>So the hard part of cross-matching has been done for us. Using the
results is a little tricky, but it gives us a chance to learn about one
of the most important tools for working with databases: “joining”
tables.</p>
<p>A “join” is an operation where you match up records from one table
with records from another table using as a “key” a piece of information
that is common to both tables, usually some kind of ID code.</p>
<p>In this example:</p>
<ul><li><p>Stars in the Gaia dataset are identified by
<code>source_id</code>.</p></li>
<li><p>Stars in the Pan-STARRS dataset are identified by
<code>obj_id</code>.</p></li>
</ul><p>For each candidate star we have selected so far, we have the
<code>source_id</code>; the goal is to find the <code>obj_id</code> for
the same star in the Pan-STARRS catalog.</p>
<p>To do that we will:</p>
<ol style="list-style-type: decimal"><li><p>Use the <code>JOIN</code> operator to look up each Pan-STARRS
<code>obj_id</code> for the stars we are interested in the
<code>panstarrs1_best_neighbour</code> table using the
<code>source_ids</code> that we have already identified.</p></li>
<li><p>Use the <code>JOIN</code> operator again to look up the
Pan-STARRS photometry for these stars in the
<code>panstarrs1_original_valid</code> table using the
<code>obj_ids</code> we just identified.</p></li>
</ol><p>Before we get to the <code>JOIN</code> operation, we will explore
these tables.</p>
<div id="british-vs-american-spelling-of-neighbour" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="british-vs-american-spelling-of-neighbour" class="callout-inner">
<h3 class="callout-title">British vs American Spelling of Neighbour</h3>
<div class="callout-content">
<p>The Gaia database was created and is maintained by the European Space
Astronomy Center. For this reason, the table spellings use the British
spelling of neighbour (with a “u”). Do not forget to include it in your
table names in the queries below.</p>
</div>
</div>
</div>
<p>Here is the metadata for <code>panstarrs1_best_neighbour</code>.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>ps_best_neighbour_meta <span class="op">=</span> Gaia.load_table(<span class="st">'gaiadr2.panstarrs1_best_neighbour'</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Retrieving table 'gaiadr2.panstarrs1_best_neighbour'
Parsing table 'gaiadr2.panstarrs1_best_neighbour'...
Done.</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="bu">print</span>(ps_best_neighbour_meta)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>TAP Table name: gaiadr2.gaiadr2.panstarrs1_best_neighbour
Description: Pan-STARRS1 BestNeighbour table lists each matched Gaia object with its
best neighbour in the external catalogue.
There are 1 327 157 objects in the filtered version of Pan-STARRS1 used
to compute this cross-match that have too early epochMean.
Num. columns: 7</code></pre>
</div>
<p>And here are the columns.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> ps_best_neighbour_meta.columns:</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    <span class="bu">print</span>(column.name)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">source_id</span></span>
<span><span class="va">original_ext_source_id</span></span>
<span><span class="va">angular_distance</span></span>
<span><span class="va">number_of_neighbours</span></span>
<span><span class="va">number_of_mates</span></span>
<span><span class="va">best_neighbour_multiplicity</span></span>
<span><span class="va">gaia_astrometric_params</span></span></code></pre>
</div>
<p>Here is the <a href="https://gea.esac.esa.int/archive/documentation/GDR2/Gaia_archive/chap_datamodel/sec_dm_crossmatches/ssec_dm_panstarrs1_best_neighbour.html" class="external-link">documentation
for these variables</a>.</p>
<p>The ones we will use are:</p>
<ul><li><p><code>source_id</code>, which we will match up with
<code>source_id</code> in the Gaia table.</p></li>
<li><p><code>best_neighbour_multiplicity</code>, which indicates how
many sources in Pan-STARRS are matched with the same probability to this
source in Gaia.</p></li>
<li><p><code>number_of_mates</code>, which indicates the number of
<em>other</em> sources in Gaia that are matched with the same source in
Pan-STARRS.</p></li>
<li><p><code>original_ext_source_id</code>, which we will match up with
<code>obj_id</code> in the Pan-STARRS table.</p></li>
</ul><p>Ideally, <code>best_neighbour_multiplicity</code> should be 1 and
<code>number_of_mates</code> should be 0; in that case, there is a
one-to-one match between the source in Gaia and the corresponding source
in Pan-STARRS.</p>
<div id="number-of-neighbors" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="number-of-neighbors" class="callout-inner">
<h3 class="callout-title">Number of neighbors</h3>
<div class="callout-content">
<p>The table also contains <code>number_of_neighbours</code> which is
the number of stars in Pan-STARRS that match in terms of position,
before using other criteria to choose the most likely match. But we are
more interested in the final match, using both criteria.</p>
</div>
</div>
</div>
<p>Here is a query that selects these columns and returns the first 5
rows.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>ps_best_neighbour_query <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="st">TOP 5</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="st">source_id, best_neighbour_multiplicity, number_of_mates, original_ext_source_id</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="st">FROM gaiadr2.panstarrs1_best_neighbour</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>ps_best_neighbour_job <span class="op">=</span> Gaia.launch_job_async(ps_best_neighbour_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>ps_best_neighbour_results <span class="op">=</span> ps_best_neighbour_job.get_results()</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>ps_best_neighbour_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=5&gt;
     source_id      best_neighbour_multiplicity number_of_mates original_ext_source_id
       int64                  int32                  int16              int64
------------------- --------------------------- --------------- ----------------------
6745938972433480704                           1               0      69742925668851205
6030466788955954048                           1               0      69742509325691172
6756488099308169600                           1               0      69742879438541228
6700154994715046016                           1               0      69743055581721207
6757061941303252736                           1               0      69742856540241198</code></pre>
</div>
</section><section><h2 class="section-heading" id="the-pan-starrs-table">The Pan-STARRS table<a class="anchor" aria-label="anchor" href="#the-pan-starrs-table"></a></h2>
<hr class="half-width"><p>Now that we know the Pan-STARRS <code>obj_id</code>, we are ready to
match this to the photometry in the
<code>panstarrs1_original_valid</code> table. Here is the metadata for
the table that contains the Pan-STARRS data.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>ps_valid_meta <span class="op">=</span> Gaia.load_table(<span class="st">'gaiadr2.panstarrs1_original_valid'</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Retrieving table 'gaiadr2.panstarrs1_original_valid'
Parsing table 'gaiadr2.panstarrs1_original_valid'...
Done.</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="bu">print</span>(ps_valid_meta)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>TAP Table name: gaiadr2.gaiadr2.panstarrs1_original_valid
Description: The Panoramic Survey Telescope and Rapid Response System (Pan-STARRS) is
a system for wide-field astronomical imaging developed and operated by
the Institute for Astronomy at the University of Hawaii. Pan-STARRS1
(PS1) is the first part of Pan-STARRS to be completed and is the basis
for Data Release 1 (DR1). The PS1 survey used a 1.8 meter telescope and
its 1.4 Gigapixel camera to image the sky in five broadband filters (g,
r, i, z, y).

The current table contains a filtered subsample of the 10 723 304 629
entries listed in the original ObjectThin table.
[Output truncated]</code></pre>
</div>
<p>And here are the columns.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> ps_valid_meta.columns:</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>    <span class="bu">print</span>(column.name)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>obj_name
obj_id
ra
dec
ra_error
dec_error
epoch_mean
g_mean_psf_mag
g_mean_psf_mag_error
g_flags
r_mean_psf_mag
[Output truncated]</code></pre>
</div>
<p>Here is the <a href="https://gea.esac.esa.int/archive/documentation/GDR2/Gaia_archive/chap_datamodel/sec_dm_external_catalogues/ssec_dm_panstarrs1_original_valid.html" class="external-link">documentation
for these variables</a> .</p>
<p>The ones we will use are:</p>
<ul><li><p><code>obj_id</code>, which we will match up with
<code>original_ext_source_id</code> in the best neighbor table.</p></li>
<li><p><code>g_mean_psf_mag</code>, which contains mean magnitude from
the <code>g</code> filter.</p></li>
<li><p><code>i_mean_psf_mag</code>, which contains mean magnitude from
the <code>i</code> filter.</p></li>
</ul><p>Here is a query that selects these variables and returns the first 5
rows.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>ps_valid_query <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="st">TOP 5</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="st">obj_id, g_mean_psf_mag, i_mean_psf_mag </span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="st">FROM gaiadr2.panstarrs1_original_valid</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>ps_valid_job <span class="op">=</span> Gaia.launch_job_async(ps_valid_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>ps_valid_results <span class="op">=</span> ps_valid_job.get_results()</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>ps_valid_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=5&gt;
      obj_id      g_mean_psf_mag  i_mean_psf_mag
                                       mag
      int64          float64         float64
----------------- -------------- ----------------
67130655389101425             -- 20.3516006469727
67553305590067819             --  19.779899597168
67551423248967849             -- 19.8889007568359
67132026238911331             -- 20.9062995910645
67553513677687787             -- 21.2831001281738</code></pre>
</div>
</section><section><h2 class="section-heading" id="joining-tables">Joining tables<a class="anchor" aria-label="anchor" href="#joining-tables"></a></h2>
<hr class="half-width"><p>The following figure shows how these tables are related.</p>
<ul><li><p>The orange circles and arrows represent the first
<code>JOIN</code> operation, which takes each <code>source_id</code> in
the Gaia table and finds the same value of <code>source_id</code> in the
best neighbor table.</p></li>
<li><p>The blue circles and arrows represent the second
<code>JOIN</code> operation, which takes each
<code>original_ext_source_id</code> in the best neighbor table and finds
the same value of <code>obj_id</code> in the PanSTARRS photometry
table.</p></li>
</ul><p>There is no guarantee that the corresponding rows of these tables are
in the same order, so the <code>JOIN</code> operation involves some
searching. However, ADQL/SQL databases are implemented in a way that
makes this kind of search efficient. If you are curious, you can <a href="https://chartio.com/learn/databases/how-does-indexing-work/" class="external-link">read
more about it</a>.</p>
<figure><img src="../fig/join.png" alt="Diagram showing relationship between the gaia_source, panstarrs1_best_neighbour, and panstarrs1_original_valid tables and result table." class="figure mx-auto d-block"></figure><p>Now we will get to the details of performing a <code>JOIN</code>
operation.</p>
<p>We are about to build a complex query using software that doesn’t
provide us with any helpful information for debugging. For this reason
we are going to start with a simplified version of what we want to do
until we are sure we are joining the tables correctly, then we will
slowly add more layers of complexity, checking at each stage that our
query still works. As a starting place, we will go all the way back to
the cone search from episode 2.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>test_cone_query <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="st">TOP 10 </span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="st">source_id</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="st">WHERE 1=CONTAINS(</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="st">  POINT(ra, dec),</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="st">  CIRCLE(88.8, 7.4, 0.08333333))</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>And we will run it, to make sure we have a working query to build
on.</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>test_cone_job <span class="op">=</span> Gaia.launch_job(test_cone_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>test_cone_results <span class="op">=</span> test_cone_job.get_results()</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>test_cone_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=10&gt;
     source_id
       int64
-------------------
3322773965056065536
3322773758899157120
3322774068134271104
3322773930696320512
3322774377374425728
3322773724537891456
3322773724537891328
[Output truncated]</code></pre>
</div>
<p>Now we can start adding features. First, we will replace
<code>source_id</code> with the format specifier <code>columns</code> so
that we can alter what columns we want to return without having to
modify our base query:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>cone_base_query <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a><span class="st">WHERE 1=CONTAINS(</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a><span class="st">  POINT(ra, dec),</span></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a><span class="st">  CIRCLE(88.8, 7.4, 0.08333333))</span></span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>As a reminder, here are the columns we want from the Gaia table:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>columns <span class="op">=</span> <span class="st">'source_id, ra, dec, pmra, pmdec'</span></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>cone_query <span class="op">=</span> cone_base_query.<span class="bu">format</span>(columns<span class="op">=</span>columns)</span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a><span class="bu">print</span>(cone_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SELECT
source_id, ra, dec, pmra, pmdec
FROM gaiadr2.gaia_source
WHERE 1=CONTAINS(
  POINT(ra, dec),
  CIRCLE(88.8, 7.4, 0.08333333))</code></pre>
</div>
<p>We run the query again.</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>cone_job <span class="op">=</span> Gaia.launch_job_async(cone_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>cone_results <span class="op">=</span> cone_job.get_results()</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>cone_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=594&gt;
     source_id              ra        ...        pmdec
                           deg        ...       mas / yr
       int64             float64      ...       float64
------------------- ----------------- ... -------------------
3322773965056065536 88.78178020183375 ... -2.5057036964736907
3322773758899157120 88.83227057144585 ...                  --
3322774068134271104  88.8206092188033 ... -1.5260889445858044
3322773930696320512 88.80843339290348 ... -0.9292104395445717
3322774377374425728 88.86806108182265 ... -3.8676624830902435
3322773724537891456 88.81308602813434 ... -33.078133430952086
[Output truncated]</code></pre>
</div>
</section><section><h2 class="section-heading" id="adding-the-best-neighbor-table">Adding the best neighbor table<a class="anchor" aria-label="anchor" href="#adding-the-best-neighbor-table"></a></h2>
<hr class="half-width"><p>Now we are ready for the first join. The join operation requires two
clauses:</p>
<ul><li><p><code>JOIN</code> specifies the name of the table we want to join
with, and</p></li>
<li><p><code>ON</code> specifies how we will match up rows between the
tables.</p></li>
</ul><p>In this example, we join with
<code>gaiadr2.panstarrs1_best_neighbour AS best</code>, which means we
can refer to the best neighbor table with the abbreviated name
<code>best</code>, which will save us a lot of typing. Similarly, we
will be referring to the <code>gaiadr2.gaia_source</code> table by the
abbreviated name <code>gaia</code>.</p>
<p>The <code>ON</code> clause indicates that we will match up the
<code>source_id</code> column from the Gaia table with the
<code>source_id</code> column from the best neighbor table.</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a>neighbours_base_query <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source AS gaia</span></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a><span class="st">JOIN gaiadr2.panstarrs1_best_neighbour AS best</span></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a><span class="st">  ON gaia.source_id = best.source_id</span></span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a><span class="st">WHERE 1=CONTAINS(</span></span>
<span id="cb37-7"><a href="#cb37-7" tabindex="-1"></a><span class="st">  POINT(gaia.ra, gaia.dec),</span></span>
<span id="cb37-8"><a href="#cb37-8" tabindex="-1"></a><span class="st">  CIRCLE(88.8, 7.4, 0.08333333))</span></span>
<span id="cb37-9"><a href="#cb37-9" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<div id="sql-detail" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="sql-detail" class="callout-inner">
<h3 class="callout-title">SQL detail</h3>
<div class="callout-content">
<p>In this example, the <code>ON</code> column has the same name in both
tables, so we could replace the <code>ON</code> clause with a simpler <a href="https://docs.oracle.com/javadb/10.8.3.0/ref/rrefsqljusing.html" class="external-link"><code>USING</code>clause</a>:</p>
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">SQL<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sql" tabindex="0"><code class="sourceCode sql"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a><span class="kw">USING</span>(source_id)</span></code></pre>
</div>
</div>
</div>
</div>
<p>Now that there is more than one table involved, we can’t use simple
column names any more; we have to use <strong>qualified column
names</strong>. In other words, we have to specify which table each
column is in. The column names do not have to be the same and, in fact,
in the next join they will not be. That is one of the reasons that we
explicitly specify them. Here is the complete query, including the
columns we want from the Gaia and best neighbor tables. Here you can
start to see that using the abbreviated names is making our query easier
to read and requires less typing for us. In addition to the spatial
coordinates and proper motion, we are going to return the
<code>best_neighbour_multiplicity</code> and
<code>number_of_mates</code> columns from the
<code>panstarrs1_best_neighbour</code> table in order to evaluate the
quality of the data that we are using by evaluating the number of
one-to-one matches between the catalogs. Recall that
<code>best_neighbour_multiplicity</code> tells us the number of
PanSTARRs objects that match a Gaia object and
<code>number_of_mates</code> tells us the number of Gaia objects that
match a PanSTARRs object.</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>column_list_neighbours <span class="op">=</span> [<span class="st">'gaia.source_id'</span>,</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>               <span class="st">'gaia.ra'</span>,</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>               <span class="st">'gaia.dec'</span>,</span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a>               <span class="st">'gaia.pmra'</span>,</span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a>               <span class="st">'gaia.pmdec'</span>,</span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a>               <span class="st">'best.best_neighbour_multiplicity'</span>,</span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a>               <span class="st">'best.number_of_mates'</span>,</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>              ]</span>
<span id="cb39-9"><a href="#cb39-9" tabindex="-1"></a>columns <span class="op">=</span> <span class="st">', '</span>.join(column_list_neighbours)</span>
<span id="cb39-10"><a href="#cb39-10" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" tabindex="-1"></a>neighbours_query <span class="op">=</span> neighbours_base_query.<span class="bu">format</span>(columns<span class="op">=</span>columns)</span>
<span id="cb39-12"><a href="#cb39-12" tabindex="-1"></a><span class="bu">print</span>(neighbours_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SELECT
gaia.source_id, gaia.ra, gaia.dec, gaia.pmra, gaia.pmdec, best.best_neighbour_multiplicity, best.number_of_mates
FROM gaiadr2.gaia_source AS gaia
JOIN gaiadr2.panstarrs1_best_neighbour AS best
  ON gaia.source_id = best.source_id
WHERE 1=CONTAINS(
  POINT(gaia.ra, gaia.dec),
  CIRCLE(88.8, 7.4, 0.08333333))</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>neighbours_job <span class="op">=</span> Gaia.launch_job_async(neighbours_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>neighbours_results <span class="op">=</span> neighbours_job.get_results()</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a>neighbours_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=490&gt;
     source_id              ra        ... number_of_mates
                           deg        ...
       int64             float64      ...      int16
------------------- ----------------- ... ---------------
3322773965056065536 88.78178020183375 ...               0
3322774068134271104  88.8206092188033 ...               0
3322773930696320512 88.80843339290348 ...               0
3322774377374425728 88.86806108182265 ...               0
3322773724537891456 88.81308602813434 ...               0
3322773724537891328 88.81570329208743 ...               0
[Output truncated]</code></pre>
</div>
<p>This result has fewer rows than the previous result. That is because
there are sources in the Gaia table with no corresponding source in the
Pan-STARRS table.</p>
<p>By default, the result of the join only includes rows where the same
<code>source_id</code> appears in both tables. This default is called an
“inner” join because the results include only the intersection of the
two tables. <a href="https://www.geeksforgeeks.org/sql-join-set-1-inner-left-right-and-full-joins/" class="external-link">You
can read about the other kinds of join here</a>.</p>
</section><section><h2 class="section-heading" id="adding-the-pan-starrs-table">Adding the Pan-STARRS table<a class="anchor" aria-label="anchor" href="#adding-the-pan-starrs-table"></a></h2>
<hr class="half-width"><div id="exercise-15-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-15-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (15 minutes)</h3>
<div class="callout-content">
<p>Now we are ready to bring in the Pan-STARRS table. Starting with the
previous query, add a second <code>JOIN</code> clause that joins with
<code>gaiadr2.panstarrs1_original_valid</code>, gives it the abbreviated
name <code>ps</code>, and matches <code>original_ext_source_id</code>
from the best neighbor table with <code>obj_id</code> from the
Pan-STARRS table.</p>
<p>Add <code>g_mean_psf_mag</code> and <code>i_mean_psf_mag</code> to
the column list, and run the query. The result should contain 490 rows
and 9 columns.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a>join_solution_query_base <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source as gaia</span></span>
<span id="cb45-4"><a href="#cb45-4" tabindex="-1"></a><span class="st">JOIN gaiadr2.panstarrs1_best_neighbour as best</span></span>
<span id="cb45-5"><a href="#cb45-5" tabindex="-1"></a><span class="st">  ON gaia.source_id = best.source_id</span></span>
<span id="cb45-6"><a href="#cb45-6" tabindex="-1"></a><span class="st">JOIN gaiadr2.panstarrs1_original_valid as ps</span></span>
<span id="cb45-7"><a href="#cb45-7" tabindex="-1"></a><span class="st">  ON best.original_ext_source_id = ps.obj_id</span></span>
<span id="cb45-8"><a href="#cb45-8" tabindex="-1"></a><span class="st">WHERE 1=CONTAINS(</span></span>
<span id="cb45-9"><a href="#cb45-9" tabindex="-1"></a><span class="st">  POINT(gaia.ra, gaia.dec),</span></span>
<span id="cb45-10"><a href="#cb45-10" tabindex="-1"></a><span class="st">  CIRCLE(88.8, 7.4, 0.08333333))</span></span>
<span id="cb45-11"><a href="#cb45-11" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb45-12"><a href="#cb45-12" tabindex="-1"></a></span>
<span id="cb45-13"><a href="#cb45-13" tabindex="-1"></a>column_list <span class="op">=</span> [<span class="st">'gaia.source_id'</span>,</span>
<span id="cb45-14"><a href="#cb45-14" tabindex="-1"></a>               <span class="st">'gaia.ra'</span>,</span>
<span id="cb45-15"><a href="#cb45-15" tabindex="-1"></a>               <span class="st">'gaia.dec'</span>,</span>
<span id="cb45-16"><a href="#cb45-16" tabindex="-1"></a>               <span class="st">'gaia.pmra'</span>,</span>
<span id="cb45-17"><a href="#cb45-17" tabindex="-1"></a>               <span class="st">'gaia.pmdec'</span>,</span>
<span id="cb45-18"><a href="#cb45-18" tabindex="-1"></a>               <span class="st">'best.best_neighbour_multiplicity'</span>,</span>
<span id="cb45-19"><a href="#cb45-19" tabindex="-1"></a>               <span class="st">'best.number_of_mates'</span>,</span>
<span id="cb45-20"><a href="#cb45-20" tabindex="-1"></a>               <span class="st">'ps.g_mean_psf_mag'</span>,</span>
<span id="cb45-21"><a href="#cb45-21" tabindex="-1"></a>               <span class="st">'ps.i_mean_psf_mag'</span>]</span>
<span id="cb45-22"><a href="#cb45-22" tabindex="-1"></a></span>
<span id="cb45-23"><a href="#cb45-23" tabindex="-1"></a>columns <span class="op">=</span> <span class="st">', '</span>.join(column_list)</span>
<span id="cb45-24"><a href="#cb45-24" tabindex="-1"></a></span>
<span id="cb45-25"><a href="#cb45-25" tabindex="-1"></a>join_solution_query <span class="op">=</span> join_solution_query_base.<span class="bu">format</span>(columns<span class="op">=</span>columns)</span>
<span id="cb45-26"><a href="#cb45-26" tabindex="-1"></a><span class="bu">print</span>(join_solution_query)</span>
<span id="cb45-27"><a href="#cb45-27" tabindex="-1"></a></span>
<span id="cb45-28"><a href="#cb45-28" tabindex="-1"></a>join_solution_job <span class="op">=</span> Gaia.launch_job_async(join_solution_query)</span>
<span id="cb45-29"><a href="#cb45-29" tabindex="-1"></a>join_solution_results <span class="op">=</span> join_solution_job.get_results()</span>
<span id="cb45-30"><a href="#cb45-30" tabindex="-1"></a>join_solution_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=490&gt;
     source_id              ra        ...  g_mean_psf_mag   i_mean_psf_mag
                           deg        ...                        mag
       int64             float64      ...     float64          float64
------------------- ----------------- ... ---------------- ----------------
3322773965056065536 88.78178020183375 ... 19.9431991577148 17.4221992492676
3322774068134271104  88.8206092188033 ... 18.6212005615234 16.6007995605469
3322773930696320512 88.80843339290348 ...               -- 20.2203998565674
3322774377374425728 88.86806108182265 ... 18.0676002502441 16.9762001037598
3322773724537891456 88.81308602813434 ... 20.1907005310059 17.8700008392334
3322773724537891328 88.81570329208743 ... 22.6308002471924 19.6004009246826
[Output truncated]</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="selecting-by-coordinates-and-proper-motion">Selecting by coordinates and proper motion<a class="anchor" aria-label="anchor" href="#selecting-by-coordinates-and-proper-motion"></a></h2>
<hr class="half-width"><p>We are now going to replace the cone search with the GD-1 selection
that we built in previous episodes. We will start by making sure that
our previous query works, then add in the <code>JOIN</code>. Now we will
bring in the <code>WHERE</code> clause from the previous episode, which
selects sources based on parallax, BP-RP color, sky coordinates, and
proper motion.</p>
<p>Here is <code>candidate_coord_pm_query_base</code> from the previous
episode.</p>
<div class="codewrapper sourceCode" id="cb47">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a>candidate_coord_pm_query_base <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a><span class="st">WHERE parallax &lt; 1</span></span>
<span id="cb47-5"><a href="#cb47-5" tabindex="-1"></a><span class="st">  AND bp_rp BETWEEN -0.75 AND 2 </span></span>
<span id="cb47-6"><a href="#cb47-6" tabindex="-1"></a><span class="st">  AND 1 = CONTAINS(POINT(ra, dec), </span></span>
<span id="cb47-7"><a href="#cb47-7" tabindex="-1"></a><span class="st">                   POLYGON(</span><span class="sc">{sky_point_list}</span><span class="st">))</span></span>
<span id="cb47-8"><a href="#cb47-8" tabindex="-1"></a><span class="st">  AND pmra BETWEEN </span><span class="sc">{pmra_min}</span><span class="st"> AND  </span><span class="sc">{pmra_max}</span></span>
<span id="cb47-9"><a href="#cb47-9" tabindex="-1"></a><span class="st">  AND pmdec BETWEEN </span><span class="sc">{pmdec_min}</span><span class="st"> AND </span><span class="sc">{pmdec_max}</span></span>
<span id="cb47-10"><a href="#cb47-10" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>Now we can assemble the query using the sky point list and proper
motion range we compiled in episode 5.</p>
<div class="codewrapper sourceCode" id="cb48">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a>columns <span class="op">=</span> <span class="st">'source_id, ra, dec, pmra, pmdec'</span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a>candidate_coord_pm_query <span class="op">=</span> candidate_coord_pm_query_base.<span class="bu">format</span>(columns<span class="op">=</span>columns,</span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a>                            sky_point_list<span class="op">=</span>sky_point_list,</span>
<span id="cb48-5"><a href="#cb48-5" tabindex="-1"></a>                            pmra_min<span class="op">=</span>pmra_min,</span>
<span id="cb48-6"><a href="#cb48-6" tabindex="-1"></a>                            pmra_max<span class="op">=</span>pmra_max,</span>
<span id="cb48-7"><a href="#cb48-7" tabindex="-1"></a>                            pmdec_min<span class="op">=</span>pmdec_min,</span>
<span id="cb48-8"><a href="#cb48-8" tabindex="-1"></a>                            pmdec_max<span class="op">=</span>pmdec_max)</span>
<span id="cb48-9"><a href="#cb48-9" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" tabindex="-1"></a><span class="bu">print</span>(candidate_coord_pm_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SELECT
source_id, ra, dec, pmra, pmdec
FROM gaiadr2.gaia_source
WHERE parallax &lt; 1
  AND bp_rp BETWEEN -0.75 AND 2
  AND 1 = CONTAINS(POINT(ra, dec),
                   POLYGON(135.306, 8.39862, 126.51, 13.4449, 163.017, 54.2424, 172.933, 46.4726, 135.306, 8.39862))
  AND pmra BETWEEN -6.70 AND -3
  AND pmdec BETWEEN -14.31 AND -11.2</code></pre>
</div>
<p>We run it to make sure we are starting with a working query.</p>
<div class="codewrapper sourceCode" id="cb50">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a>candidate_coord_pm_job <span class="op">=</span> Gaia.launch_job_async(candidate_coord_pm_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb52">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a>candidate_coord_pm_results <span class="op">=</span> candidate_coord_pm_job.get_results()</span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a>candidate_coord_pm_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=8409&gt;
    source_id              ra         ...        pmdec
                          deg         ...       mas / yr
      int64             float64       ...       float64
------------------ ------------------ ... -------------------
635559124339440000 137.58671691646745 ... -12.490481778113859
635860218726658176  138.5187065217173 ... -11.346409129876392
635674126383965568  138.8428741026386 ... -12.702779525389634
635535454774983040  137.8377518255436 ... -14.492308604905652
635497276810313600  138.0445160213759 ... -12.291499169815987
635614168640132864 139.59219748145836 ... -13.708904908478631
[Output truncated]</code></pre>
</div>
<div id="exercise-15-minutes-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-15-minutes-1" class="callout-inner">
<h3 class="callout-title">Exercise (15 minutes)</h3>
<div class="callout-content">
<p>Create a new query base called <code>candidate_join_query_base</code>
that combines the <code>WHERE</code> clauses from the previous query
with the <code>JOIN</code> clauses for the best neighbor and Pan-STARRS
tables. Format the query base using the column names in
<code>column_list</code>, and call the result
<code>candidate_join_query</code>.</p>
<p>Hint: Make sure you use qualified column names everywhere!</p>
<p>Run your query and download the results. The table you get should
have 4300 rows and 9 columns.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb54">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a>candidate_join_query_base <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a><span class="st">SELECT </span></span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb54-4"><a href="#cb54-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source as gaia</span></span>
<span id="cb54-5"><a href="#cb54-5" tabindex="-1"></a><span class="st">JOIN gaiadr2.panstarrs1_best_neighbour as best</span></span>
<span id="cb54-6"><a href="#cb54-6" tabindex="-1"></a><span class="st">  ON gaia.source_id = best.source_id</span></span>
<span id="cb54-7"><a href="#cb54-7" tabindex="-1"></a><span class="st">JOIN gaiadr2.panstarrs1_original_valid as ps</span></span>
<span id="cb54-8"><a href="#cb54-8" tabindex="-1"></a><span class="st">  ON best.original_ext_source_id = ps.obj_id</span></span>
<span id="cb54-9"><a href="#cb54-9" tabindex="-1"></a><span class="st">WHERE parallax &lt; 1</span></span>
<span id="cb54-10"><a href="#cb54-10" tabindex="-1"></a><span class="st">  AND bp_rp BETWEEN -0.75 AND 2 </span></span>
<span id="cb54-11"><a href="#cb54-11" tabindex="-1"></a><span class="st">  AND 1 = CONTAINS(POINT(gaia.ra, gaia.dec), </span></span>
<span id="cb54-12"><a href="#cb54-12" tabindex="-1"></a><span class="st">                   POLYGON(</span><span class="sc">{sky_point_list}</span><span class="st">))</span></span>
<span id="cb54-13"><a href="#cb54-13" tabindex="-1"></a><span class="st">  AND gaia.pmra BETWEEN </span><span class="sc">{pmra_min}</span><span class="st"> AND  </span><span class="sc">{pmra_max}</span></span>
<span id="cb54-14"><a href="#cb54-14" tabindex="-1"></a><span class="st">  AND gaia.pmdec BETWEEN </span><span class="sc">{pmdec_min}</span><span class="st"> AND </span><span class="sc">{pmdec_max}</span></span>
<span id="cb54-15"><a href="#cb54-15" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb54-16"><a href="#cb54-16" tabindex="-1"></a></span>
<span id="cb54-17"><a href="#cb54-17" tabindex="-1"></a>columns <span class="op">=</span> <span class="st">', '</span>.join(column_list)</span>
<span id="cb54-18"><a href="#cb54-18" tabindex="-1"></a></span>
<span id="cb54-19"><a href="#cb54-19" tabindex="-1"></a>candidate_join_query <span class="op">=</span> candidate_join_query_base.<span class="bu">format</span>(columns<span class="op">=</span>columns,</span>
<span id="cb54-20"><a href="#cb54-20" tabindex="-1"></a>                            sky_point_list<span class="op">=</span> sky_point_list,</span>
<span id="cb54-21"><a href="#cb54-21" tabindex="-1"></a>                            pmra_min<span class="op">=</span>pmra_min,</span>
<span id="cb54-22"><a href="#cb54-22" tabindex="-1"></a>                            pmra_max<span class="op">=</span>pmra_max,</span>
<span id="cb54-23"><a href="#cb54-23" tabindex="-1"></a>                            pmdec_min<span class="op">=</span>pmdec_min,</span>
<span id="cb54-24"><a href="#cb54-24" tabindex="-1"></a>                            pmdec_max<span class="op">=</span>pmdec_max)</span>
<span id="cb54-25"><a href="#cb54-25" tabindex="-1"></a><span class="bu">print</span>(candidate_join_query)</span>
<span id="cb54-26"><a href="#cb54-26" tabindex="-1"></a></span>
<span id="cb54-27"><a href="#cb54-27" tabindex="-1"></a></span>
<span id="cb54-28"><a href="#cb54-28" tabindex="-1"></a>candidate_join_job <span class="op">=</span> Gaia.launch_job_async(candidate_join_query)</span>
<span id="cb54-29"><a href="#cb54-29" tabindex="-1"></a>candidate_table <span class="op">=</span> candidate_join_job.get_results()</span>
<span id="cb54-30"><a href="#cb54-30" tabindex="-1"></a>candidate_table</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="checking-the-match">Checking the match<a class="anchor" aria-label="anchor" href="#checking-the-match"></a></h2>
<hr class="half-width"><p>To get more information about the matching process, we can inspect
<code>best_neighbour_multiplicity</code>, which indicates for each star
in Gaia how many stars in Pan-STARRS are equally likely matches.</p>
<div class="codewrapper sourceCode" id="cb55">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a>candidate_table[<span class="st">'best_neighbour_multiplicity'</span>]</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;MaskedColumn name='best_neighbour_multiplicity' dtype='int16' description='Number of neighbours with same probability as best neighbour' length=4300&gt;
  1
  1
  1
  1
  1
  1
  1
  1
  1
  1
[Output truncated]</code></pre>
</div>
<p>Most of the values are <code>1</code>, which is good; that means that
for each candidate star we have identified exactly one source in
Pan-STARRS that is likely to be the same star.</p>
<p>To check whether there are any values other than <code>1</code>, we
can convert this column to a Pandas <code>Series</code> and use
<code>describe</code>, which we saw in in episode 3.</p>
<div class="codewrapper sourceCode" id="cb57">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a>multiplicity <span class="op">=</span> pd.Series(candidate_table[<span class="st">'best_neighbour_multiplicity'</span>])</span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a>multiplicity.describe()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>count    4300.0
mean        1.0
std         0.0
min         1.0
25%         1.0
50%         1.0
75%         1.0
max         1.0
dtype: float64</code></pre>
</div>
<p>In fact, <code>1</code> is the only value in the <code>Series</code>,
so every candidate star has a single best match.</p>
<div id="numpy-mask-warning" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="numpy-mask-warning" class="callout-inner">
<h3 class="callout-title">Numpy Mask Warning</h3>
<div class="callout-content">
<p>You may see a warning that ends with the following phrase:</p>
<p><code>site-packages/numpy/lib/function_base.py:4650:</code></p>
<p><code>UserWarning: Warning: 'partition' will ignore the 'mask' of the MaskedColumn.</code>
<code>arr.partition(</code></p>
<p>This is because astroquery is returning a table with masked columns
(which are really fancy masked numpy arrays). When we turn this column
into a pandas Series, it maintains its mask. Describe calls numpy
functions to perform statistics. Numpy recently implemented this warning
to let you know that the mask is not being considered in the calculation
its performing.</p>
</div>
</div>
</div>
<p>Similarly, <code>number_of_mates</code> indicates the number of
<em>other</em> stars in Gaia that match with the same star in
Pan-STARRS.</p>
<div class="codewrapper sourceCode" id="cb59">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a>mates <span class="op">=</span> pd.Series(candidate_table[<span class="st">'number_of_mates'</span>])</span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a>mates.describe()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>count    4300.0
mean        0.0
std         0.0
min         0.0
25%         0.0
50%         0.0
75%         0.0
max         0.0
dtype: float64</code></pre>
</div>
<p>All values in this column are <code>0</code>, which means that for
each match we found in Pan-STARRS, there are no other stars in Gaia that
also match.</p>
</section><section><h2 class="section-heading" id="saving-the-dataframe">Saving the DataFrame<a class="anchor" aria-label="anchor" href="#saving-the-dataframe"></a></h2>
<hr class="half-width"><p>We can make a <code>DataFrame</code> from our Astropy
<code>Table</code> and save our results so we can pick up where we left
off without running this query again. Once again, we will make use of
our <code>make_dataframe</code> function.</p>
<div class="codewrapper sourceCode" id="cb61">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a>candidate_df <span class="op">=</span> make_dataframe(candidate_table)</span></code></pre>
</div>
<p>The HDF5 file should already exist, so we’ll add
<code>candidate_df</code> to it.</p>
<div class="codewrapper sourceCode" id="cb62">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_data.hdf'</span></span>
<span id="cb62-2"><a href="#cb62-2" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" tabindex="-1"></a>candidate_df.to_hdf(filename, <span class="st">'candidate_df'</span>)</span></code></pre>
</div>
<p>We can use <code>getsize</code> to confirm that the file exists and
check the size:</p>
<div class="codewrapper sourceCode" id="cb63">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a><span class="im">from</span> os.path <span class="im">import</span> getsize</span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" tabindex="-1"></a>MB <span class="op">=</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span></span>
<span id="cb63-4"><a href="#cb63-4" tabindex="-1"></a>getsize(filename) <span class="op">/</span> MB</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">15.422508239746094</span></span></code></pre>
</div>
</section><section><h2 class="section-heading" id="another-file-format---csv">Another file format - CSV<a class="anchor" aria-label="anchor" href="#another-file-format---csv"></a></h2>
<hr class="half-width"><p>Pandas can write a variety of other formats, <a href="https://pandas.pydata.org/pandas-docs/stable/user_guide/io.html" class="external-link">which
you can read about here</a>. We won’t cover all of them, but one other
important one is <a href="https://en.wikipedia.org/wiki/Comma-separated_values" class="external-link">CSV</a>,
which stands for “comma-separated values”.</p>
<p>CSV is a plain-text format that can be read and written by pretty
much any tool that works with data. In that sense, it is the “least
common denominator” of data formats.</p>
<p>However, it has an important limitation: some information about the
data gets lost in translation, notably the data types. If you read a CSV
file from someone else, you might need some additional information to
make sure you are getting it right.</p>
<p>Also, CSV files tend to be big, and slow to read and write.</p>
<p>With those caveats, here is how to write one:</p>
<div class="codewrapper sourceCode" id="cb65">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a>candidate_df.to_csv(<span class="st">'gd1_data.csv'</span>)</span></code></pre>
</div>
<p>We can check the file size like this:</p>
<div class="codewrapper sourceCode" id="cb66">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a>getsize(<span class="st">'gd1_data.csv'</span>) <span class="op">/</span> MB</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">0.8787498474121094</span></span></code></pre>
</div>
<p>We can read the CSV file back like this:</p>
<div class="codewrapper sourceCode" id="cb68">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a>read_back_csv <span class="op">=</span> pd.read_csv(<span class="st">'gd1_data.csv'</span>)</span></code></pre>
</div>
<p>We will compare the first few rows of <code>candidate_df</code> and
<code>read_back_csv</code></p>
<div class="codewrapper sourceCode" id="cb69">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a>candidate_df.head(<span class="dv">3</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>            source_id          ra        dec      pmra      pmdec  \
0  635860218726658176  138.518707  19.092339 -5.941679 -11.346409
1  635674126383965568  138.842874  19.031798 -3.897001 -12.702780
2  635535454774983040  137.837752  18.864007 -4.335041 -14.492309

   best_neighbour_multiplicity  number_of_mates  g_mean_psf_mag  \
0                            1                0         17.8978
1                            1                0         19.2873
2                            1                0         16.9238

   i_mean_psf_mag       phi1      phi2   pm_phi1   pm_phi2
[Output truncated]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb71">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a>read_back_csv.head(<span class="dv">3</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   Unnamed: 0           source_id          ra        dec      pmra      pmdec  \
0           0  635860218726658176  138.518707  19.092339 -5.941679 -11.346409
1           1  635674126383965568  138.842874  19.031798 -3.897001 -12.702780
2           2  635535454774983040  137.837752  18.864007 -4.335041 -14.492309

   best_neighbour_multiplicity  number_of_mates  g_mean_psf_mag  \
0                            1                0         17.8978
1                            1                0         19.2873
2                            1                0         16.9238

   i_mean_psf_mag       phi1      phi2   pm_phi1   pm_phi2
[Output truncated]</code></pre>
</div>
<p>The CSV file contains the names of the columns, but not the data
types. A keen observer may note that the <code>dataframe</code> that we
wrote to the CSV file did not contain data types, so it is unsurprising
that the CSV file also does not. However, even if we had written a CSV
file from an astropy <code>Table</code>, which does contain data type,
data type would not appear in the CSV file, highlighting a limitation of
this format. Additionally, notice that the index in
<code>candidate_df</code> has become an unnamed column in
<code>read_back_csv</code> and a new index has been created. The Pandas
functions for writing and reading CSV files provide options to avoid
that problem, but this is an example of the kind of thing that can go
wrong with CSV files.</p>
</section><section><h2 class="section-heading" id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a></h2>
<hr class="half-width"><p>In this episode, we used database <code>JOIN</code> operations to
select photometry data for the stars we’ve identified as candidates to
be in GD-1.</p>
<p>In the next episode, we will use this data for a second round of
selection, identifying stars that have photometry data consistent with
GD-1.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<span class="callout-header">Key Points</span>
<div class="callout-inner">
<div class="callout-content">
<ul><li>Use <code>JOIN</code> operations to combine data from multiple
tables in a database, using some kind of identifier to match up records
from one table with records from another. This is another example of a
practice we saw in the previous notebook, moving the computation to the
data.</li>
<li>For most applications, saving data in FITS or HDF5 is better than
CSV. FITS and HDF5 are binary formats, so the files are usually smaller,
and they store metadata, so you don’t lose anything when you read the
file back.</li>
<li>On the other hand, CSV is a ‘least common denominator’ format; that
is, it can be read by practically any application that works with
data.</li>
</ul></div>
</div>
</div>
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/05-select.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/07-photo.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/05-select.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Transform and Select
        </a>
        <a class="chapter-link float-end" href="../instructor/07-photo.html" rel="next">
          Next: Photometry...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/datacarpentry/astronomy-python/edit/main/episodes/06-join.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/datacarpentry/astronomy-python/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/datacarpentry/astronomy-python/" class="external-link">Source</a></p>
				<p><a href="https://github.com/datacarpentry/astronomy-python/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.17.1" class="external-link">sandpaper (0.17.1)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.7" class="external-link">varnish (1.0.7)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "LearningResource",
  "@id": "https://datacarpentry.github.io/astronomy-python/instructor/06-join.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/LearningResource/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "Join",
  "creativeWorkStatus": "active",
  "url": "https://datacarpentry.github.io/astronomy-python/instructor/06-join.html",
  "identifier": "https://datacarpentry.github.io/astronomy-python/instructor/06-join.html",
  "dateCreated": "2020-05-11",
  "dateModified": "2025-07-16",
  "datePublished": "2025-09-09"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo --><script>
          var _paq = window._paq = window._paq || [];
          /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
          _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
          _paq.push(["setDomains", ["*.lessons.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
          _paq.push(["setDoNotTrack", true]);
          _paq.push(["disableCookies"]);
          _paq.push(["trackPageView"]);
          _paq.push(["enableLinkTracking"]);
          (function() {
              var u="https://matomo.carpentries.org/";
              _paq.push(["setTrackerUrl", u+"matomo.php"]);
              _paq.push(["setSiteId", "1"]);
              var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0];
              g.async=true; g.src="https://matomo.carpentries.org/matomo.js"; s.parentNode.insertBefore(g,s);
          })();
        </script><!-- End Matomo Code --></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

