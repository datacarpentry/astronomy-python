<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Foundations of Astronomical Data Science: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css">
<script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/dc/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicons/dc/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicons/dc/favicon-16x16.png">
<link rel="manifest" href="../favicons/dc/site.webmanifest">
<link rel="mask-icon" href="../favicons/dc/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="white">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="black">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md top-nav data"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="dc-logo" alt="Data Carpentry" src="../assets/images/data-logo.svg">
</div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
<li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul>
</li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='../aio.html';">Learner View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav data" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Data Carpentry" src="../assets/images/data-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Foundations of Astronomical Data Science
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Foundations of Astronomical Data Science
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<li><a class="dropdown-item" href="calculating_MIST_isochrone.html">Making the Isochrone DataFrame</a></li>
<li><a class="dropdown-item" href="link-list.html">Link List</a></li>
<li><a class="dropdown-item" href="prereqs.html">Prerequisites</a></li>
<hr>
<li><a class="dropdown-item" href="discuss.html">Discussion</a></li>
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul>
</li>
      </ul>
</div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Foundations of Astronomical Data Science
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress data">
    <div class="progress-bar data" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text">
<li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul>
</li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../aio.html">Learner View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->

            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-query.html">1. Basic Queries</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-coords.html">2. Coordinate Transformations</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-transform.html">3. Plotting and Tabular Data</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-motion.html">4. Plotting and Pandas</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-select.html">5. Transform and Select</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-join.html">6. Join</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="07-photo.html">7. Photometry</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="08-plot.html">8. Visualization</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <li><a href="calculating_MIST_isochrone.html">Making the Isochrone DataFrame</a></li>
<li><a href="link-list.html">Link List</a></li>
<li><a href="prereqs.html">Prerequisites</a></li>
<hr>
<li><a class="dropdown-item" href="discuss.html">Discussion</a></li>
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources">
<a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">

            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01-query"><p>Content from <a href="01-query.html">Basic Queries</a></p>
<hr>
<p>Last updated on 2025-09-30 |

        <a href="https://github.com/datacarpentry/astronomy-python/edit/main/episodes/01-query.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 90 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can we select and download the data we want from the Gaia
server?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Compose a basic query in ADQL/SQL.</li>
<li>Use queries to explore a database and its tables.</li>
<li>Use queries to download data.</li>
<li>Develop, test, and debug a query incrementally.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>As a running example, we will replicate parts of the analysis in the
paper, “<a href="https://arxiv.org/abs/1805.00425" class="external-link">Off the beaten path:
Gaia reveals GD-1 stars outside of the main stream</a>” by Adrian
Price-Whelan and Ana Bonaca.</p>
<div id="outline" class="callout checklist">
<div class="callout-square">
<i class="callout-icon" data-feather="check-square"></i>
</div>
<span class="callout-header">Checklist</span>
<div id="outline" class="callout-inner">
<h3 class="callout-title">Outline</h3>
<div class="callout-content">
<p>This episode demonstrates the steps for selecting and downloading
data from the Gaia Database:</p>
<ol style="list-style-type: decimal">
<li><p>First we will make a connection to the Gaia server,</p></li>
<li><p>We will explore information about the database and the tables it
contains,</p></li>
<li><p>We will write a query and send it to the server, and
finally</p></li>
<li><p>We will download the response from the server.</p></li>
</ol>
</div>
</div>
</div>
<section><h2 class="section-heading" id="query-language">Query Language<a class="anchor" aria-label="anchor" href="#query-language"></a>
</h2>
<hr class="half-width">
<p>In order to select data from a database, you need to compose a query,
which is a program written in a “query language”. The query language we
will use is ADQL, which stands for “Astronomical Data Query
Language”.</p>
<p>ADQL is a dialect of <a href="https://en.wikipedia.org/wiki/SQL" class="external-link">SQL</a> (Structured Query
Language), which is by far the most commonly used query language. Almost
everything you will learn about ADQL also works in SQL.</p>
<p><a href="https://www.ivoa.net/documents/ADQL/20180112/PR-ADQL-2.1-20180112.html" class="external-link">The
reference manual for ADQL is here</a>. But you might find it easier to
learn from <a href="https://www.gaia.ac.uk/data/gaia-data-release-1/adql-cookbook" class="external-link">this
ADQL Cookbook</a>.</p>
</section><section><h2 class="section-heading" id="using-jupyter">Using Jupyter<a class="anchor" aria-label="anchor" href="#using-jupyter"></a>
</h2>
<hr class="half-width">
<p>If you have not worked with Jupyter notebooks before, you might start
with <a href="https://jupyter.org/try" class="external-link">the tutorial on from Jupyter.org
called “Try Classic Notebook”</a>, or <a href="https://www.dataquest.io/blog/jupyter-notebook-tutorial/" class="external-link">this
tutorial from DataQuest</a>.</p>
<p>There are two environments you can use to write and run
notebooks:</p>
<ul>
<li><p>“Jupyter Notebook” is the original, and</p></li>
<li><p>“Jupyter Lab” is a newer environment with more features.</p></li>
</ul>
<p>For this lesson, you can use either one.</p>
<p>Here are the most important things to know about running a Jupyter
notebook:</p>
<ol style="list-style-type: decimal">
<li><p>Notebooks are made up of code cells and text cells (and a few
other less common kinds). Code cells contain code; text cells contain
explanatory text written in <a href="https://www.markdownguide.org/" class="external-link">Markdown</a>.</p></li>
<li><p>To run a code cell, click the cell to select it and press
Shift-Enter. The output of the code should appear below the
cell.</p></li>
<li><p>In general, notebooks only run correctly if you run every code
cell in order from top to bottom. If you run cells out of order, you are
likely to get errors.</p></li>
<li><p>You can modify existing cells, but then you have to run them
again to see the effect.</p></li>
<li><p>You can add new cells, but you need to be careful about the order
you run them in.</p></li>
<li><p>If you have added or modified cells, and the behavior of the
notebook seems strange, you can restart the “kernel”, which clears all
of the variables and functions you have defined, and run the cells again
from the beginning.</p></li>
</ol>
<ul>
<li><p>If you are using Jupyter Notebook, open the <code>Kernel</code>
menu and select “Restart and Run All”.</p></li>
<li><p>In Jupyter Lab, open the <code>Kernel</code> menu and select
“Restart Kernel and Run All Cells”.</p></li>
</ul>
<p>Before you continue with this lesson, you might want to explore the
other menus and the toolbar to see what else you can do.</p>
</section><section><h2 class="section-heading" id="connecting-to-gaia">Connecting to Gaia<a class="anchor" aria-label="anchor" href="#connecting-to-gaia"></a>
</h2>
<hr class="half-width">
<p>The library we will use to get Gaia data is <a href="https://astroquery.readthedocs.io/en/latest/" class="external-link">Astroquery</a>.
Astroquery provides <code>Gaia</code>, which is an <a href="https://astroquery.readthedocs.io/en/latest/gaia/gaia.html" class="external-link">object
that represents a connection to the Gaia database</a>.</p>
<p>We can connect to the Gaia database like this:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">from</span> astroquery.gaia <span class="im">import</span> Gaia</span></code></pre>
</div>
<div id="old-versions-of-astroquery-output" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="old-versions-of-astroquery-output" class="callout-inner">
<h3 class="callout-title">Old versions of astroquery output</h3>
<div class="callout-content">
<p>if you are using a version of astroquery that’s older than v0.4.4,
you may see this output</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Created TAP+ (v1.2.1) - Connection:
	Host: gea.esac.esa.int
	Use HTTPS: True
	Port: 443
	SSL Port: 443
Created TAP+ (v1.2.1) - Connection:
	Host: geadata.esac.esa.int
	Use HTTPS: True
	Port: 443
	SSL Port: 443</code></pre>
</div>
</div>
</div>
</div>
<p>This import statement creates a <a href="https://www.ivoa.net/documents/TAP/" class="external-link">TAP+</a> connection; TAP
stands for “Table Access Protocol”, which is a network protocol for
sending queries to the database and getting back the results.</p>
</section><section><h2 class="section-heading" id="databases-and-tables">Databases and Tables<a class="anchor" aria-label="anchor" href="#databases-and-tables"></a>
</h2>
<hr class="half-width">
<p>What is a database? Most generally, it can be any collection of data,
but when we are talking about ADQL or SQL:</p>
<ul>
<li><p>A database is a collection of one or more named tables.</p></li>
<li><p>Each table is a 2-D array with one or more named columns of
data.</p></li>
</ul>
<p>We can use <code>Gaia.load_tables</code> to get the names of the
tables in the Gaia database. With the option
<code>only_names=True</code>, it loads information about the tables,
called “metadata”, but not the data itself.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>tables <span class="op">=</span> Gaia.load_tables(only_names<span class="op">=</span><span class="va">True</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Retrieving tables... [astroquery.utils.tap.core]
INFO: Parsing tables... [astroquery.utils.tap.core]
INFO: Done. [astroquery.utils.tap.core]</code></pre>
</div>
<p>The following <code>for</code> loop prints the names of the
tables.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="cf">for</span> table <span class="kw">in</span> tables:</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    <span class="bu">print</span>(table.name)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>external.apassdr9
external.gaiadr2_geometric_distance
external.gaiaedr3_distance
external.galex_ais
external.ravedr5_com
external.ravedr5_dr5
external.ravedr5_gra
external.ravedr5_on
external.sdssdr13_photoprimary
external.skymapperdr1_master
external.skymapperdr2_master
[Output truncated]</code></pre>
</div>
<p>So that is a lot of tables. The ones we will use are:</p>
<ul>
<li><p><code>gaiadr2.gaia_source</code>, which contains Gaia data from
<a href="https://www.cosmos.esa.int/web/gaia/data-release-2" class="external-link">data
release 2</a>,</p></li>
<li><p><code>gaiadr2.panstarrs1_original_valid</code>, which contains
the photometry data we will use from PanSTARRS, and</p></li>
<li><p><code>gaiadr2.panstarrs1_best_neighbour</code>, which we will use
to cross-match each star observed by Gaia with the same star observed by
PanSTARRS.</p></li>
</ul>
<p>We can use <code>load_table</code> (not <code>load_tables</code>) to
get the metadata for a single table. The name of this function is
misleading, because it only downloads metadata, not the contents of the
table.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>table_metadata <span class="op">=</span> Gaia.load_table(<span class="st">'gaiadr2.gaia_source'</span>)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>table_metadata</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Retrieving table 'gaiadr2.gaia_source'
Parsing table 'gaiadr2.gaia_source'...
Done.

&lt;astroquery.utils.tap.model.taptable.TapTableMeta at 0x7f50edd2aeb0&gt;</code></pre>
</div>
<p>Jupyter shows that the result is an object of type
<code>TapTableMeta</code>, but it does not display the contents.</p>
<p>To see the metadata, we have to print the object.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="bu">print</span>(table_metadata)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>TAP Table name: gaiadr2.gaiadr2.gaia_source
Description: This table has an entry for every Gaia observed source as listed in the
Main Database accumulating catalogue version from which the catalogue
release has been generated. It contains the basic source parameters,
that is only final data (no epoch data) and no spectra (neither final
nor epoch).
Num. columns: 95</code></pre>
</div>
</section><section><h2 class="section-heading" id="columns">Columns<a class="anchor" aria-label="anchor" href="#columns"></a>
</h2>
<hr class="half-width">
<p>The following loop prints the names of the columns in the table.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> table_metadata.columns:</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>    <span class="bu">print</span>(column.name)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>solution_id
designation
source_id
random_index
ref_epoch
ra
ra_error
dec
dec_error
parallax
parallax_error
[Output truncated]</code></pre>
</div>
<p>You can probably infer what many of these columns are by looking at
the names, but you should resist the temptation to guess. To find out
what the columns mean, <a href="https://gea.esac.esa.int/archive/documentation/GDR2/Gaia_archive/chap_datamodel/sec_dm_main_tables/ssec_dm_gaia_source.html" class="external-link">read
the documentation</a>.</p>
<div id="exercise-2-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-2-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (2 minutes)</h3>
<div class="callout-content">
<p>One of the other tables we will use is
<code>gaiadr2.panstarrs1_original_valid</code>. Use
<code>load_table</code> to get the metadata for this table. How many
columns are there and what are their names?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>panstarrs_metadata <span class="op">=</span> Gaia.load_table(<span class="st">'gaiadr2.panstarrs1_original_valid'</span>)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="bu">print</span>(panstarrs_metadata)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Retrieving table 'gaiadr2.panstarrs1_original_valid'
TAP Table name: gaiadr2.gaiadr2.panstarrs1_original_valid
Description: The Panoramic Survey Telescope and Rapid Response System (Pan-STARRS) is
a system for wide-field astronomical imaging developed and operated by
the Institute for Astronomy at the University of Hawaii. Pan-STARRS1

[Output truncated]

Catalogue curator:
SSDC - ASI Space Science Data Center
https://www.ssdc.asi.it/
Num. columns: 26</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> panstarrs_metadata.columns:</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    <span class="bu">print</span>(column.name)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">obj_name</span></span>
<span><span class="va">obj_id</span></span>
<span><span class="va">ra</span></span>
<span><span class="va">dec</span></span>
<span><span class="va">ra_error</span></span>
<span><span class="va">dec_error</span></span>
<span><span class="va">epoch_mean</span></span>
<span><span class="va">g_mean_psf_mag</span></span>
<span><span class="va">g_mean_psf_mag_error</span></span>
<span><span class="va">g_flags</span></span>
<span><span class="va">r_mean_psf_mag</span></span>
<span><span class="va">r_mean_psf_mag_error</span></span>
<span><span class="va">r_flags</span></span>
<span><span class="va">i_mean_psf_mag</span></span>
<span><span class="va">i_mean_psf_mag_error</span></span>
<span><span class="va">i_flags</span></span>
<span><span class="va">z_mean_psf_mag</span></span>
<span><span class="va">z_mean_psf_mag_error</span></span>
<span><span class="va">z_flags</span></span>
<span><span class="va">y_mean_psf_mag</span></span>
<span><span class="va">y_mean_psf_mag_error</span></span>
<span><span class="va">y_flags</span></span>
<span><span class="va">n_detections</span></span>
<span><span class="va">zone_id</span></span>
<span><span class="va">obj_info_flag</span></span>
<span><span class="va">quality_flag</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="writing-queries">Writing queries<a class="anchor" aria-label="anchor" href="#writing-queries"></a>
</h2>
<hr class="half-width">
<p>You might be wondering how we download these tables. With tables this
big, you generally don’t. Instead, you use queries to select only the
data you want.</p>
<p>A query is a program written in a query language like SQL. For the
Gaia database, the query language is a dialect of SQL called ADQL.</p>
<p>Here’s an example of an ADQL query.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>query1 <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="st">TOP 10</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="st">source_id, ra, dec, parallax </span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<div id="triple-quotes-strings" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="triple-quotes-strings" class="callout-inner">
<h3 class="callout-title">Triple-quotes strings</h3>
<div class="callout-content">
<p>We use a <a href="https://docs.python.org/3/tutorial/introduction.html#strings" class="external-link">triple-quoted
string</a> here so we can include line breaks in the query, which makes
it easier to read.</p>
</div>
</div>
</div>
<p>The words in uppercase are ADQL keywords:</p>
<ul>
<li><p><code>SELECT</code> indicates that we are selecting data (as
opposed to adding or modifying data).</p></li>
<li><p><code>TOP</code> indicates that we only want the first 10 rows of
the table, which is useful for testing a query before asking for all of
the data.</p></li>
<li><p><code>FROM</code> specifies which table we want data
from.</p></li>
</ul>
<p>The third line is a list of column names, indicating which columns we
want.</p>
<p>In this example, the keywords are capitalized and the column names
are lowercase. This is a common style, but it is not required. ADQL and
SQL are not case-sensitive.</p>
<p>Also, the query is broken into multiple lines to make it more
readable. This is a common style, but not required. Line breaks don’t
affect the behavior of the query.</p>
<p>To run this query, we use the <code>Gaia</code> object, which
represents our connection to the Gaia database, and invoke
<code>launch_job</code>:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>job1 <span class="op">=</span> Gaia.launch_job(query1)</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>job1</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;astroquery.utils.tap.model.job.Job at 0x7f50edd2adc0&gt;</code></pre>
</div>
<p>The result is an object that represents the job running on a Gaia
server.</p>
<p>If you print it, it displays metadata for the forthcoming
results.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="bu">print</span>(job1)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=10&gt;
   name    dtype  unit                            description                             n_bad
--------- ------- ---- ------------------------------------------------------------------ -----
source_id   int64      Unique source identifier (unique within a particular Data Release)     0
       ra float64  deg                                                    Right ascension     0
      dec float64  deg                                                        Declination     0
 parallax float64  mas                                                           Parallax     2
Jobid: None
Phase: COMPLETED
Owner: None
Output file: sync_20210315090602.xml.gz
[Output truncated]</code></pre>
</div>
<p>Don’t worry about <code>Results: None</code>. That does not actually
mean there are no results.</p>
<p>However, <code>Phase: COMPLETED</code> indicates that the job is
complete, so we can get the results like this:</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>results1 <span class="op">=</span> job1.get_results()</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="bu">type</span>(results1)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">astropy.table.table.Table</span></span></code></pre>
</div>
<p>The <code>type</code> function indicates that the result is an <a href="https://docs.astropy.org/en/stable/table/" class="external-link">Astropy Table</a>.</p>
<div id="repetition" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="repetition" class="callout-inner">
<h3 class="callout-title">Repetition</h3>
<div class="callout-content">
<p>Why is <code>table</code> repeated three times? The first is the name
of the module, the second is the name of the submodule, and the third is
the name of the class. Most of the time we only care about the last one.
It’s like the Linnean name for the Western lowland gorilla, which is
<em>Gorilla gorilla gorilla</em>.</p>
</div>
</div>
</div>
<p>An Astropy <code>Table</code> is similar to a table in an SQL
database except:</p>
<ul>
<li><p>SQL databases are stored on disk drives, so they are persistent;
that is, they “survive” even if you turn off the computer. An Astropy
<code>Table</code> is stored in memory; it disappears when you turn off
the computer (or shut down your Jupyter notebook).</p></li>
<li><p>SQL databases are designed to process queries. An Astropy
<code>Table</code> can perform some query-like operations, like
selecting columns and rows. But these operations use Python syntax, not
SQL.</p></li>
</ul>
<p>Jupyter knows how to display the contents of a
<code>Table</code>.</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>results1</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=10&gt;
     source_id              ra                 dec               parallax
                           deg                 deg                 mas
       int64             float64             float64             float64
------------------- ------------------ ------------------- --------------------
5887983246081387776   227.978818386372  -53.64996962450103   1.0493172163332998
5887971250213117952 228.32280834041364  -53.66270726203726  0.29455652682279093
5887991866047288704  228.1582047014091 -53.454724911639794  -0.5789179941669236
5887968673232040832 228.07420888099884   -53.8064612895961  0.41030970779603076
5887979844465854720 228.42547805195946  -53.48882284470035 -0.23379683441525864
5887978607515442688 228.23831627636855  -53.56328249482688  -0.9252161956789068
[Output truncated]</code></pre>
</div>
<p>Each column has a name, units, and a data type.</p>
<p>For example, the units of <code>ra</code> and <code>dec</code> are
degrees, and their data type is <code>float64</code>, which is a 64-bit
<a href="https://en.wikipedia.org/wiki/Floating-point_arithmetic" class="external-link">floating-point
number</a>, used to store measurements with a fraction part.</p>
<p>This information comes from the Gaia database, and has been stored in
the Astropy <code>Table</code> by Astroquery.</p>
<div id="exercise-3-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-3-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (3 minutes)</h3>
<div class="callout-content">
<p>Read <a href="https://gea.esac.esa.int/archive/documentation/GDR2/Gaia_archive/chap_datamodel/sec_dm_main_tables/ssec_dm_gaia_source.html" class="external-link">the
documentation</a> of this table and choose a column that looks
interesting to you. Add the column name to the query and run it again.
What are the units of the column you selected? What is its data
type?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>For example, we can add radial_velocity : Radial velocity (double,
Velocity[km/s] ) - Spectroscopic radial velocity in the solar
barycentric reference frame. The radial velocity provided is the median
value of the radial velocity measurements at all epochs.</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>query1_with_rv <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="st">TOP 10</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a><span class="st">source_id, ra, dec, parallax, radial_velocity</span></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>job1_with_rv <span class="op">=</span> Gaia.launch_job(query1_with_rv)</span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>results1_with_rv <span class="op">=</span> job1_with_rv.get_results()</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>results1_with_rv</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     source_id              ra         ...       parallax       radial_velocity
                           deg         ...         mas               km / s
------------------- ------------------ ... -------------------- ---------------
5800603716991968256 225.13905251174302 ...   0.5419737483675161              --
5800592790577127552 224.30113911598448 ...  -0.6369101209622813              --
5800601273129497856 225.03260084885449 ...  0.27554460953986526              --
[Output truncated]</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="asynchronous-queries">Asynchronous queries<a class="anchor" aria-label="anchor" href="#asynchronous-queries"></a>
</h2>
<hr class="half-width">
<p><code>launch_job</code> asks the server to run the job
“synchronously”, which normally means it runs immediately. But
synchronous jobs are limited to 2000 rows. For queries that return more
rows, you should run “asynchronously”, which mean they might take longer
to get started.</p>
<p>If you are not sure how many rows a query will return, you can use
the SQL command <code>COUNT</code> to find out how many rows are in the
result without actually returning them. We will see an example in the
next lesson.</p>
<p>The results of an asynchronous query are stored in a file on the
server, so you can start a query and come back later to get the results.
For anonymous users, files are kept for three days.</p>
<p>As an example, let us try a query that is similar to
<code>query1</code>, with these changes:</p>
<ul>
<li><p>It selects the first 3000 rows, so it is bigger than we should
run synchronously.</p></li>
<li><p>It selects two additional columns, <code>pmra</code> and
<code>pmdec</code>, which are proper motions along the axes of
<code>ra</code> and <code>dec</code>.</p></li>
<li><p>It uses a new keyword, <code>WHERE</code>.</p></li>
</ul>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>query2 <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="st">TOP 3000</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="st">source_id, ra, dec, pmra, pmdec, parallax</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="st">WHERE parallax &lt; 1</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>A <code>WHERE</code> clause indicates which rows we want; in this
case, the query selects only rows “where” <code>parallax</code> is less
than 1. This has the effect of selecting stars with relatively low
parallax, which are farther away. We’ll use this clause to exclude
nearby stars that are unlikely to be part of GD-1.</p>
<p><code>WHERE</code> is one of the most common clauses in ADQL/SQL, and
one of the most useful, because it allows us to download only the rows
we need from the database.</p>
<p>We use <code>launch_job_async</code> to submit an asynchronous
query.</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>job2 <span class="op">=</span> Gaia.launch_job_async(query2)</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>job2</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]

&lt;astroquery.utils.tap.model.job.Job at 0x7f50edd40f40&gt;</code></pre>
</div>
<p>And here are the results.</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>results2 <span class="op">=</span> job2.get_results()</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>results2</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=3000&gt;
     source_id              ra         ...       parallax       radial_velocity
                           deg         ...         mas               km / s
       int64             float64       ...       float64            float64
------------------- ------------------ ... -------------------- ---------------
5895270396817359872 213.08433715252883 ...    2.041947005434917              --
5895272561481374080  213.2606587905109 ...  0.15693467895110133              --
5895247410183786368 213.38479712976664 ... -0.19017525742552605              --
5895249226912448000 213.41587389088238 ...                   --              --
5895261875598904576  213.5508930114549 ... -0.29471722363529257              --
5895258302187834624 213.87631129557286 ...   0.6468437015289753              --
[Output truncated]</code></pre>
</div>
<p>You might notice that some values of <code>parallax</code> are
negative. As <a href="https://www.cosmos.esa.int/web/gaia/archive-tips#negative%20parallax" class="external-link">this
FAQ explains</a>, “Negative parallaxes are caused by errors in the
observations.” They have “no physical meaning,” but they can be a
“useful diagnostic on the quality of the astrometric solution.”</p>
<div id="different-results" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="different-results" class="callout-inner">
<h3 class="callout-title">Different results</h3>
<div class="callout-content">
<p>Your results for this query may differ from the Instructor’s. This is
because <code>TOP 3000</code> returns 3000 results, but those results
are not organized in any particular way.</p>
</div>
</div>
</div>
<div id="exercise-5-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>The clauses in a query have to be in the right order. Go back and
change the order of the clauses in <code>query2</code> and run it again.
The modified query should fail, but notice that you don’t get much
useful debugging information.</p>
<p>For this reason, developing and debugging ADQL queries can be really
hard. A few suggestions that might help:</p>
<ul>
<li><p>Whenever possible, start with a working query, either an example
you find online or a query you have used in the past.</p></li>
<li><p>Make small changes and test each change before you
continue.</p></li>
<li><p>While you are debugging, use <code>TOP</code> to limit the number
of rows in the result. That will make each test run faster, which
reduces your development time.</p></li>
<li><p>Launching test queries synchronously might make them start
faster, too.</p></li>
</ul>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<p>In this example, the WHERE clause is in the wrong place.</p>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>query2_erroneous = """SELECT
TOP 3000
source_id, ra, dec, pmra, pmdec, parallax
FROM gaiadr2.gaia_source
WHERE parallax &lt; 1
"""</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="operators">Operators<a class="anchor" aria-label="anchor" href="#operators"></a>
</h2>
<hr class="half-width">
<p>In a <code>WHERE</code> clause, you can use any of the <a href="https://www.w3schools.com/sql/sql_operators.asp" class="external-link">SQL comparison
operators</a>; here are the most common ones:</p>
<table class="table">
<thead><tr class="header">
<th>Symbol</th>
<th align="left">Operation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>&gt;</code></td>
<td align="left">greater than</td>
</tr>
<tr class="even">
<td><code>&lt;</code></td>
<td align="left">less than</td>
</tr>
<tr class="odd">
<td><code>&gt;=</code></td>
<td align="left">greater than or equal</td>
</tr>
<tr class="even">
<td><code>&lt;=</code></td>
<td align="left">less than or equal</td>
</tr>
<tr class="odd">
<td><code>=</code></td>
<td align="left">equal</td>
</tr>
<tr class="even">
<td>
<code>!=</code> or <code>&lt;&gt;</code>
</td>
<td align="left">not equal</td>
</tr>
</tbody>
</table>
<p>Most of these are the same as Python, but some are not. In
particular, notice that the equality operator is <code>=</code>, not
<code>==</code>. Be careful to keep your Python out of your ADQL!</p>
<p>You can combine comparisons using the logical operators:</p>
<ul>
<li>AND: true if both comparisons are true</li>
<li>OR: true if either or both comparisons are true</li>
</ul>
<p>Finally, you can use <code>NOT</code> to invert the result of a
comparison.</p>
<div id="exercise-5-minutes-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes-1" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p><a href="https://www.w3schools.com/sql/sql_operators.asp" class="external-link">Read about
SQL operators here</a> and then modify the previous query to select rows
where <code>bp_rp</code> is between <code>-0.75</code> and
<code>2</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Show me the solution </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<p>Here is a solution using <code>&gt;</code> and <code>&lt;</code>
operators:</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>query2_sol1 <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="st">TOP 10</span></span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a><span class="st">source_id, ref_epoch, ra, dec, parallax</span></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a><span class="st">WHERE parallax &lt; 1 </span></span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a><span class="st">  AND bp_rp &gt; -0.75 AND bp_rp &lt; 2</span></span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>And here is a solution using the <code>BETWEEN</code> operator:</p>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>query2_sol2 <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a><span class="st">TOP 10</span></span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a><span class="st">source_id, ref_epoch, ra, dec, parallax</span></span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a><span class="st">WHERE parallax &lt; 1 </span></span>
<span id="cb35-6"><a href="#cb35-6" tabindex="-1"></a><span class="st">  AND bp_rp BETWEEN -0.75 AND 2</span></span>
<span id="cb35-7"><a href="#cb35-7" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p><code>bp_rp</code> contains BP-RP color, which is the difference
between two other columns, <code>phot_bp_mean_mag</code> and
<code>phot_rp_mean_mag</code>. You can <a href="https://gea.esac.esa.int/archive/documentation/GDR2/Gaia_archive/chap_datamodel/sec_dm_main_tables/ssec_dm_gaia_source.html" class="external-link">read
about this variable here</a>.</p>
<p>This <a href="https://sci.esa.int/web/gaia/-/60198-gaia-hertzsprung-russell-diagram" class="external-link">Hertzsprung-Russell
diagram</a> shows the BP-RP color and luminosity of stars in the Gaia
catalog (Copyright: ESA/Gaia/DPAC, CC BY-SA 3.0 IGO).</p>
<figure><img src="../fig/Gaia-HR-diagram.jpeg" alt="Hertzsprung-Russell diagram of BP-RP color versus luminosity." class="figure mx-auto d-block"></figure><p>Selecting stars with <code>bp-rp</code> less than 2 excludes many <a href="https://xkcd.com/2360/" class="external-link">class M dwarf stars</a>, which are low
temperature, low luminosity. A star like that at GD-1’s distance would
be hard to detect, so if it is detected, it is more likely to be in the
foreground.</p>
</section><section><h2 class="section-heading" id="formatting-queries">Formatting queries<a class="anchor" aria-label="anchor" href="#formatting-queries"></a>
</h2>
<hr class="half-width">
<p>The queries we have written so far are string “literals”, meaning
that the entire string is part of the program. But writing queries
yourself can be slow, repetitive, and error-prone.</p>
<p>It is often better to write Python code that assembles a query for
you. One useful tool for that is the <a href="https://www.w3schools.com/python/ref_string_format.asp" class="external-link">string
<code>format</code> method</a>.</p>
<p>As an example, we will divide the previous query into two parts; a
list of column names and a “base” for the query that contains everything
except the column names.</p>
<p>Here is the list of columns we will select.</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a>columns <span class="op">=</span> <span class="st">'source_id, ra, dec, pmra, pmdec, parallax'</span></span></code></pre>
</div>
<p>And here is the base. It is a string that contains at least one
format specifier in curly brackets (braces).</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a>query3_base <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a><span class="st">TOP 10 </span></span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a><span class="st">WHERE parallax &lt; 1</span></span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a><span class="st">  AND bp_rp BETWEEN -0.75 AND 2</span></span>
<span id="cb37-7"><a href="#cb37-7" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>This base query contains one format specifier,
<code>{columns}</code>, which is a placeholder for the list of column
names we will provide.</p>
<p>To assemble the query, we invoke <code>format</code> on the base
string and provide a keyword argument that assigns a value to
<code>columns</code>.</p>
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>query3 <span class="op">=</span> query3_base.<span class="bu">format</span>(columns<span class="op">=</span>columns)</span></code></pre>
</div>
<p>In this example, the variable that contains the column names and the
variable in the format specifier have the same name. That is not
required, but it is a common style.</p>
<p>The result is a string with line breaks. If you display it, the line
breaks appear as <code>\n</code>.</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>query3</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="st">'SELECT \nTOP 10 \nsource_id, ra, dec, pmra, pmdec, parallax\nFROM gaiadr2.gaia_source\nWHERE parallax &lt; 1\n  AND bp_rp BETWEEN -0.75 AND 2\n'</span></span></code></pre>
</div>
<p>But if you print it, the line breaks appear as line breaks.</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="bu">print</span>(query3)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SELECT
TOP 10
source_id, ra, dec, pmra, pmdec, parallax
FROM gaiadr2.gaia_source
WHERE parallax &lt; 1
  AND bp_rp BETWEEN -0.75 AND 2</code></pre>
</div>
<p>Notice that the format specifier has been replaced with the value of
<code>columns</code>.</p>
<p>Let’s run it and see if it works:</p>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>job3 <span class="op">=</span> Gaia.launch_job(query3)</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a><span class="bu">print</span>(job3)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=10&gt;
   name    dtype    unit                              description
--------- ------- -------- ------------------------------------------------------------------
source_id   int64          Unique source identifier (unique within a particular Data Release)
       ra float64      deg                                                    Right ascension
      dec float64      deg                                                        Declination
     pmra float64 mas / yr                         Proper motion in right ascension direction
    pmdec float64 mas / yr                             Proper motion in declination direction
 parallax float64      mas                                                           Parallax
Jobid: None
Phase: COMPLETED
Owner: None
[Output truncated]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a>results3 <span class="op">=</span> job3.get_results()</span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>results3</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=10&gt;
     source_id              ra         ...       parallax
                           deg         ...         mas
------------------- ------------------ ... -------------------
3031147124474711552 110.10540720349103 ... 0.47255775887968876
3031114276567648256 110.92831846731636 ... 0.41817219481822415
3031130872315906048 110.61072654450903 ...   0.178490206751036
3031128162192428544 110.78664993513391 ...  0.8412331482786942
3031140497346996736  110.0617759777779 ... 0.16993569795437397
3031111910043832576 110.84459425332385 ...  0.4668864606089576
[Output truncated]</code></pre>
</div>
<div id="exercise-10-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-10-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (10 minutes)</h3>
<div class="callout-content">
<p>This query always selects sources with <code>parallax</code> less
than 1. But suppose you want to take that upper bound as an input.</p>
<p>Modify <code>query3_base</code> to replace <code>1</code> with a
format specifier like <code>{max_parallax}</code>. Now, when you call
<code>format</code>, add a keyword argument that assigns a value to
<code>max_parallax</code>, and confirm that the format specifier gets
replaced with the value you provide.</p>
</div>
</div>
</div>
<div id="accordionSolution5" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution5" aria-expanded="false" aria-controls="collapseSolution5">
  <h4 class="accordion-header" id="headingSolution5"> Show me the solution </h4>
</button>
<div id="collapseSolution5" class="accordion-collapse collapse" data-bs-parent="#accordionSolution5" aria-labelledby="headingSolution5">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb47">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a>query_base_sol <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a><span class="st">TOP 10</span></span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb47-5"><a href="#cb47-5" tabindex="-1"></a><span class="st">WHERE parallax &lt; </span><span class="sc">{max_parallax}</span><span class="st"> AND </span></span>
<span id="cb47-6"><a href="#cb47-6" tabindex="-1"></a><span class="st">bp_rp BETWEEN -0.75 AND 2</span></span>
<span id="cb47-7"><a href="#cb47-7" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb47-8"><a href="#cb47-8" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" tabindex="-1"></a>query_sol <span class="op">=</span> query_base_sol.<span class="bu">format</span>(columns<span class="op">=</span>columns,</span>
<span id="cb47-10"><a href="#cb47-10" tabindex="-1"></a>                          max_parallax<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb47-11"><a href="#cb47-11" tabindex="-1"></a><span class="bu">print</span>(query_sol)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<hr class="half-width">
<p>This episode has demonstrated the following steps:</p>
<ol style="list-style-type: decimal">
<li><p>Making a connection to the Gaia server,</p></li>
<li><p>Exploring information about the database and the tables it
contains,</p></li>
<li><p>Writing a query and sending it to the server, and
finally</p></li>
<li><p>Downloading the response from the server as an Astropy
<code>Table</code>.</p></li>
</ol>
<p>In the next episode we will extend these queries to select a
particular region of the sky.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<span class="callout-header">Key Points</span>
<div class="callout-inner">
<div class="callout-content">
<ul>
<li>If you can’t download an entire dataset (or it is not practical) use
queries to select the data you need.</li>
<li>Read the metadata and the documentation to make sure you understand
the tables, their columns, and what they mean.</li>
<li>Develop queries incrementally: start with something simple, test it,
and add a little bit at a time.</li>
<li>Use ADQL features like <code>TOP</code> and <code>COUNT</code> to
test before you run a query that might return a lot of data.</li>
<li>If you know your query will return fewer than 3000 rows, you can run
it synchronously. If it might return more than 3000 rows, you should run
it asynchronously.</li>
<li>ADQL and SQL are not case-sensitive. You don’t have to capitalize
the keywords, but it will make your code more readable.</li>
<li>ADQL and SQL don’t require you to break a query into multiple lines,
but it will make your code more readable.</li>
<li>Make each section of the notebook self-contained. Try not to use the
same variable name in more than one section.</li>
<li>Keep notebooks short. Look for places where you can break your
analysis into phases with one notebook per phase.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-02-coords"><p>Content from <a href="02-coords.html">Coordinate Transformations</a></p>
<hr>
<p>Last updated on 2025-09-30 |

        <a href="https://github.com/datacarpentry/astronomy-python/edit/main/episodes/02-coords.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 95 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do we transform celestial coordinates from one frame to another
and save a subset of the results in files?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Use Python string formatting to compose more complex ADQL
queries.</li>
<li>Work with coordinates and other quantities that have units.</li>
<li>Download the results of a query and store them in a file.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>In the previous episode, we wrote ADQL queries and used them to
select and download data from the Gaia server. In this episode, we will
write a query to select stars from a particular region of the sky.</p>
<div id="outline" class="callout checklist">
<div class="callout-square">
<i class="callout-icon" data-feather="check-square"></i>
</div>
<span class="callout-header">Checklist</span>
<div id="outline" class="callout-inner">
<h3 class="callout-title">Outline</h3>
<div class="callout-content">
<p>We’ll start with an example that does a “cone search”; that is, it
selects stars that appear in a circular region of the sky.</p>
<p>Then, to select stars in the vicinity of GD-1, we will:</p>
<ul>
<li><p>Use <code>Quantity</code> objects to represent measurements with
units.</p></li>
<li><p>Use <a href="https://www.astropy.org" class="external-link">Astropy</a> to convert
coordinates from one frame to another.</p></li>
<li><p>Use the ADQL keywords <code>POLYGON</code>,
<code>CONTAINS</code>, and <code>POINT</code> to select stars that fall
within a polygonal region.</p></li>
<li><p>Submit a query and download the results.</p></li>
<li><p>Store the results in a FITS file.</p></li>
</ul>
</div>
</div>
</div>
<section><h2 class="section-heading" id="working-with-units">Working with Units<a class="anchor" aria-label="anchor" href="#working-with-units"></a>
</h2>
<hr class="half-width">
<p>The measurements we will work with are physical quantities, which
means that they have two parts, a value and a unit. For example, the
coordinate 30<sup>°</sup> has value 30 and its units are degrees.</p>
<p>Until recently, most scientific computation was done with values
only; units were left out of the program altogether, <a href="https://en.wikipedia.org/wiki/Mars_Climate_Orbiter#Cause_of_failure" class="external-link">sometimes
with catastrophic results</a>.</p>
<p>Astropy provides tools for including units explicitly in
computations, which makes it possible to detect errors before they cause
disasters.</p>
<p>To use Astropy units, we import them like this:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> astropy.units <span class="im">as</span> u</span></code></pre>
</div>
<p><code>u</code> is an object that contains most common units and all
SI units.</p>
<p>You can use <code>dir</code> to list them, but you should also <a href="https://docs.astropy.org/en/stable/units/" class="external-link">read the
documentation</a>.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="bu">dir</span>(u)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>['A',
 'AA',
 'AB',
 'ABflux',
 'ABmag',
 'AU',
 'Angstrom',
 'B',
 'Ba',
 'Barye',
 'Bi',
[Output truncated]</code></pre>
</div>
<p>To create a quantity, we multiply a value by a unit:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>angle <span class="op">=</span> <span class="dv">10</span> <span class="op">*</span> u.degree</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="bu">type</span>(angle)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">astropy.units.quantity.Quantity</span></span></code></pre>
</div>
<p>The result is a <code>Quantity</code> object. Jupyter knows how to
display <code>Quantities</code> like this:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>angle</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Quantity 10. deg&gt;</code></pre>
</div>
<p>10<sup>°</sup></p>
<p><code>Quantities</code> provides a method called <code>to</code> that
converts to other units. For example, we can compute the number of
arcminutes in <code>angle</code>:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>angle_arcmin <span class="op">=</span> angle.to(u.arcmin)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>angle_arcmin</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Quantity 600. arcmin&gt;</code></pre>
</div>
<p>600<sup>′</sup></p>
<p>If you add quantities, Astropy converts them to compatible units, if
possible:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>angle <span class="op">+</span> <span class="dv">30</span> <span class="op">*</span> u.arcmin</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Quantity 10.5 deg&gt;</code></pre>
</div>
<p>10.5<sup>°</sup></p>
<p>If the units are not compatible, you get an error. For example:</p>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code><span><span class="va">angle</span> <span class="op">+</span> <span class="fl">5</span> <span class="op">*</span> <span class="va">u.kg</span></span></code></pre>
</div>
<p>causes a <code>UnitConversionError</code>.</p>
<div id="exercise-5-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>Create a quantity that represents 5 <a href="https://en.wikipedia.org/wiki/Minute_and_second_of_arc" class="external-link">arcminutes</a>
and assign it to a variable called <code>radius</code>.</p>
<p>Then convert it to degrees.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>radius <span class="op">=</span> <span class="dv">5</span> <span class="op">*</span> u.arcmin</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="bu">print</span>(radius)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>radius.to(u.degree)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="selecting-a-region">Selecting a Region<a class="anchor" aria-label="anchor" href="#selecting-a-region"></a>
</h2>
<hr class="half-width">
<p>One of the most common ways to restrict a query is to select stars in
a particular region of the sky. For example, here is a query from the <a href="https://gea.esac.esa.int/archive-help/adql/examples/index.html" class="external-link">Gaia
archive documentation</a> that selects objects in a circular region
centered at (88.8, 7.4) with a search radius of 5 arcmin (0.08333
deg).</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>cone_query <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="st">TOP 10 </span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="st">source_id</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="st">WHERE 1=CONTAINS(</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="st">  POINT(ra, dec),</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="st">  CIRCLE(88.8, 7.4, 0.08333333))</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>This query uses three keywords that are specific to ADQL (not
SQL):</p>
<ul>
<li><p><code>POINT</code>: a location in <a href="https://en.wikipedia.org/wiki/International_Celestial_Reference_System" class="external-link">ICRS
coordinates</a>, specified in degrees of right ascension and
declination.</p></li>
<li><p><code>CIRCLE</code>: a circle where the first two values are the
coordinates of the center and the third is the radius in
degrees.</p></li>
<li><p><code>CONTAINS</code>: a function that returns <code>1</code> if
a <code>POINT</code> is contained in a shape and <code>0</code>
otherwise. Here is the <a href="https://www.ivoa.net/documents/ADQL/20180112/PR-ADQL-2.1-20180112.html#tth_sEc4.2.12" class="external-link">documentation
of <code>CONTAINS</code></a>.</p></li>
</ul>
<p>A query like this is called a cone search because it selects stars in
a cone. Here is how we run it:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="im">from</span> astroquery.gaia <span class="im">import</span> Gaia</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>cone_job <span class="op">=</span> Gaia.launch_job(cone_query)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>cone_job</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Created TAP+ (v1.2.1) - Connection:
	Host: gea.esac.esa.int
	Use HTTPS: True
	Port: 443
	SSL Port: 443
Created TAP+ (v1.2.1) - Connection:
	Host: geadata.esac.esa.int
	Use HTTPS: True
	Port: 443
	SSL Port: 443

&lt;astroquery.utils.tap.model.job.Job at 0x7f277785fa30&gt;</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>cone_results <span class="op">=</span> cone_job.get_results()</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>cone_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=10&gt;
     source_id
       int64
-------------------
3322773965056065536
3322773758899157120
3322774068134271104
3322773930696320512
3322774377374425728
3322773724537891456
3322773724537891328
[Output truncated]</code></pre>
</div>
<div id="exercise-5-minutes-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes-1" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>When you are debugging queries like this, you can use
<code>TOP</code> to limit the size of the results, but then you still
don’t know how big the results will be.</p>
<p>An alternative is to use <code>COUNT</code>, which asks for the
number of rows that would be selected, but it does not return them.</p>
<p>In the previous query, replace <code>TOP 10 source_id</code> with
<code>COUNT(source_id)</code> and run the query again. How many stars
has Gaia identified in the cone we searched?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>count_cone_query <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="st">COUNT(source_id)</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="st">WHERE 1=CONTAINS(</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="st">  POINT(ra, dec),</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="st">  CIRCLE(88.8, 7.4, 0.08333333))</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>count_cone_job <span class="op">=</span> Gaia.launch_job(count_cone_query)</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>count_cone_results <span class="op">=</span> count_cone_job.get_results()</span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>count_cone_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=1&gt;
count
int64
-----
594</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="getting-gd-1-data">Getting GD-1 Data<a class="anchor" aria-label="anchor" href="#getting-gd-1-data"></a>
</h2>
<hr class="half-width">
<p>From the Price-Whelan and Bonaca paper, we will try to reproduce <a href="https://www.astroexplorer.org/details/apjlaad7b5f1/eyJrZXlXb3JkcyI6IlByaWNlLVdoZWxhbiIsImF1dGhvciI6IlByaWNlLVdoZWxhbiIsImZyb21ZZWFyIjoyMDE4LCJ0b1llYXIiOjIwMTgsInBhZ2UiOjEsInNob3ciOiIyMDAifQ" class="external-link">Figure
1</a>, which includes this representation of stars likely to belong to
GD-1:</p>
<figure><img src="../fig/gd1-4.png" alt="On-sky positions of likely GD-1 members in the GD-1 coordinate system, where selection by proper motion and photometry reveals the stream in great detail." class="figure mx-auto d-block"></figure><p>The axes of this figure are defined so the x-axis is aligned with the
stars in GD-1, and the y-axis is perpendicular.</p>
<ul>
<li><p>Along the x-axis (φ<sub>1</sub>) the figure extends from -100 to
20 degrees.</p></li>
<li><p>Along the y-axis (φ<sub>2</sub>) the figure extends from about -8
to 4 degrees.</p></li>
</ul>
<p>Ideally, we would select all stars from this rectangle, but there are
more than 10 million of them. This would be difficult to work with, and
as anonymous Gaia users, we are limited to 3 million rows in a single
query. While we are developing and testing code, it will be faster to
work with a smaller dataset.</p>
<p>So we will start by selecting stars in a smaller rectangle near the
center of GD-1, from -55 to -45 degrees φ<sub>1</sub> and -8 to 4
degrees φ<sub>2</sub>. First we will learn how to represent these
coordinates with Astropy.</p>
</section><section><h2 class="section-heading" id="transforming-coordinates">Transforming coordinates<a class="anchor" aria-label="anchor" href="#transforming-coordinates"></a>
</h2>
<hr class="half-width">
<p>Astronomy makes use of many different <a href="https://en.wikipedia.org/wiki/Celestial_coordinate_system" class="external-link">coordinate
systems</a>. Transforming between coordinate systems is a common task in
observational astronomy, and thankfully, Astropy has abstracted the
required spherical trigonometry for us. Below we show the steps to go
from Equatorial coordinates (sky coordinates) to Galactic coordinates
and finally to a reference frame defined to more easily study GD-1.</p>
<p>Astropy provides a <code>SkyCoord</code> object that represents sky
coordinates relative to a specified reference frame.</p>
<p>The following example creates a <code>SkyCoord</code> object that
represents the approximate coordinates of <a href="https://simbad.u-strasbg.fr/simbad/sim-basic?Ident=Betelgeuse" class="external-link">Betelgeuse</a>
(alf Ori) in the ICRS frame.</p>
<p><a href="https://www.iers.org/IERS/EN/Science/ICRS/ICRS.html" class="external-link">ICRS</a> is
the “International Celestial Reference System”, adopted in 1997 by the
International Astronomical Union.</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="im">from</span> astropy.coordinates <span class="im">import</span> SkyCoord</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>ra <span class="op">=</span> <span class="fl">88.8</span> <span class="op">*</span> u.degree</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>dec <span class="op">=</span> <span class="fl">7.4</span> <span class="op">*</span> u.degree</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>coord_icrs <span class="op">=</span> SkyCoord(ra<span class="op">=</span>ra, dec<span class="op">=</span>dec, frame<span class="op">=</span><span class="st">'icrs'</span>)</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>coord_icrs</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;SkyCoord (ICRS): (ra, dec) in deg
    (88.8, 7.4)&gt;</code></pre>
</div>
<p><code>SkyCoord</code> objects require units in order to understand
the context. There are a number of ways to define <code>SkyCoord</code>
objects, in our example, we explicitly specified the coordinates and
units and provided a reference frame.</p>
<p><code>SkyCoord</code> provides the <code>transform_to</code> function
to transform from one reference frame to another reference frame. For
example, we can transform <code>coords_icrs</code> to Galactic
coordinates like this:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>coord_galactic <span class="op">=</span> coord_icrs.transform_to(<span class="st">'galactic'</span>)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>coord_galactic</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;SkyCoord (Galactic): (l, b) in deg
    (199.79693102, -8.95591653)&gt;</code></pre>
</div>
<div id="coordinate-variables" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="coordinate-variables" class="callout-inner">
<h3 class="callout-title">Coordinate Variables</h3>
<div class="callout-content">
<p>Notice that in the Galactic frame, the coordinates are the variables
we usually use for Galactic longitude and latitude called <code>l</code>
and <code>b</code>, respectively, not <code>ra</code> and
<code>dec</code>. Most reference frames have different ways to specify
coordinates and the <code>SkyCoord</code> object will use these
names.</p>
</div>
</div>
</div>
<p>To transform to and from GD-1 coordinates, we will use a frame
defined by <a href="https://gala-astro.readthedocs.io/en/latest/" class="external-link">Gala</a>, which is
an Astropy-affiliated library that provides tools for galactic
dynamics.</p>
<p>Gala provides <a href="https://gala-astro.readthedocs.io/en/latest/_modules/gala/coordinates/gd1.html" class="external-link"><code>GD1Koposov10</code></a>,
which is “a Heliocentric spherical coordinate system defined by the
orbit of the GD-1 stream”. In this coordinate system, one axis is
defined along the direction of the stream (the x-axis in Figure 1) and
one axis is defined perpendicular to the direction of the stream (the
y-axis in Figure 1). These are called the φ<sub>1</sub> and
φ<sub>2</sub> coordinates, respectively.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="im">from</span> gala.coordinates <span class="im">import</span> GD1Koposov10</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>gd1_frame <span class="op">=</span> GD1Koposov10()</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>gd1_frame</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;GD1Koposov10 Frame&gt;</code></pre>
</div>
<p>We can use it to find the coordinates of Betelgeuse in the GD-1
frame, like this:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>coord_gd1 <span class="op">=</span> coord_icrs.transform_to(gd1_frame)</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>coord_gd1</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;SkyCoord (GD1Koposov10): (phi1, phi2) in deg
    (-94.97222038, 34.5813813)&gt;</code></pre>
</div>
<div id="exercise-10-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-10-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (10 minutes)</h3>
<div class="callout-content">
<p>Find the location of GD-1 in ICRS coordinates.</p>
<ol style="list-style-type: decimal">
<li><p>Create a <code>SkyCoord</code> object at 0°, 0° in the GD-1
frame.</p></li>
<li><p>Transform it to the ICRS frame.</p></li>
</ol>
<p>Hint: Because ICRS is a standard frame, it is built into Astropy. You
can specify it by name, <code>icrs</code> (as we did with
<code>galactic</code>).</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>origin_gd1 <span class="op">=</span> SkyCoord(<span class="dv">0</span><span class="op">*</span>u.degree, <span class="dv">0</span><span class="op">*</span>u.degree, frame<span class="op">=</span>gd1_frame)</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>origin_gd1.transform_to(<span class="st">'icrs'</span>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Notice that the origin of the GD-1 frame maps to <code>ra=200</code>,
exactly, in ICRS. That is by design.</p>
</section><section><h2 class="section-heading" id="selecting-a-rectangle">Selecting a rectangle<a class="anchor" aria-label="anchor" href="#selecting-a-rectangle"></a>
</h2>
<hr class="half-width">
<p>Now that we know how to define coordinate transformations, we are
going to use them to get a list of stars that are in GD-1. As we
mentioned before, this is a lot of stars, so we are going to start by
defining a rectangle that encompasses a small part of GD-1. This is
easiest to define in GD-1 coordinates.</p>
<p>The following variables define the boundaries of the rectangle in
φ<sub>1</sub> and φ<sub>2</sub>.</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>phi1_min <span class="op">=</span> <span class="op">-</span><span class="dv">55</span> <span class="op">*</span> u.degree </span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>phi1_max <span class="op">=</span> <span class="op">-</span><span class="dv">45</span> <span class="op">*</span> u.degree</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>phi2_min <span class="op">=</span> <span class="op">-</span><span class="dv">8</span> <span class="op">*</span> u.degree</span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>phi2_max <span class="op">=</span> <span class="dv">4</span> <span class="op">*</span> u.degree</span></code></pre>
</div>
<p>Throughout this lesson we are going to be defining a rectangle often.
Rather than copy and paste multiple lines of code, we will write a
function to build the rectangle for us. By having the code contained in
a single location, we can easily fix bugs or update our implementation
as needed. By choosing an explicit function name our code is also self
documenting, meaning its easy for us to understand that we are building
a rectangle when we call this function.</p>
<p>To create a rectangle, we will use the following function, which
takes the lower and upper bounds as parameters and returns a list of x
and y coordinates of the corners of a rectangle starting with the lower
left corner and working clockwise.</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="kw">def</span> make_rectangle(x1, x2, y1, y2):</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>    <span class="co">"""Return the corners of a rectangle."""</span></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>    xs <span class="op">=</span> [x1, x1, x2, x2, x1]</span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a>    ys <span class="op">=</span> [y1, y2, y2, y1, y1]</span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a>    <span class="cf">return</span> xs, ys</span></code></pre>
</div>
<p>The return value is a tuple containing a list of coordinates in
φ<sub>1</sub> followed by a list of coordinates in φ<sub>2</sub>.</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>phi1_rect, phi2_rect <span class="op">=</span> make_rectangle(</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>    phi1_min, phi1_max, phi2_min, phi2_max)</span></code></pre>
</div>
<p><code>phi1_rect</code> and <code>phi2_rect</code> contains the
coordinates of the corners of a rectangle in the GD-1 frame.</p>
<p>While it is easier to visualize the regions we want to define in the
GD-1 frame, the coordinates in the Gaia catalog are in the ICRS frame.
In order to use the rectangle we defined, we need to convert the
coordinates from the GD-1 frame to the ICRS frame. We will do this using
the SkyCoord object. Fortunately SkyCoord objects can take lists of
coordinates, in addition to single values.</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>corners <span class="op">=</span> SkyCoord(phi1<span class="op">=</span>phi1_rect, phi2<span class="op">=</span>phi2_rect, frame<span class="op">=</span>gd1_frame)</span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>corners</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;SkyCoord (GD1Koposov10): (phi1, phi2) in deg
    [(-55., -8.), (-55.,  4.), (-45.,  4.), (-45., -8.), (-55., -8.)]&gt;</code></pre>
</div>
<p>Now we can use <code>transform_to</code> to convert to ICRS
coordinates.</p>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>corners_icrs <span class="op">=</span> corners.transform_to(<span class="st">'icrs'</span>)</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>corners_icrs</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;SkyCoord (ICRS): (ra, dec) in deg
    [(146.27533314, 19.26190982), (135.42163944, 25.87738723),
     (141.60264825, 34.3048303 ), (152.81671045, 27.13611254),
     (146.27533314, 19.26190982)]&gt;</code></pre>
</div>
<p>Notice that a rectangle in one coordinate system is not necessarily a
rectangle in another. In this example, the result is a (non-rectangular)
polygon. This is why we defined our rectangle in the GD-1 frame.</p>
</section><section><h2 class="section-heading" id="defining-a-polygon">Defining a polygon<a class="anchor" aria-label="anchor" href="#defining-a-polygon"></a>
</h2>
<hr class="half-width">
<p>In order to use this polygon as part of an ADQL query, we have to
convert it to a string with a comma-separated list of coordinates, as in
this example:</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a><span class="co">POLYGON(143.65, 20.98, </span></span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a><span class="co">        134.46, 26.39, </span></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a><span class="co">        140.58, 34.85, </span></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a><span class="co">        150.16, 29.01)</span></span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a><span class="co">"""</span></span></code></pre>
</div>
<p><code>SkyCoord</code> provides <code>to_string</code>, which produces
a list of strings.</p>
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>corners_list_str <span class="op">=</span> corners_icrs.to_string()</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a>corners_list_str</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>['146.275 19.2619',
 '135.422 25.8774',
 '141.603 34.3048',
 '152.817 27.1361',
 '146.275 19.2619']</code></pre>
</div>
<p>We can use the Python string function <code>join</code> to join
<code>corners_list_str</code> into a single string (with spaces between
the pairs):</p>
<div class="codewrapper sourceCode" id="cb40">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a>corners_single_str <span class="op">=</span> <span class="st">' '</span>.join(corners_list_str)</span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a>corners_single_str</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="st">'146.275 19.2619 135.422 25.8774 141.603 34.3048 152.817 27.1361 146.275 19.2619'</span></span></code></pre>
</div>
<p>This is almost what we need, but we have to replace the spaces with
commas.</p>
<div class="codewrapper sourceCode" id="cb42">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a>corners_single_str.replace(<span class="st">' '</span>, <span class="st">', '</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="st">'146.275, 19.2619, 135.422, 25.8774, 141.603, 34.3048, 152.817, 27.1361, 146.275, 19.2619'</span></span></code></pre>
</div>
<p>This is something we will need to do multiple times. We will write a
function to do it for us so we don’t have to copy and paste every time.
The following function combines these steps.</p>
<div class="codewrapper sourceCode" id="cb44">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="kw">def</span> skycoord_to_string(skycoord):</span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a>    <span class="co">"""Convert a one-dimensional list of SkyCoord to string for Gaia's query format."""</span></span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a>    corners_list_str <span class="op">=</span> skycoord.to_string()</span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a>    corners_single_str <span class="op">=</span> <span class="st">' '</span>.join(corners_list_str)</span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a>    <span class="cf">return</span> corners_single_str.replace(<span class="st">' '</span>, <span class="st">', '</span>)</span></code></pre>
</div>
<p>Here is how we use this function:</p>
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a>sky_point_list <span class="op">=</span> skycoord_to_string(corners_icrs)</span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>sky_point_list</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="st">'146.275, 19.2619, 135.422, 25.8774, 141.603, 34.3048, 152.817, 27.1361, 146.275, 19.2619'</span></span></code></pre>
</div>
</section><section><h2 class="section-heading" id="assembling-the-query">Assembling the query<a class="anchor" aria-label="anchor" href="#assembling-the-query"></a>
</h2>
<hr class="half-width">
<p>Now we are ready to assemble our query to get all of the stars in the
Gaia catalog that are in the small rectangle we defined and are likely
to be part of GD-1 with the criteria we previously defined.</p>
<p>We need <code>columns</code> again (as we saw in the previous
episode).</p>
<div class="codewrapper sourceCode" id="cb47">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a>columns <span class="op">=</span> <span class="st">'source_id, ra, dec, pmra, pmdec, parallax'</span></span></code></pre>
</div>
<p>And here is the query base we used in the previous lesson:</p>
<div class="codewrapper sourceCode" id="cb48">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a>query3_base <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a><span class="st">TOP 10 </span></span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb48-5"><a href="#cb48-5" tabindex="-1"></a><span class="st">WHERE parallax &lt; 1</span></span>
<span id="cb48-6"><a href="#cb48-6" tabindex="-1"></a><span class="st">  AND bp_rp BETWEEN -0.75 AND 2</span></span>
<span id="cb48-7"><a href="#cb48-7" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>Now we will add a <code>WHERE</code> clause to select stars in the
polygon we defined and start using more descriptive variables for our
queries.</p>
<div class="codewrapper sourceCode" id="cb49">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a>polygon_top10query_base <span class="op">=</span> <span class="st">"""SELECT</span></span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a><span class="st">TOP 10</span></span>
<span id="cb49-3"><a href="#cb49-3" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb49-4"><a href="#cb49-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb49-5"><a href="#cb49-5" tabindex="-1"></a><span class="st">WHERE parallax &lt; 1</span></span>
<span id="cb49-6"><a href="#cb49-6" tabindex="-1"></a><span class="st">  AND bp_rp BETWEEN -0.75 AND 2 </span></span>
<span id="cb49-7"><a href="#cb49-7" tabindex="-1"></a><span class="st">  AND 1 = CONTAINS(POINT(ra, dec), </span></span>
<span id="cb49-8"><a href="#cb49-8" tabindex="-1"></a><span class="st">                   POLYGON(</span><span class="sc">{sky_point_list}</span><span class="st">))</span></span>
<span id="cb49-9"><a href="#cb49-9" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>The query base contains format specifiers for <code>columns</code>
and <code>sky_point_list</code>.</p>
<p>We will use <code>format</code> to fill in these values.</p>
<div class="codewrapper sourceCode" id="cb50">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a>polygon_top10query <span class="op">=</span> polygon_top10query_base.<span class="bu">format</span>(columns<span class="op">=</span>columns, </span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a>                          sky_point_list<span class="op">=</span>sky_point_list)</span>
<span id="cb50-3"><a href="#cb50-3" tabindex="-1"></a><span class="bu">print</span>(polygon_top10query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SELECT
TOP 10
source_id, ra, dec, pmra, pmdec, parallax
FROM gaiadr2.gaia_source
WHERE parallax &lt; 1
  AND bp_rp BETWEEN -0.75 AND 2
  AND 1 = CONTAINS(POINT(ra, dec),
                   POLYGON(146.275, 19.2619, 135.422, 25.8774, 141.603, 34.3048, 152.817, 27.1361, 146.275, 19.2619))

</code></pre>
</div>
<p>As always, we should take a minute to proof-read the query before we
launch it.</p>
<div class="codewrapper sourceCode" id="cb52">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a>polygon_top10query_job <span class="op">=</span> Gaia.launch_job_async(polygon_top10query)</span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a><span class="bu">print</span>(polygon_top10query_job)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]
&lt;Table length=10&gt;
   name    dtype    unit                              description
--------- ------- -------- ------------------------------------------------------------------
source_id   int64          Unique source identifier (unique within a particular Data Release)
       ra float64      deg                                                    Right ascension
      dec float64      deg                                                        Declination
     pmra float64 mas / yr                         Proper motion in right ascension direction
    pmdec float64 mas / yr                             Proper motion in declination direction
 parallax float64      mas                                                           Parallax
Jobid: 1615815873808O
Phase: COMPLETED
[Output truncated]</code></pre>
</div>
<p>Here are the results.</p>
<div class="codewrapper sourceCode" id="cb54">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a>polygon_top10query_results <span class="op">=</span> polygon_top10query_job.get_results()</span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a>polygon_top10query_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=10&gt;
    source_id              ra         ...       parallax
                          deg         ...         mas
------------------ ------------------ ... --------------------
637987125186749568 142.48301935991023 ...  -0.2573448962333354
638285195917112960 142.25452941346344 ...   0.4227283465319491
638073505568978688 142.64528557468074 ...  0.10363972229362585
638086386175786752 142.57739430926034 ...  -0.8573270355079308
638049655615392384 142.58913564478618 ...    0.099624729200593
638267565075964032 141.81762228999614 ... -0.07271215219283075
[Output truncated]</code></pre>
</div>
<p>Finally, we can remove <code>TOP 10</code> and run the query
again.</p>
<p>The result is bigger than our previous queries, so it will take a
little longer.</p>
<div class="codewrapper sourceCode" id="cb56">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a>polygon_query_base <span class="op">=</span> <span class="st">"""SELECT</span></span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a><span class="st">WHERE parallax &lt; 1</span></span>
<span id="cb56-5"><a href="#cb56-5" tabindex="-1"></a><span class="st">  AND bp_rp BETWEEN -0.75 AND 2 </span></span>
<span id="cb56-6"><a href="#cb56-6" tabindex="-1"></a><span class="st">  AND 1 = CONTAINS(POINT(ra, dec), </span></span>
<span id="cb56-7"><a href="#cb56-7" tabindex="-1"></a><span class="st">                   POLYGON(</span><span class="sc">{sky_point_list}</span><span class="st">))</span></span>
<span id="cb56-8"><a href="#cb56-8" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb57">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a>polygon_query <span class="op">=</span> polygon_query_base.<span class="bu">format</span>(columns<span class="op">=</span>columns, </span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a>                          sky_point_list<span class="op">=</span>sky_point_list)</span>
<span id="cb57-3"><a href="#cb57-3" tabindex="-1"></a><span class="bu">print</span>(polygon_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SELECT
source_id, ra, dec, pmra, pmdec, parallax
FROM gaiadr2.gaia_source
WHERE parallax &lt; 1
  AND bp_rp BETWEEN -0.75 AND 2
  AND 1 = CONTAINS(POINT(ra, dec),
                   POLYGON(146.275, 19.2619, 135.422, 25.8774, 141.603, 34.3048, 152.817, 27.1361, 146.275, 19.2619))</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb59">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a>polygon_job <span class="op">=</span> Gaia.launch_job_async(polygon_query)</span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a><span class="bu">print</span>(polygon_job)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]
&lt;Table length=140339&gt;
   name    dtype    unit                              description
--------- ------- -------- ------------------------------------------------------------------
source_id   int64          Unique source identifier (unique within a particular Data Release)
       ra float64      deg                                                    Right ascension
      dec float64      deg                                                        Declination
     pmra float64 mas / yr                         Proper motion in right ascension direction
    pmdec float64 mas / yr                             Proper motion in declination direction
 parallax float64      mas                                                           Parallax
Jobid: 1615815886707O
Phase: COMPLETED
[Output truncated]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb61">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a>polygon_results <span class="op">=</span> polygon_job.get_results()</span>
<span id="cb61-2"><a href="#cb61-2" tabindex="-1"></a><span class="bu">len</span>(polygon_results)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">140339</span></span></code></pre>
</div>
<p>There are more than 100,000 stars in this polygon, but that’s a
manageable size to work with.</p>
</section><section><h2 class="section-heading" id="saving-results">Saving results<a class="anchor" aria-label="anchor" href="#saving-results"></a>
</h2>
<hr class="half-width">
<p>This is the set of stars we will work with in the next step. Since we
have a substantial dataset now, this is a good time to save it.</p>
<p>Storing the data in a file means we can shut down our notebook and
pick up where we left off without running the previous query again.</p>
<p>Astropy <code>Table</code> objects provide <code>write</code>, which
writes the table to disk.</p>
<div class="codewrapper sourceCode" id="cb63">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_results.fits'</span></span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a>polygon_results.write(filename, overwrite<span class="op">=</span><span class="va">True</span>)</span></code></pre>
</div>
<p>Because the filename ends with <code>fits</code>, the table is
written in the <a href="https://en.wikipedia.org/wiki/FITS" class="external-link">FITS
format</a>, which preserves the metadata associated with the table.</p>
<p>If the file already exists, the <code>overwrite</code> argument
causes it to be overwritten.</p>
<p>We can use <code>getsize</code> to confirm that the file exists and
check the size:</p>
<div class="codewrapper sourceCode" id="cb64">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" tabindex="-1"></a><span class="im">from</span> os.path <span class="im">import</span> getsize</span>
<span id="cb64-2"><a href="#cb64-2" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" tabindex="-1"></a>MB <span class="op">=</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span></span>
<span id="cb64-4"><a href="#cb64-4" tabindex="-1"></a>getsize(filename) <span class="op">/</span> MB</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">6.4324951171875</span></span></code></pre>
</div>
</section><section><h2 class="section-heading" id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<hr class="half-width">
<p>In this notebook, we composed more complex queries to select stars
within a polygonal region of the sky. Then we downloaded the results and
saved them in a FITS file.</p>
<p>In the next notebook, we’ll reload the data from this file and
replicate the next step in the analysis, using proper motion to identify
stars likely to be in GD-1.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<span class="callout-header">Key Points</span>
<div class="callout-inner">
<div class="callout-content">
<ul>
<li>For measurements with units, use <code>Quantity</code> objects that
represent units explicitly and check for errors.</li>
<li>Use the <code>format</code> function to compose queries; it is often
faster and less error-prone.</li>
<li>Develop queries incrementally: start with something simple, test it,
and add a little bit at a time.</li>
<li>Once you have a query working, save the data in a local file. If you
shut down the notebook and come back to it later, you can reload the
file; you don’t have to run the query again.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-03-transform"><p>Content from <a href="03-transform.html">Plotting and Tabular Data</a></p>
<hr>
<p>Last updated on 2025-09-30 |

        <a href="https://github.com/datacarpentry/astronomy-python/edit/main/episodes/03-transform.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 55 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do we make scatter plots in Matplotlib?</li>
<li>How do we store data in a Pandas <code>DataFrame</code>?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Select rows and columns from an Astropy <code>Table</code>.</li>
<li>Use Matplotlib to make a scatter plot.</li>
<li>Use Gala to transform coordinates.</li>
<li>Make a Pandas <code>DataFrame</code> and use a Boolean
<code>Series</code> to select rows.</li>
<li>Save a <code>DataFrame</code> in an HDF5 file.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>In the previous episode, we wrote a query to select stars from the
region of the sky where we expect GD-1 to be, and saved the results in a
FITS file.</p>
<p>Now we will read that data back in and implement the next step in the
analysis, identifying stars with the proper motion we expect for
GD-1.</p>
<div id="outline" class="callout checklist">
<div class="callout-square">
<i class="callout-icon" data-feather="check-square"></i>
</div>
<span class="callout-header">Checklist</span>
<div id="outline" class="callout-inner">
<h3 class="callout-title">Outline</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li><p>We will read back the results from the previous lesson, which we
saved in a FITS file.</p></li>
<li><p>Then we will transform the coordinates and proper motion data
from ICRS back to the coordinate frame of GD-1.</p></li>
<li><p>We will put those results into a Pandas
<code>DataFrame</code>.</p></li>
</ol>
</div>
</div>
</div>
<div id="starting-from-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<span class="callout-header">Prerequisite</span>
<div id="starting-from-this-episode" class="callout-inner">
<h3 class="callout-title">Starting from this episode</h3>
<div class="callout-content">
<p>If you are starting a new notebook for this episode, expand this
section for information you will need to get started.</p>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> Read me </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler1" aria-labelledby="headingSpoiler1">
<div class="accordion-body">
<p>In the previous episode, we ran a query on the Gaia server,
downloaded data for roughly 140,000 stars, and saved the data in a FITS
file. We will use that data for this episode. Whether you are working
from a new notebook or coming back from a checkpoint, reloading the data
will save you from having to run the query again.</p>
<p>If you are starting this episode here or starting this episode in a
new notebook, you will need to run the following lines of code.</p>
<p>This imports previously imported functions:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> astropy.units <span class="im">as</span> u</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">from</span> astropy.coordinates <span class="im">import</span> SkyCoord</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">from</span> gala.coordinates <span class="im">import</span> GD1Koposov10</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">from</span> astropy.table <span class="im">import</span> Table</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="im">from</span> episode_functions <span class="im">import</span> <span class="op">*</span></span></code></pre>
</div>
<p>The following code loads in the data (instructions for downloading
data can be found in the <a href="index.html#setup">setup instructions</a>).
You may need to add a the path to the filename variable below
(e.g. <code>filename = 'student_download/backup-data/gd1_results.fits'</code>)</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_results.fits'</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>polygon_results <span class="op">=</span> Table.read(filename)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>gd1_frame <span class="op">=</span> GD1Koposov10()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="selecting-rows-and-columns">Selecting rows and columns<a class="anchor" aria-label="anchor" href="#selecting-rows-and-columns"></a>
</h2>
<hr class="half-width">
<p>In the previous episode, we selected spatial and proper motion
information from the Gaia catalog for stars around a small part of GD-1.
The output was returned as an Astropy <code>Table</code>. We can use
<code>info</code> to check the contents.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>polygon_results.info()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=140339&gt;
   name    dtype    unit                              description
--------- ------- -------- ------------------------------------------------------------------
source_id   int64          Unique source identifier (unique within a particular Data Release)
       ra float64      deg                                                    Right ascension
      dec float64      deg                                                        Declination
     pmra float64 mas / yr                         Proper motion in right ascension direction
    pmdec float64 mas / yr                             Proper motion in declination direction
 parallax float64      mas                                                           Parallax</code></pre>
</div>
<p>In this episode, we will see operations for selecting columns and
rows from an Astropy <code>Table</code>. You can find more information
about these operations in the <a href="https://docs.astropy.org/en/stable/table/access_table.html" class="external-link">Astropy
documentation</a>.</p>
<p>We can get the names of the columns like this:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>polygon_results.colnames</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>['source_id', 'ra', 'dec', 'pmra', 'pmdec', 'parallax']</code></pre>
</div>
<p>And select an individual column like this:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>polygon_results[<span class="st">'ra'</span>]</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Column name='ra' dtype='float64' unit='deg' description='Right ascension' length=140339&gt;
142.48301935991023
142.25452941346344
142.64528557468074
142.57739430926034
142.58913564478618
141.81762228999614
143.18339801317677
 142.9347319464589
142.26769745823267
142.89551292869012
[Output truncated]</code></pre>
</div>
<p>The result is a <code>Column</code> object that contains the data,
and also the data type, units, and name of the column.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="bu">type</span>(polygon_results[<span class="st">'ra'</span>])</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">astropy.table.column.Column</span></span></code></pre>
</div>
<p>The rows in the <code>Table</code> are numbered from 0 to
<code>n-1</code>, where <code>n</code> is the number of rows. We can
select the first row like this:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>polygon_results[<span class="dv">0</span>]</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Row index=0&gt;
    source_id              ra                dec                pmra              pmdec             parallax
                          deg                deg              mas / yr           mas / yr             mas
      int64             float64            float64            float64            float64            float64
------------------ ------------------ ----------------- ------------------- ----------------- -------------------
637987125186749568 142.48301935991023 21.75771616932985 -2.5168384683875766 2.941813096629439 -0.2573448962333354</code></pre>
</div>
<p>The result is a <code>Row</code> object.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="bu">type</span>(polygon_results[<span class="dv">0</span>])</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">astropy.table.row.Row</span></span></code></pre>
</div>
<p>Notice that the bracket operator can be used to select both columns
and rows. You might wonder how it knows which to select. If the
expression in brackets is a string, it selects a column; if the
expression is an integer, it selects a row.</p>
<p>If you apply the bracket operator twice, you can select a column and
then an element from the column.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>polygon_results[<span class="st">'ra'</span>][<span class="dv">0</span>]</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">142.48301935991023</span></span></code></pre>
</div>
<p>Or you can select a row and then an element from the row.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>polygon_results[<span class="dv">0</span>][<span class="st">'ra'</span>]</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">142.48301935991023</span></span></code></pre>
</div>
<p>You get the same result either way.</p>
</section><section><h2 class="section-heading" id="scatter-plot">Scatter plot<a class="anchor" aria-label="anchor" href="#scatter-plot"></a>
</h2>
<hr class="half-width">
<p>To see what the results look like, we will use a scatter plot. The
library we will use is <a href="https://matplotlib.org/" class="external-link">Matplotlib</a>,
which is the most widely-used plotting library for Python. The
Matplotlib interface is based on MATLAB (hence the name), so if you know
MATLAB, some of it will be familiar.</p>
<p>We will import like this:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre>
</div>
<p>Pyplot is part of the Matplotlib library. It is conventional to
import it using the shortened name <code>plt</code>.</p>
<div id="keeping-plots-in-the-notebook" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="keeping-plots-in-the-notebook" class="callout-inner">
<h3 class="callout-title">Keeping plots in the notebook</h3>
<div class="callout-content">
<p>In recent versions of Jupyter, plots appear “inline”; that is, they
are part of the notebook. In some older versions, plots appear in a new
window. If your plots appear in a new window, you might want to run the
following Jupyter <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-matplotlib" class="external-link">magic
command</a> in a notebook cell:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span></code></pre>
</div>
</div>
</div>
</div>
<p>Pyplot provides two functions that can make scatter plots, <a href="https://matplotlib.org/3.3.0/api/_as_gen/matplotlib.pyplot.scatter.html" class="external-link">plt.scatter</a>
and <a href="https://matplotlib.org/api/_as_gen/matplotlib.pyplot.plot.html" class="external-link">plt.plot</a>.</p>
<ul>
<li><p><code>scatter</code> is more versatile; for example, you can make
every point in a scatter plot a different color.</p></li>
<li><p><code>plot</code> is more limited, but for simple cases, it can
be substantially faster.</p></li>
</ul>
<p>Jake Vanderplas explains these differences in <a href="https://jakevdp.github.io/PythonDataScienceHandbook/04.02-simple-scatter-plots.html" class="external-link">The
Python Data Science Handbook</a>.</p>
<p>Since we are plotting more than 100,000 points and they are all the
same size and color, we will use <code>plot</code>.</p>
<p>Here is a scatter plot of the stars we selected in the GD-1 region
with right ascension on the x-axis and declination on the y-axis, both
ICRS coordinates in degrees.</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>x <span class="op">=</span> polygon_results[<span class="st">'ra'</span>]</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>y <span class="op">=</span> polygon_results[<span class="st">'dec'</span>]</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>plt.plot(x, y, <span class="st">'ko'</span>)</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>plt.xlabel(<span class="st">'ra (degree ICRS)'</span>)</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>plt.ylabel(<span class="st">'dec (degree ICRS)'</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/03-transform_files/03-transform_28_0.png" alt="Scatter plot of right ascension and declination in ICRS coordinates, demonstrating overplotting." class="figure mx-auto d-block"></figure><p>The arguments to <code>plt.plot</code> are <code>x</code>,
<code>y</code>, and a string that specifies the style. In this case, the
letters <code>ko</code> indicate that we want a black, round marker
(<code>k</code> is for black because <code>b</code> is for blue). The
functions <code>xlabel</code> and <code>ylabel</code> put labels on the
axes.</p>
<p>Looking at this plot, we can see that the region we selected, which
is a rectangle in GD-1 coordinates, is a non-rectangular region in ICRS
coordinates.</p>
<p>However, this scatter plot has a problem. It is “<a href="https://python-graph-gallery.com/134-how-to-avoid-overplotting-with-python/" class="external-link">overplotted</a>”,
which means that there are so many overlapping points, we cannot
distinguish between high and low density areas.</p>
<p>To fix this, we can provide optional arguments to control the size
and transparency of the points.</p>
<div id="exercise-5-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>In the call to <code>plt.plot</code>, use the keyword argument
<code>markersize</code> to make the markers smaller.</p>
<p>Then add the keyword argument <code>alpha</code> to make the markers
partly transparent.</p>
<p>Adjust these arguments until you think the figure shows the data most
clearly.</p>
<p>Note: Once you have made these changes, you might notice that the
figure shows stripes with lower density of stars. These stripes are
caused by the way Gaia scans the sky, which <a href="https://www.cosmos.esa.int/web/gaia/scanning-law" class="external-link">you can read
about here</a>. The dataset we are using, <a href="https://www.cosmos.esa.int/web/gaia/dr2" class="external-link">Gaia Data Release 2</a>,
covers 22 months of observations; during this time, some parts of the
sky were scanned more than others.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>x <span class="op">=</span> polygon_results[<span class="st">'ra'</span>]</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>y <span class="op">=</span> polygon_results[<span class="st">'dec'</span>]</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.1</span>, alpha<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>plt.xlabel(<span class="st">'ra (degree ICRS)'</span>)</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>plt.ylabel(<span class="st">'dec (degree ICRS)'</span>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="transform-back">Transform back<a class="anchor" aria-label="anchor" href="#transform-back"></a>
</h2>
<hr class="half-width">
<p>Remember that we selected data from a rectangle of coordinates in the
GD-1 frame, then transformed them to ICRS when we constructed the query.
The coordinates in the query results are in ICRS.</p>
<p>To plot them, we will transform them back to the GD-1 frame; that
way, the axes of the figure are aligned with the orbit of GD-1, which is
useful for two reasons:</p>
<ul>
<li><p>By transforming the coordinates, we can identify stars that are
likely to be in GD-1 by selecting stars near the centerline of the
stream, where φ<sub>2</sub> is close to 0.</p></li>
<li><p>By transforming the proper motions, we can identify stars with
non-zero proper motion along the φ<sub>1</sub> axis, which are likely to
be part of GD-1.</p></li>
</ul>
<p>To do the transformation, we will put the results into a
<code>SkyCoord</code> object. In a previous episode, we created a
<code>SkyCoord</code> object like this:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>skycoord <span class="op">=</span> SkyCoord(ra<span class="op">=</span>polygon_results[<span class="st">'ra'</span>], dec<span class="op">=</span>polygon_results[<span class="st">'dec'</span>])</span></code></pre>
</div>
<p>Notice that we did not specify the reference frame. That is because
when using <code>ra</code> and <code>dec</code> in
<code>SkyCoord</code>, the <code>ICRS</code> frame is assumed by
default.</p>
<p>The <code>SkyCoord</code> object can keep track not just of location,
but also proper motions. This means that we can initialize a
<code>SkyCoord</code> object with location and proper motions, then use
all of these quantities together to transform into the GD-1 frame.</p>
<p>Now we are going to do something similar, but now we will take
advantage of the <code>SkyCoord</code> object’s capacity to include and
track space motion information in addition to <code>ra</code> and
<code>dec</code>. We will now also include:</p>
<ul>
<li><p><code>pmra</code> and <code>pmdec</code>, which are proper motion
in the <code>ICRS</code> frame, and</p></li>
<li><p><code>distance</code> and <code>radial_velocity</code>, which are
important for the reflex correction and will be discussed in that
section.</p></li>
</ul>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>distance <span class="op">=</span> <span class="dv">8</span> <span class="op">*</span> u.kpc</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>radial_velocity<span class="op">=</span> <span class="dv">0</span> <span class="op">*</span> u.km<span class="op">/</span>u.s</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>skycoord <span class="op">=</span> SkyCoord(ra<span class="op">=</span>polygon_results[<span class="st">'ra'</span>], </span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>                    dec<span class="op">=</span>polygon_results[<span class="st">'dec'</span>],</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>                    pm_ra_cosdec<span class="op">=</span>polygon_results[<span class="st">'pmra'</span>],</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>                    pm_dec<span class="op">=</span>polygon_results[<span class="st">'pmdec'</span>], </span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a>                    distance<span class="op">=</span>distance, </span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>                    radial_velocity<span class="op">=</span>radial_velocity)</span></code></pre>
</div>
<p>For the first four arguments, we use columns from
<code>polygon_results</code>.</p>
<p>For <code>distance</code> and <code>radial_velocity</code> we use
constants, which we explain in the section on reflex correction.</p>
<p>The result is an Astropy <code>SkyCoord</code> object, which we can
transform to the GD-1 frame.</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>transformed <span class="op">=</span> skycoord.transform_to(gd1_frame)</span></code></pre>
</div>
<p>The result is another <code>SkyCoord</code> object, now in the GD-1
frame.</p>
</section><section><h2 class="section-heading" id="reflex-correction">Reflex Correction<a class="anchor" aria-label="anchor" href="#reflex-correction"></a>
</h2>
<hr class="half-width">
<p>The next step is to correct the proper motion measurements for the
effect of the motion of our solar system around the Galactic center.</p>
<p>When we created <code>skycoord</code>, we provided constant values
for <code>distance</code> and <code>radial_velocity</code> rather than
measurements from Gaia.</p>
<p>That might seem like a strange thing to do, but here is the
motivation:</p>
<ul>
<li><p>Because the stars in GD-1 are so far away, parallaxes measured by
Gaia are negligible, making the distance estimates unreliable.<br>
So we replace them with our current best estimate of the mean distance
to GD-1, about 8 kpc. See <a href="https://ui.adsabs.harvard.edu/abs/2010ApJ...712..260K/abstract" class="external-link">Koposov,
Rix, and Hogg, 2010</a>.</p></li>
<li><p>For the other stars in the table, this distance estimate will be
inaccurate, so reflex correction will not be correct. But that should
have only a small effect on our ability to identify stars with the
proper motion we expect for GD-1.</p></li>
<li><p>The measurement of radial velocity has no effect on the
correction for proper motion, but we have to provide a value to avoid
errors in the reflex correction calculation. So we provide
<code>0</code> as an arbitrary place-keeper.</p></li>
</ul>
<p>With this preparation, we can use <code>reflex_correct</code> from
Gala (<a href="https://gala-astro.readthedocs.io/en/latest/api/gala.coordinates.reflex_correct.html" class="external-link">documentation
here</a>) to correct for the motion of the solar system.</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="im">from</span> gala.coordinates <span class="im">import</span> reflex_correct</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a>skycoord_gd1 <span class="op">=</span> reflex_correct(transformed)</span></code></pre>
</div>
<p>The result is a <code>SkyCoord</code> object that contains</p>
<ul>
<li><p><code>phi1</code> and <code>phi2</code>, which represent the
transformed coordinates in the GD-1 frame.</p></li>
<li><p><code>pm_phi1_cosphi2</code> and <code>pm_phi2</code>, which
represent the transformed proper motions that have been corrected for
the motion of the solar system around the Galactic center.</p></li>
</ul>
<p>We can select the coordinates and plot them like this:</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>x <span class="op">=</span> skycoord_gd1.phi1</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>y <span class="op">=</span> skycoord_gd1.phi2</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.1</span>, alpha<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>plt.xlabel(<span class="st">'phi1 (degree GD1)'</span>)</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>plt.ylabel(<span class="st">'phi2 (degree GD1)'</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/03-transform_files/03-transform_43_0.png" alt="Scatter plot of phi1 versus phi2 in GD-1 coordinates, showing selected region is rectangular." class="figure mx-auto d-block"></figure><p>We started with a rectangle in the GD-1 frame. When transformed to
the ICRS frame, it is a non-rectangular region. Now, transformed back to
the GD-1 frame, it is a rectangle again.</p>
</section><section><h2 class="section-heading" id="pandas-dataframe">Pandas DataFrame<a class="anchor" aria-label="anchor" href="#pandas-dataframe"></a>
</h2>
<hr class="half-width">
<p>At this point we have two objects containing different sets of the
data relating to identifying stars in GD-1. <code>polygon_results</code>
is the Astropy <code>Table</code> we downloaded from Gaia.</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="bu">type</span>(polygon_results)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">astropy.table.table.Table</span></span></code></pre>
</div>
<p>And <code>skycoord_gd1</code> is a <code>SkyCoord</code> object that
contains the transformed coordinates and proper motions.</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="bu">type</span>(skycoord_gd1)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">astropy.coordinates.sky_coordinate.SkyCoord</span></span></code></pre>
</div>
<p>On one hand, this division of labor makes sense because each object
provides different capabilities. But working with multiple object types
can be awkward. It will be more convenient to choose one object and get
all of the data into it.</p>
<p>Now we can extract the columns we want from <code>skycoord_gd1</code>
and add them as columns in the Astropy <code>Table</code>
<code>polygon_results</code>. <code>phi1</code> and <code>phi2</code>
contain the transformed coordinates.</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>polygon_results[<span class="st">'phi1'</span>] <span class="op">=</span> skycoord_gd1.phi1</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>polygon_results[<span class="st">'phi2'</span>] <span class="op">=</span> skycoord_gd1.phi2</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a>polygon_results.info()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=140339&gt;
   name    dtype    unit                              description                                class
--------- ------- -------- ------------------------------------------------------------------ ------------
source_id   int64          Unique source identifier (unique within a particular Data Release) MaskedColumn
       ra float64      deg                                                    Right ascension MaskedColumn
      dec float64      deg                                                        Declination MaskedColumn
     pmra float64 mas / yr                         Proper motion in right ascension direction MaskedColumn
    pmdec float64 mas / yr                             Proper motion in declination direction MaskedColumn
 parallax float64      mas                                                           Parallax MaskedColumn
     phi1 float64      deg                                                                          Column
     phi2 float64      deg                                                                          Column</code></pre>
</div>
<p><code>pm_phi1_cosphi2</code> and <code>pm_phi2</code> contain the
components of proper motion in the transformed frame.</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a>polygon_results[<span class="st">'pm_phi1'</span>] <span class="op">=</span> skycoord_gd1.pm_phi1_cosphi2</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>polygon_results[<span class="st">'pm_phi2'</span>] <span class="op">=</span> skycoord_gd1.pm_phi2</span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a>polygon_results.info()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=140339&gt;
   name    dtype    unit                              description                                class
--------- ------- -------- ------------------------------------------------------------------ ------------
source_id   int64          Unique source identifier (unique within a particular Data Release) MaskedColumn
       ra float64      deg                                                    Right ascension MaskedColumn
      dec float64      deg                                                        Declination MaskedColumn
     pmra float64 mas / yr                         Proper motion in right ascension direction MaskedColumn
    pmdec float64 mas / yr                             Proper motion in declination direction MaskedColumn
 parallax float64      mas                                                           Parallax MaskedColumn
     phi1 float64      deg                                                                          Column
     phi2 float64      deg                                                                          Column
  pm_phi1 float64 mas / yr                                                                          Column
  pm_phi2 float64 mas / yr                                                                          Column</code></pre>
</div>
<div id="callout2" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div class="callout-inner">
<div class="callout-content">
<p>Detail If you notice that <code>SkyCoord</code> has an attribute
called <code>proper_motion</code>, you might wonder why we are not using
it.</p>
<p>We could have: <code>proper_motion</code> contains the same data as
<code>pm_phi1_cosphi2</code> and <code>pm_phi2</code>, but in a
different format.</p>
</div>
</div>
</div>
<div id="pandas-dataframes-versus-astropy-tables" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="pandas-dataframes-versus-astropy-tables" class="callout-inner">
<h3 class="callout-title">Pandas <code>DataFrame</code>s versus Astropy
<code>Table</code>s</h3>
<div class="callout-content">
<p>Two common choices are the Pandas <code>DataFrame</code> and Astropy
<code>Table</code>. Pandas <code>DataFrame</code>s and Astropy
<code>Table</code>s share many of the same characteristics and most of
the manipulations that we do can be done with either. As you become more
familiar with each, you will develop a sense of which one you prefer for
different tasks. For instance you may choose to use Astropy
<code>Table</code>s to read in data, especially astronomy specific data
formats, but Pandas <code>DataFrame</code>s to inspect the data.
Fortunately, Astropy makes it easy to convert between the two data
types. We will choose to use Pandas <code>DataFrame</code>, for two
reasons:</p>
<ol style="list-style-type: decimal">
<li><p>It provides capabilities that are (almost) a superset of the
other data structures, so it is the all-in-one solution.</p></li>
<li><p>Pandas is a general-purpose tool that is useful in many domains,
especially data science. If you are going to develop expertise in one
tool, Pandas is a good choice.</p></li>
</ol>
<p>However, compared to an Astropy <code>Table</code>, Pandas has one
big drawback: it does not keep the metadata associated with the table,
including the units for the columns. Nevertheless, we think its a useful
data type to be familiar with.</p>
</div>
</div>
</div>
<p>It is straightforward to convert an Astropy <code>Table</code> to a
Pandas <code>DataFrame</code>.</p>
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a>results_df <span class="op">=</span> polygon_results.to_pandas()</span></code></pre>
</div>
<p><code>DataFrame</code> provides <code>shape</code>, which shows the
number of rows and columns.</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>results_df.shape</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>(140339, 10)</code></pre>
</div>
<p>It also provides <code>head</code>, which displays the first few
rows. <code>head</code> is useful for spot-checking large results as you
go along.</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>results_df.head()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>            source_id          ra        dec       pmra       pmdec   parallax        phi1       phi2    pm_phi1     pm_phi2
0  637987125186749568  142.483019  21.757716  -2.516838    2.941813  -0.257345  -54.975623  -3.659349   6.429945    6.518157
1  638285195917112960  142.254529  22.476168   2.662702  -12.165984   0.422728  -54.498247  -3.081524  -3.168637   -6.206795
2  638073505568978688  142.645286  22.166932  18.306747   -7.950660   0.103640  -54.551634  -3.554229   9.129447  -16.819570
3  638086386175786752  142.577394  22.227920   0.987786   -2.584105  -0.857327  -54.536457  -3.467966   3.837120    0.526461
4  638049655615392384  142.589136  22.110783   0.244439   -4.941079   0.099625  -54.627448  -3.542738   1.466103   -0.185292
</code></pre>
</div>
<div id="attributes-vs-functions" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="attributes-vs-functions" class="callout-inner">
<h3 class="callout-title">Attributes vs functions</h3>
<div class="callout-content">
<p><code>shape</code> is an attribute, so we display its value without
calling it as a function.</p>
<p><code>head</code> is a function, so we need the parentheses.</p>
</div>
</div>
</div>
<p>Before we go any further, we will take all of the steps that we have
done and consolidate them into a single function that we can use to take
the coordinates and proper motion that we get as an Astropy
<code>Table</code> from our Gaia query, add columns representing the
reflex corrected GD-1 coordinates and proper motions, and transform it
into a Pandas <code>DataFrame</code>. This is a general function that we
will use multiple times as we build different queries so we want to
write it once and then call the function rather than having to copy and
paste the code over and over again.</p>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="kw">def</span> make_dataframe(table):</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a>    <span class="co">"""Transform coordinates from ICRS to GD-1 frame.</span></span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a><span class="co">    table: Astropy Table</span></span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb43-6"><a href="#cb43-6" tabindex="-1"></a><span class="co">    returns: Pandas DataFrame</span></span>
<span id="cb43-7"><a href="#cb43-7" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb43-8"><a href="#cb43-8" tabindex="-1"></a>    <span class="co">#Create a SkyCoord object with the coordinates and proper motions</span></span>
<span id="cb43-9"><a href="#cb43-9" tabindex="-1"></a>    <span class="co"># in the input table</span></span>
<span id="cb43-10"><a href="#cb43-10" tabindex="-1"></a>    skycoord <span class="op">=</span> SkyCoord(</span>
<span id="cb43-11"><a href="#cb43-11" tabindex="-1"></a>               ra<span class="op">=</span>table[<span class="st">'ra'</span>], </span>
<span id="cb43-12"><a href="#cb43-12" tabindex="-1"></a>               dec<span class="op">=</span>table[<span class="st">'dec'</span>],</span>
<span id="cb43-13"><a href="#cb43-13" tabindex="-1"></a>               pm_ra_cosdec<span class="op">=</span>table[<span class="st">'pmra'</span>],</span>
<span id="cb43-14"><a href="#cb43-14" tabindex="-1"></a>               pm_dec<span class="op">=</span>table[<span class="st">'pmdec'</span>], </span>
<span id="cb43-15"><a href="#cb43-15" tabindex="-1"></a>               distance<span class="op">=</span><span class="dv">8</span><span class="op">*</span>u.kpc, </span>
<span id="cb43-16"><a href="#cb43-16" tabindex="-1"></a>               radial_velocity<span class="op">=</span><span class="dv">0</span><span class="op">*</span>u.km<span class="op">/</span>u.s)</span>
<span id="cb43-17"><a href="#cb43-17" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" tabindex="-1"></a>    <span class="co"># Define the GD-1 reference frame</span></span>
<span id="cb43-19"><a href="#cb43-19" tabindex="-1"></a>    gd1_frame <span class="op">=</span> GD1Koposov10()</span>
<span id="cb43-20"><a href="#cb43-20" tabindex="-1"></a></span>
<span id="cb43-21"><a href="#cb43-21" tabindex="-1"></a>    <span class="co"># Transform input coordinates to the GD-1 reference frame</span></span>
<span id="cb43-22"><a href="#cb43-22" tabindex="-1"></a>    transformed <span class="op">=</span> skycoord.transform_to(gd1_frame)</span>
<span id="cb43-23"><a href="#cb43-23" tabindex="-1"></a></span>
<span id="cb43-24"><a href="#cb43-24" tabindex="-1"></a>    <span class="co"># Correct GD-1 coordinates for solar system motion around galactic center</span></span>
<span id="cb43-25"><a href="#cb43-25" tabindex="-1"></a>    skycoord_gd1 <span class="op">=</span> reflex_correct(transformed)</span>
<span id="cb43-26"><a href="#cb43-26" tabindex="-1"></a></span>
<span id="cb43-27"><a href="#cb43-27" tabindex="-1"></a>    <span class="co">#Add GD-1 reference frame columns for coordinates and proper motions</span></span>
<span id="cb43-28"><a href="#cb43-28" tabindex="-1"></a>    table[<span class="st">'phi1'</span>] <span class="op">=</span> skycoord_gd1.phi1</span>
<span id="cb43-29"><a href="#cb43-29" tabindex="-1"></a>    table[<span class="st">'phi2'</span>] <span class="op">=</span> skycoord_gd1.phi2</span>
<span id="cb43-30"><a href="#cb43-30" tabindex="-1"></a>    table[<span class="st">'pm_phi1'</span>] <span class="op">=</span> skycoord_gd1.pm_phi1_cosphi2</span>
<span id="cb43-31"><a href="#cb43-31" tabindex="-1"></a>    table[<span class="st">'pm_phi2'</span>] <span class="op">=</span> skycoord_gd1.pm_phi2</span>
<span id="cb43-32"><a href="#cb43-32" tabindex="-1"></a></span>
<span id="cb43-33"><a href="#cb43-33" tabindex="-1"></a>    <span class="co"># Create DataFrame</span></span>
<span id="cb43-34"><a href="#cb43-34" tabindex="-1"></a>    df <span class="op">=</span> table.to_pandas()</span>
<span id="cb43-35"><a href="#cb43-35" tabindex="-1"></a></span>
<span id="cb43-36"><a href="#cb43-36" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre>
</div>
<p>Here is how we use the function:</p>
<div class="codewrapper sourceCode" id="cb44">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a>results_df <span class="op">=</span> make_dataframe(polygon_results)</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="saving-the-dataframe">Saving the DataFrame<a class="anchor" aria-label="anchor" href="#saving-the-dataframe"></a>
</h2>
<hr class="half-width">
<p>At this point we have run a successful query and combined the results
into a single <code>DataFrame</code>. This is a good time to save the
data.</p>
<p>To save a Pandas <code>DataFrame</code>, one option is to convert it
to an Astropy <code>Table</code>, like this:</p>
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="im">from</span> astropy.table <span class="im">import</span> Table</span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a>results_table <span class="op">=</span> Table.from_pandas(results_df)</span>
<span id="cb45-4"><a href="#cb45-4" tabindex="-1"></a><span class="bu">type</span>(results_table)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">astropy.table.table.Table</span></span></code></pre>
</div>
<p>Then we could write the <code>Table</code> to a FITS file, as we did
in the previous lesson.</p>
<p>But, like Astropy, Pandas provides functions to write DataFrames in
other formats; to see what they are <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html" class="external-link">find
the functions here that begin with <code>to_</code></a>.</p>
<p>One of the best options is HDF5, which is Version 5 of <a href="https://en.wikipedia.org/wiki/Hierarchical_Data_Format" class="external-link">Hierarchical
Data Format</a>.</p>
<p>HDF5 is a binary format, so files are small and fast to read and
write (like FITS, but unlike XML).</p>
<p>An HDF5 file is similar to an SQL database in the sense that it can
contain more than one table, although in HDF5 vocabulary, a table is
called a Dataset. (<a href="https://www.stsci.edu/itt/review/dhb_2011/Intro/intro_ch23.html" class="external-link">Multi-extension
FITS files</a> can also contain more than one table.)</p>
<p>And HDF5 stores the metadata associated with the table, including
column names, row labels, and data types (like FITS).</p>
<p>Finally, HDF5 is a cross-language standard, so if you write an HDF5
file with Pandas, you can read it back with many other software tools
(more than FITS).</p>
<p>We can write a Pandas <code>DataFrame</code> to an HDF5 file like
this:</p>
<div class="codewrapper sourceCode" id="cb47">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_data.hdf'</span></span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a>results_df.to_hdf(filename, <span class="st">'results_df'</span>, mode<span class="op">=</span><span class="st">'w'</span>)</span></code></pre>
</div>
<p>Because an HDF5 file can contain more than one Dataset, we have to
provide a name, or “key”, that identifies the Dataset in the file.</p>
<p>We could use any string as the key, but it is generally a good
practice to use a descriptive name (just like your
<code>DataFrame</code> variable name) so we will give the Dataset in the
file the same name (key) as the <code>DataFrame</code>.</p>
<p>By default, writing a <code>DataFrame</code> appends a new dataset to
an existing HDF5 file. We will use the argument <code>mode='w'</code> to
overwrite the file if it already exists rather than append another
dataset to it.</p>
</section><section><h2 class="section-heading" id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<hr class="half-width">
<p>In this episode, we re-loaded the Gaia data we saved from a previous
query.</p>
<p>We transformed the coordinates and proper motion from ICRS to a frame
aligned with the orbit of GD-1, stored the results in a Pandas
<code>DataFrame</code>, and visualized them.</p>
<p>We combined all of these steps into a single function that we can
reuse in the future to go straight from the output of a query with
object coordinates in the ICRS reference frame directly to a Pandas
DataFrame that includes object coordinates in the GD-1 reference
frame.</p>
<p>We saved our results to an HDF5 file which we can use to restart the
analysis from this stage or verify our results at some future time.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<span class="callout-header">Key Points</span>
<div class="callout-inner">
<div class="callout-content">
<ul>
<li>When you make a scatter plot, adjust the size of the markers and
their transparency so the figure is not overplotted; otherwise it can
misrepresent the data badly.</li>
<li>For simple scatter plots in Matplotlib, <code>plot</code> is faster
than <code>scatter</code>.</li>
<li>An Astropy <code>Table</code> and a Pandas <code>DataFrame</code>
are similar in many ways and they provide many of the same functions.
They have pros and cons, but for many projects, either one would be a
reasonable choice.</li>
<li>To store data from a Pandas <code>DataFrame</code>, a good option is
an HDF5 file, which can contain multiple Datasets (we’ll dig in more in
the Join lesson).</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-04-motion"><p>Content from <a href="04-motion.html">Plotting and Pandas</a></p>
<hr>
<p>Last updated on 2024-03-08 |

        <a href="https://github.com/datacarpentry/astronomy-python/edit/main/episodes/04-motion.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 65 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do efficiently explore our data and identify appropriate filters
to produce a clean sample (in this case of GD-1 stars)?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Use a Boolean Pandas <code>Series</code> to select rows in a
<code>DataFrame</code>.</li>
<li>Save multiple <code>DataFrame</code>s in an HDF5 file.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>In the previous episode, we wrote a query to select stars from the
region of the sky where we expect GD-1 to be, and saved the results in a
FITS and HDF5 file.</p>
<p>Now we will read that data back in and implement the next step in the
analysis, identifying stars with the proper motion we expect for
GD-1.</p>
<div id="outline" class="callout checklist">
<div class="callout-square">
<i class="callout-icon" data-feather="check-square"></i>
</div>
<span class="callout-header">Checklist</span>
<div id="outline" class="callout-inner">
<h3 class="callout-title">Outline</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li><p>We will put those results into a Pandas <code>DataFrame</code>,
which we will use to select stars near the centerline of GD-1.</p></li>
<li><p>Plotting the proper motion of those stars, we will identify a
region of proper motion for stars that are likely to be in
GD-1.</p></li>
<li><p>Finally, we will select and plot the stars whose proper motion is
in that region.</p></li>
</ol>
</div>
</div>
</div>
<div id="starting-from-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<span class="callout-header">Prerequisite</span>
<div id="starting-from-this-episode" class="callout-inner">
<h3 class="callout-title">Starting from this episode</h3>
<div class="callout-content">
<p>If you are starting a new notebook for this episode, expand this
section for information you will need to get started.</p>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> Read me </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler1" aria-labelledby="headingSpoiler1">
<div class="accordion-body">
<p>Previously, we ran a query on the Gaia server, downloaded data for
roughly 140,000 stars, transformed the coordinates to the GD-1 reference
frame, and saved the results in an HDF5 file (Dataset name
<code>results_df</code>). We will use that data for this episode.
Whether you are working from a new notebook or coming back from a
checkpoint, reloading the data will save you from having to run the
query again.</p>
<p>If you are starting this episode here or starting this episode in a
new notebook, you will need to run the following lines of code.</p>
<p>This imports previously imported functions:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> astropy.units <span class="im">as</span> u</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="im">from</span> episode_functions <span class="im">import</span> <span class="op">*</span></span></code></pre>
</div>
<p>The following code loads in the data (instructions for downloading
data can be found in the <a href="index.html#setup">setup instructions</a>).
You may need to add a the path to the filename variable below
(e.g. <code>filename = 'student_download/backup-data/gd1_data.hdf'</code>)</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_data.hdf'</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>results_df <span class="op">=</span> pd.read_hdf(filename, <span class="st">'results_df'</span>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="exploring-data">Exploring data<a class="anchor" aria-label="anchor" href="#exploring-data"></a>
</h2>
<hr class="half-width">
<p>One benefit of using Pandas is that it provides functions for
exploring the data and checking for problems. One of the most useful of
these functions is <code>describe</code>, which computes summary
statistics for each column.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>results_df.describe()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>          source_id             ra            dec           pmra  \
count  1.403390e+05  140339.000000  140339.000000  140339.000000
mean   6.792399e+17     143.823122      26.780285      -2.484404
std    3.792177e+16       3.697850       3.052592       5.913939
min    6.214900e+17     135.425699      19.286617    -106.755260
25%    6.443517e+17     140.967966      24.592490      -5.038789
50%    6.888060e+17     143.734409      26.746261      -1.834943
75%    6.976579e+17     146.607350      28.990500       0.452893
max    7.974418e+17     152.777393      34.285481     104.319923

               pmdec       parallax           phi1           phi2  \
[Output truncated]</code></pre>
</div>
<div id="exercise-10-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-10-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (10 minutes)</h3>
<div class="callout-content">
<p>Review the summary statistics in this table.</p>
<ul>
<li><p>Do the values make sense based on what you know about the
context?</p></li>
<li><p>Do you see any values that seem problematic, or evidence of other
data issues?</p></li>
</ul>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>The most noticeable issue is that some of the parallax values are
negative, which seems non-physical.</p>
<p>Negative parallaxes in the Gaia database can arise from a number of
causes like source confusion (high negative values) and the parallax
zero point with systematic errors (low negative values).</p>
<p>Fortunately, we do not use the parallax measurements in the analysis
(one of the reasons we used constant distance for reflex
correction).</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="plot-proper-motion">Plot proper motion<a class="anchor" aria-label="anchor" href="#plot-proper-motion"></a>
</h2>
<hr class="half-width">
<p>Now we are ready to replicate one of the panels in Figure 1 of the
Price-Whelan and Bonaca paper, the one that shows components of proper
motion as a scatter plot:</p>
<figure><img width="300" src="../fig/gd1-1.png" alt="Scatter of proper motion phi1 versus phi2 showing overdensity in negative proper motions of GD-1 stars." class="figure mx-auto d-block"></figure><p>In this figure, the shaded area identifies stars that are likely to
be in GD-1 because:</p>
<ul>
<li><p>Due to the nature of tidal streams, we expect the proper motion
for stars in GD-1 to be along the axis of the stream; that is, we expect
motion in the direction of <code>phi2</code> to be near 0.</p></li>
<li><p>In the direction of <code>phi1</code>, we do not have a prior
expectation for proper motion, except that it should form a cluster at a
non-zero value.</p></li>
</ul>
<p>By plotting proper motion in the GD-1 frame, we hope to find this
cluster. Then we will use the bounds of the cluster to select stars that
are more likely to be in GD-1.</p>
<p>The following figure is a scatter plot of proper motion, in the GD-1
frame, for the stars in <code>results_df</code>.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>x <span class="op">=</span> results_df[<span class="st">'pm_phi1'</span>]</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>y <span class="op">=</span> results_df[<span class="st">'pm_phi2'</span>]</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.1</span>, alpha<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    </span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>plt.xlabel(<span class="st">'Proper motion phi1 (mas/yr GD1 frame)'</span>)</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>plt.ylabel(<span class="st">'Proper motion phi2 (mas/yr GD1 frame)'</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/04-motion_files/04-motion_67_0.png" alt="Scatter plot of proper motion in GD-1 frame of selected stars showing most are near the origin." class="figure mx-auto d-block"></figure><p>Most of the proper motions are near the origin, but there are a few
extreme values. Following the example in the paper, we will use
<code>xlim</code> and <code>ylim</code> to zoom in on the region near
the origin.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>x <span class="op">=</span> results_df[<span class="st">'pm_phi1'</span>]</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>y <span class="op">=</span> results_df[<span class="st">'pm_phi2'</span>]</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.1</span>, alpha<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    </span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>plt.xlabel(<span class="st">'Proper motion phi1 (mas/yr GD1 frame)'</span>)</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>plt.ylabel(<span class="st">'Proper motion phi2 (mas/yr GD1 frame)'</span>)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>plt.xlim(<span class="op">-</span><span class="dv">12</span>, <span class="dv">8</span>)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>plt.ylim(<span class="op">-</span><span class="dv">10</span>, <span class="dv">10</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/04-motion_files/04-motion_69_0.png" alt="Zoomed in view of previous scatter plot showing overdense region." class="figure mx-auto d-block"></figure><p>There is a hint of an overdense region near (-7.5, 0), but if you did
not know where to look, you would miss it.</p>
<p>To see the cluster more clearly, we need a sample that contains a
higher proportion of stars in GD-1. We will do that by selecting stars
close to the centerline.</p>
</section><section><h2 class="section-heading" id="selecting-the-centerline">Selecting the centerline<a class="anchor" aria-label="anchor" href="#selecting-the-centerline"></a>
</h2>
<hr class="half-width">
<p>As we can see in the following figure, many stars in GD-1 are less
than 1 degree from the line <code>phi2=0</code>.</p>
<figure><img src="../fig/gd1-4.png" alt="Scatter plot with selection on proper motion and photometry showing many stars in GD-1 are within 1 degree of phi2 = 0." class="figure mx-auto d-block"></figure><p>Stars near this line have the highest probability of being in
GD-1.</p>
<p>To select them, we will use a “Boolean mask”. We will start by
selecting the <code>phi2</code> column from the
<code>DataFrame</code>:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>phi2 <span class="op">=</span> results_df[<span class="st">'phi2'</span>]</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="bu">type</span>(phi2)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">pandas.core.series.Series</span></span></code></pre>
</div>
<p>The result is a <code>Series</code>, which is the structure Pandas
uses to represent columns.</p>
<p>We can use a comparison operator, <code>&gt;</code>, to compare the
values in a <code>Series</code> to a constant.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>phi2_min <span class="op">=</span> <span class="op">-</span><span class="fl">1.0</span> <span class="op">*</span> u.degree</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>phi2_max <span class="op">=</span> <span class="fl">1.0</span> <span class="op">*</span> u.degree</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>mask <span class="op">=</span> (phi2 <span class="op">&gt;</span> phi2_min)</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="bu">type</span>(mask)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">pandas.core.series.Series</span></span></code></pre>
</div>
<p>The result is a <code>Series</code> of Boolean values, that is,
<code>True</code> and <code>False</code>.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>mask.head()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>0    False
1    False
2    False
3    False
4    False
Name: phi2, dtype: bool</code></pre>
</div>
<p>To select values that fall between <code>phi2_min</code> and
<code>phi2_max</code>, we will use the <code>&amp;</code> operator,
which computes “logical AND”. The result is true where elements from
both Boolean <code>Series</code> are true.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>mask <span class="op">=</span> (phi2 <span class="op">&gt;</span> phi2_min) <span class="op">&amp;</span> (phi2 <span class="op">&lt;</span> phi2_max)</span></code></pre>
</div>
<div id="logical-operators" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="logical-operators" class="callout-inner">
<h3 class="callout-title">Logical operators</h3>
<div class="callout-content">
<p>Python’s logical operators (<code>and</code>, <code>or</code>, and
<code>not</code>) do not work with NumPy or Pandas. Both libraries use
the bitwise operators (<code>&amp;</code>, <code>|</code>, and
<code>~</code>) to do elementwise logical operations (<a href="https://stackoverflow.com/questions/21415661/logical-operators-for-boolean-indexing-in-pandas" class="external-link">explanation
here</a>).</p>
<p>Also, we need the parentheses around the conditions; otherwise the
order of operations is incorrect.</p>
</div>
</div>
</div>
<p>The sum of a Boolean <code>Series</code> is the number of
<code>True</code> values, so we can use <code>sum</code> to see how many
stars are in the selected region.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>mask.<span class="bu">sum</span>()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">25084</span></span></code></pre>
</div>
<p>A Boolean <code>Series</code> is sometimes called a “mask” because we
can use it to mask out some of the rows in a <code>DataFrame</code> and
select the rest, like this:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>centerline_df <span class="op">=</span> results_df[mask]</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="bu">type</span>(centerline_df)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">pandas.core.frame.DataFrame</span></span></code></pre>
</div>
<p><code>centerline_df</code> is a <code>DataFrame</code> that contains
only the rows from <code>results_df</code> that correspond to
<code>True</code> values in <code>mask</code>. So it contains the stars
near the centerline of GD-1.</p>
<p>We can use <code>len</code> to see how many rows are in
<code>centerline_df</code>:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="bu">len</span>(centerline_df)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">25084</span></span></code></pre>
</div>
<p>And what fraction of the rows we have selected.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="bu">len</span>(centerline_df) <span class="op">/</span> <span class="bu">len</span>(results_df)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">0.1787386257562046</span></span></code></pre>
</div>
<p>There are about 25,000 stars in this region, about 18% of the
total.</p>
</section><section><h2 class="section-heading" id="plotting-proper-motion">Plotting proper motion<a class="anchor" aria-label="anchor" href="#plotting-proper-motion"></a>
</h2>
<hr class="half-width">
<p>This is the second time we are plotting proper motion, and we can
imagine we might do it a few more times. Instead of copying and pasting
the previous code, we will write a function that we can reuse on any
dataframe.</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="kw">def</span> plot_proper_motion(df):</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>    <span class="co">"""Plot proper motion.</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a><span class="co">    df: DataFrame with `pm_phi1` and `pm_phi2`</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>    x <span class="op">=</span> df[<span class="st">'pm_phi1'</span>]</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>    y <span class="op">=</span> df[<span class="st">'pm_phi2'</span>]</span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>    plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.3</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>    plt.xlabel(<span class="st">'Proper motion phi1 (mas/yr)'</span>)</span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>    plt.ylabel(<span class="st">'Proper motion phi2 (mas/yr)'</span>)</span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a>    plt.xlim(<span class="op">-</span><span class="dv">12</span>, <span class="dv">8</span>)</span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a>    plt.ylim(<span class="op">-</span><span class="dv">10</span>, <span class="dv">10</span>)</span></code></pre>
</div>
<p>And we can call it like this:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>plot_proper_motion(centerline_df)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/04-motion_files/04-motion_92_0.png" alt="Scatter plot of proper motion of selected stars showing cluster near (-7.5, 0)." class="figure mx-auto d-block"></figure><p>Now we can see more clearly that there is a cluster near (-7.5,
0).</p>
<p>You might notice that our figure is less dense than the one in the
paper. That is because we started with a set of stars from a relatively
small region. The figure in the paper is based on a region about 10
times bigger.</p>
<p>In the next episode we will go back and select stars from a larger
region. But first we will use the proper motion data to identify stars
likely to be in GD-1.</p>
</section><section><h2 class="section-heading" id="filtering-based-on-proper-motion">Filtering based on proper motion<a class="anchor" aria-label="anchor" href="#filtering-based-on-proper-motion"></a>
</h2>
<hr class="half-width">
<p>The next step is to select stars in the “overdense” region of proper
motion, which are candidates to be in GD-1.</p>
<p>In the original paper, Price-Whelan and Bonaca used a polygon to
cover this region, as shown in this figure.</p>
<figure><img width="300" src="../fig/gd1-1.png" alt="Scatter plot of proper motion with overlaid polygon showing overdense region selected for analysis in Price-Whelan and Bonaca paper." class="figure mx-auto d-block"></figure><p>We will use a simple rectangle for now, but in a later lesson we will
see how to select a polygonal region as well.</p>
<p>Here are bounds on proper motion we chose by eye:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>pm1_min <span class="op">=</span> <span class="op">-</span><span class="fl">8.9</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>pm1_max <span class="op">=</span> <span class="op">-</span><span class="fl">6.9</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a>pm2_min <span class="op">=</span> <span class="op">-</span><span class="fl">2.2</span></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a>pm2_max <span class="op">=</span>  <span class="fl">1.0</span></span></code></pre>
</div>
<p>To draw these bounds, we will use the <code>make_rectangle</code>
function we wrote in episode 2 to make two lists containing the
coordinates of the corners of the rectangle.</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>pm1_rect, pm2_rect <span class="op">=</span> make_rectangle(</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>    pm1_min, pm1_max, pm2_min, pm2_max)</span></code></pre>
</div>
<p>Here is what the plot looks like with the bounds we chose.</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>plot_proper_motion(centerline_df)</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>plt.plot(pm1_rect, pm2_rect, <span class="st">'-'</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/04-motion_files/04-motion_100_0.png" alt="Scatter plot of proper motion with blue box showing overdense region selected for our analysis." class="figure mx-auto d-block"></figure><p>Now that we have identified the bounds of the cluster in proper
motion, we will use it to select rows from <code>results_df</code>.</p>
<p>We will use the following function, which uses Pandas operators to
make a mask that selects rows where <code>series</code> falls between
<code>low</code> and <code>high</code>.</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="kw">def</span> between(series, low, high):</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>    <span class="co">"""Check whether values are between `low` and `high`."""</span></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>    <span class="cf">return</span> (series <span class="op">&gt;</span> low) <span class="op">&amp;</span> (series <span class="op">&lt;</span> high)</span></code></pre>
</div>
<p>The following mask selects stars with proper motion in the region we
chose.</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>pm1 <span class="op">=</span> results_df[<span class="st">'pm_phi1'</span>]</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>pm2 <span class="op">=</span> results_df[<span class="st">'pm_phi2'</span>]</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>pm_mask <span class="op">=</span> (between(pm1, pm1_min, pm1_max) <span class="op">&amp;</span> </span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>           between(pm2, pm2_min, pm2_max))</span></code></pre>
</div>
<p>Again, the sum of a Boolean series is the number of <code>TRUE</code>
values.</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>pm_mask.<span class="bu">sum</span>()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">1049</span></span></code></pre>
</div>
<p>Now we can use this mask to select rows from
<code>results_df</code>.</p>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>selected_df <span class="op">=</span> results_df[pm_mask]</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a><span class="bu">len</span>(selected_df)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">1049</span></span></code></pre>
</div>
<p>These are the stars we think are likely to be in GD-1. We can inspect
these stars, plotting their coordinates (not their proper motion).</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a>x <span class="op">=</span> selected_df[<span class="st">'phi1'</span>]</span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>y <span class="op">=</span> selected_df[<span class="st">'phi2'</span>]</span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a>plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a>plt.xlabel(<span class="st">'phi1 (degree GD1)'</span>)</span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a>plt.ylabel(<span class="st">'phi2 (degree GD1)'</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/04-motion_files/04-motion_110_0.png" alt="Scatter plot of coordinates of stars in selected region, showing tidal stream." class="figure mx-auto d-block"></figure><p>Now that is starting to look like a tidal stream!</p>
<p>To clean up the plot a little bit we can add two new Matplotlib
commands:</p>
<ul>
<li><p><code>axis</code> with the parameter <code>equal</code> sets up
the axes so a unit is the same size along the <code>x</code> and
<code>y</code> axes.</p></li>
<li><p><code>title</code> puts the input string as a title at the top of
the plot. The <code>fontsize</code> keyword sets the
<code>fontsize</code> to be <code>medium</code>, a little smaller than
the default <code>large</code>.</p></li>
</ul>
<p>In an example like this, where <code>x</code> and <code>y</code>
represent coordinates in space, equal axes ensures that the distance
between points is represented accurately. Since we are now constraining
the relative proportions of our axes, the data may not fill the entire
figure.</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>x <span class="op">=</span> selected_df[<span class="st">'phi1'</span>]</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>y <span class="op">=</span> selected_df[<span class="st">'phi2'</span>]</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a>plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.3</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a>plt.xlabel(<span class="st">'phi1 [deg]'</span>)</span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a>plt.ylabel(<span class="st">'phi2 [deg]'</span>)</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>plt.title(<span class="st">'Proper motion selection'</span>, fontsize<span class="op">=</span><span class="st">'medium'</span>)</span>
<span id="cb39-9"><a href="#cb39-9" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" tabindex="-1"></a>plt.axis(<span class="st">'equal'</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/04-motion_files/04-motion_plot_pm_selection.png" alt="Scatter plot of coordinates of stars in selected region, showing tidal stream with equally proportioned axes." class="figure mx-auto d-block"></figure><p>Before we go any further, we will put the code we wrote to make one
of the panel figures into a function that we will use in future episodes
to recreate this entire plot with a single line of code.</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="kw">def</span> plot_pm_selection(df):</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a>    <span class="co">"""Plot in GD-1 spatial coordinates the location of the stars</span></span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a><span class="co">    selected by proper motion</span></span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a>    x <span class="op">=</span> df[<span class="st">'phi1'</span>]</span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a>    y <span class="op">=</span> df[<span class="st">'phi2'</span>]</span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a>    plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.3</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" tabindex="-1"></a>    plt.xlabel(<span class="st">'phi1 [deg]'</span>)</span>
<span id="cb41-11"><a href="#cb41-11" tabindex="-1"></a>    plt.ylabel(<span class="st">'phi2 [deg]'</span>)</span>
<span id="cb41-12"><a href="#cb41-12" tabindex="-1"></a>    plt.title(<span class="st">'Proper motion selection'</span>, fontsize<span class="op">=</span><span class="st">'medium'</span>)</span>
<span id="cb41-13"><a href="#cb41-13" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" tabindex="-1"></a>    plt.axis(<span class="st">'equal'</span>)</span></code></pre>
</div>
<p>Now our one line plot command is:</p>
<div class="codewrapper sourceCode" id="cb42">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a>plot_pm_selection(selected_df)</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="saving-the-dataframe">Saving the DataFrame<a class="anchor" aria-label="anchor" href="#saving-the-dataframe"></a>
</h2>
<hr class="half-width">
<p>At this point we have run a successful query and cleaned up the
results. This is a good time to save the data. We have already started a
results file called gd1_data.hdf which we wrote <code>results_df</code>
to.</p>
<p>Recall that we chose HDF5 because it is a binary format producing
small files that are fast to read and write and are a cross-language
standard.</p>
<p>Additionally, HDF5 files can contain more than one dataset and can
store metadata associated with each dataset (such as column names or
observatory information, like a FITS header).</p>
<p>We can add to our existing Pandas <code>DataFrame</code> to an HDF5
file by omitting the <code>mode='w'</code> keyword like this:</p>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_data.hdf'</span></span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a>selected_df.to_hdf(filename, <span class="st">'selected_df'</span>)</span></code></pre>
</div>
<p>Because an HDF5 file can contain more than one Dataset, we have to
provide a name, or “key”, that identifies the Dataset in the file.</p>
<p>We could use any string as the key, but it is generally a good
practice to use a descriptive name (just like your
<code>DataFrame</code> variable name) so we will give the Dataset in the
file the same name (key) as the <code>DataFrame</code>.</p>
<div id="exercise-5-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>We are going to need <code>centerline_df</code> later as well. Write
a line of code to add it as a second Dataset in the HDF5 file.</p>
<p>Hint: Since the file already exists, you should <em>not</em> use
<code>mode='w'</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb44">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a>centerline_df.to_hdf(filename, <span class="st">'centerline_df'</span>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>We can use <code>getsize</code> to confirm that the file exists and
check the size. <code>getsize</code> returns a value in bytes. For the
size files we’re looking at, it will be useful to view their size in
MegaBytes (MB), so we will divide by 1024*1024.</p>
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="im">from</span> os.path <span class="im">import</span> getsize</span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a>MB <span class="op">=</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span></span>
<span id="cb45-4"><a href="#cb45-4" tabindex="-1"></a>getsize(filename) <span class="op">/</span> MB</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">13.992530822753906</span></span></code></pre>
</div>
<p>If you forget what the names of the Datasets in the file are, you can
read them back like this:</p>
<div class="codewrapper sourceCode" id="cb47">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="cf">with</span> pd.HDFStore(filename) <span class="im">as</span> hdf:</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a>    <span class="bu">print</span>(hdf.keys())</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>['/centerline_df', '/results_df', '/selected_df']</code></pre>
</div>
<div id="context-managers" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="context-managers" class="callout-inner">
<h3 class="callout-title">Context Managers</h3>
<div class="callout-content">
<p>We use a <code>with</code> statement here to open the file before the
print statement and (automatically) close it after. Read more about <a href="https://book.pythontips.com/en/latest/context_managers.html" class="external-link">context
managers</a>.</p>
</div>
</div>
</div>
<p>The keys are the names of the Datasets which makes it easy for us to
remember which <code>DataFrame</code> is in which Dataset.</p>
</section><section><h2 class="section-heading" id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<hr class="half-width">
<p>In this episode, we re-loaded the transformed Gaia data we saved from
a previous query.</p>
<p>Then we prototyped the selection process from the Price-Whelan and
Bonaca paper locally using data that we had already downloaded.:</p>
<ul>
<li><p>We selected stars near the centerline of GD-1 and made a scatter
plot of their proper motion.</p></li>
<li><p>We identified a region of proper motion that contains stars
likely to be in GD-1.</p></li>
<li><p>We used a Boolean <code>Series</code> as a mask to select stars
whose proper motion is in that region.</p></li>
</ul>
<p>So far, we have used data from a relatively small region of the sky
so that our local dataset was not too big. In the next lesson, we will
write a query that selects stars based on the proper motion limits we
identified in this lesson, which will allow us to explore a larger
region.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<span class="callout-header">Key Points</span>
<div class="callout-inner">
<div class="callout-content">
<ul>
<li>A workflow is often prototyped on a small set of data which can be
explored more easily and used to identify ways to limit a dataset to
exactly the data you want.</li>
<li>To store data from a Pandas <code>DataFrame</code>, a good option is
an HDF5 file, which can contain multiple Datasets.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-05-select"><p>Content from <a href="05-select.html">Transform and Select</a></p>
<hr>
<p>Last updated on 2025-09-30 |

        <a href="https://github.com/datacarpentry/astronomy-python/edit/main/episodes/05-select.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 70 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>When should we use the database server for computation?</li>
<li>When should we download the data from the database server and
compute locally?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Transform proper motions from one frame to another.</li>
<li>Compute the convex hull of a set of points.</li>
<li>Write an ADQL query that selects based on proper motion.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>In the previous episode, we identified stars with the proper motion
we expect for GD-1.</p>
<p>Now we will do the same selection in an ADQL query, which will make
it possible to work with a larger region of the sky and still download
less data.</p>
<div id="outline" class="callout checklist">
<div class="callout-square">
<i class="callout-icon" data-feather="check-square"></i>
</div>
<span class="callout-header">Checklist</span>
<div id="outline" class="callout-inner">
<h3 class="callout-title">Outline</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li><p>Using data from the previous episode, we will identify the values
of proper motion for stars likely to be in GD-1.</p></li>
<li><p>Then we will compose an ADQL query that selects stars based on
proper motion, so we can download only the data we need.</p></li>
</ol>
<p>That will make it possible to search a bigger region of the sky in a
single query.</p>
</div>
</div>
</div>
<div id="starting-from-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<span class="callout-header">Prerequisite</span>
<div id="starting-from-this-episode" class="callout-inner">
<h3 class="callout-title">Starting from this episode</h3>
<div class="callout-content">
<p>If you are starting a new notebook for this episode, expand this
section for information you will need to get started.</p>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> Read me </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler1" aria-labelledby="headingSpoiler1">
<div class="accordion-body">
<p>Previously, we ran a query on the Gaia server, downloaded data for
roughly 140,000 stars, and saved the data in a FITS file. We then
selected just the stars with the same proper motion as GD-1 and saved
the results to an HDF5 file. We will use that data for this episode.
Whether you are working from a new notebook or coming back from a
checkpoint, reloading the data will save you from having to run the
query again.</p>
<p>If you are starting this episode here or starting this episode in a
new notebook, you will need to run the following lines of code.</p>
<p>This imports previously imported functions:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> astropy.units <span class="im">as</span> u</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">from</span> astropy.coordinates <span class="im">import</span> SkyCoord</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">from</span> astroquery.gaia <span class="im">import</span> Gaia</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">from</span> gala.coordinates <span class="im">import</span> GD1Koposov10, reflex_correct</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="im">from</span> episode_functions <span class="im">import</span> <span class="op">*</span></span></code></pre>
</div>
<p>The following code loads in the data (instructions for downloading
data can be found in the <a href="index.html#setup">setup instructions</a>).
You may need to add a the path to the filename variable below
(e.g. <code>filename = 'student_download/backup-data/gd1_data.hdf'</code>)</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_data.hdf'</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>centerline_df <span class="op">=</span> pd.read_hdf(filename, <span class="st">'centerline_df'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>selected_df <span class="op">=</span> pd.read_hdf(filename, <span class="st">'selected_df'</span>)</span></code></pre>
</div>
<p>This defines previously defined quantities:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>pm1_min <span class="op">=</span> <span class="op">-</span><span class="fl">8.9</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>pm1_max <span class="op">=</span> <span class="op">-</span><span class="fl">6.9</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>pm2_min <span class="op">=</span> <span class="op">-</span><span class="fl">2.2</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>pm2_max <span class="op">=</span>  <span class="fl">1.0</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>pm1_rect, pm2_rect <span class="op">=</span> make_rectangle(</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>    pm1_min, pm1_max, pm2_min, pm2_max)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>gd1_frame <span class="op">=</span> GD1Koposov10()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="selection-by-proper-motion">Selection by proper motion<a class="anchor" aria-label="anchor" href="#selection-by-proper-motion"></a>
</h2>
<hr class="half-width">
<p>Let us review how we got to this point.</p>
<ol style="list-style-type: decimal">
<li><p>We made an ADQL query to the Gaia server to get data for stars in
the vicinity of a small part of GD-1.</p></li>
<li><p>We transformed the coordinates to the GD-1 frame
(<code>GD1Koposov10</code>) so we could select stars along the
centerline of GD-1.</p></li>
<li><p>We plotted the proper motion of stars along the centerline of
GD-1 to identify the bounds of an anomalous overdense region associated
with the proper motion of stars in GD-1.</p></li>
<li><p>We made a mask that selects stars whose proper motion is in this
overdense region and which are therefore likely to be part of the GD-1
stream.</p></li>
</ol>
<p>At this point we have downloaded data for a relatively large number
of stars (more than 100,000) and selected a relatively small number
(around 1000).</p>
<p>It would be more efficient to use ADQL to select only the stars we
need. That would also make it possible to download data covering a
larger region of the sky.</p>
<p>However, the selection we did was based on proper motion in the GD-1
frame. In order to do the same selection on the Gaia catalog in ADQL, we
have to work with proper motions in the ICRS frame as this is the frame
that the Gaia catalog uses.</p>
<p>First, we will verify that our proper motion selection was correct,
starting with the <code>plot_proper_motion</code> function that we
defined in episode 3. The following figure shows:</p>
<ul>
<li><p>Proper motion for the stars we selected along the center line of
GD-1,</p></li>
<li><p>The rectangle we selected, and</p></li>
<li><p>The stars inside the rectangle highlighted in green.</p></li>
</ul>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>plot_proper_motion(centerline_df)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>plt.plot(pm1_rect, pm2_rect)</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>x <span class="op">=</span> selected_df[<span class="st">'pm_phi1'</span>]</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>y <span class="op">=</span> selected_df[<span class="st">'pm_phi2'</span>]</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>plt.plot(x, y, <span class="st">'gx'</span>, markersize<span class="op">=</span><span class="fl">0.3</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)<span class="op">;</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/05-select_files/05-select_14_0.png" alt="Proper motion of stars in GD-1, showing selected region as blue box and stars within selection as green points." class="figure mx-auto d-block"></figure><p>Now we will make the same plot using proper motions in the ICRS
frame, which are stored in columns named <code>pmra</code> and
<code>pmdec</code>.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>x <span class="op">=</span> centerline_df[<span class="st">'pmra'</span>]</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>y <span class="op">=</span> centerline_df[<span class="st">'pmdec'</span>]</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.3</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>x <span class="op">=</span> selected_df[<span class="st">'pmra'</span>]</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>y <span class="op">=</span> selected_df[<span class="st">'pmdec'</span>]</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>plt.plot(x, y, <span class="st">'gx'</span>, markersize<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>    </span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>plt.xlabel(<span class="st">'Proper motion ra (ICRS frame)'</span>)</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>plt.ylabel(<span class="st">'Proper motion dec (ICRS frame)'</span>)</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>plt.xlim([<span class="op">-</span><span class="dv">10</span>, <span class="dv">5</span>])</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>plt.ylim([<span class="op">-</span><span class="dv">20</span>, <span class="dv">5</span>])<span class="op">;</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/05-select_files/05-select_16_0.png" alt="Proper motion in ICRS frame, showing selected stars are more spread out in this frame." class="figure mx-auto d-block"></figure><p>The proper motions of the selected stars are more spread out in this
frame, which is why it was preferable to do the selection in the GD-1
frame.</p>
<p>In the following exercise, we will identify a rectangle that
encompasses the majority of the stars we identified as having proper
motion consistent with that of GD-1 without including too many other
stars.</p>
<div id="exercise-5-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>Looking at the proper motion of the stars we identified along the
centerline of GD-1, in the ICRS reference frame define a rectangle
(<code>pmra_min</code>, <code>pmra_max</code>, <code>pmdec_min</code>,
and <code>pmdec_max</code>) that encompass the proper motion of the
majority of the stars near the centerline of GD-1 without including to
much contamination from other stars.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>pmra_min <span class="op">=</span> <span class="op">-</span><span class="fl">6.70</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>pmra_max <span class="op">=</span> <span class="op">-</span><span class="dv">3</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>pmdec_min <span class="op">=</span> <span class="op">-</span><span class="fl">14.31</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>pmdec_max <span class="op">=</span> <span class="op">-</span><span class="fl">11.2</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="assembling-the-query">Assembling the query<a class="anchor" aria-label="anchor" href="#assembling-the-query"></a>
</h2>
<hr class="half-width">
<p>In episode 2 we used the following query to select stars in a
polygonal region around a small part of GD-1 with a few filters on color
and distance (parallax):</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>candidate_coord_query_base <span class="op">=</span> <span class="st">"""SELECT</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="st">WHERE parallax &lt; 1</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="st">  AND bp_rp BETWEEN -0.75 AND 2 </span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="st">  AND 1 = CONTAINS(POINT(ra, dec), </span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="st">                   POLYGON(</span><span class="sc">{sky_point_list}</span><span class="st">))</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>In this episode we will make two changes:</p>
<ol style="list-style-type: decimal">
<li><p>We will select stars with coordinates in a larger region to
include more of GD-1.</p></li>
<li><p>We will add another clause to select stars whose proper motion is
in the range we just defined in the previous exercise.</p></li>
</ol>
<p>The fact that we remove most contaminating stars with the proper
motion filter is what allows us to expand our query to include most of
GD-1 without returning too many results. As we did in episode 2, we will
define the physical region we want to select in the GD-1 frame and
transform it to the ICRS frame to query the Gaia catalog which is in the
ICRS frame.</p>
<p>Here are the coordinates of the larger rectangle in the GD-1
frame.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>phi1_min <span class="op">=</span> <span class="op">-</span><span class="dv">70</span> <span class="op">*</span> u.degree</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>phi1_max <span class="op">=</span> <span class="op">-</span><span class="dv">20</span> <span class="op">*</span> u.degree</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>phi2_min <span class="op">=</span> <span class="op">-</span><span class="dv">5</span> <span class="op">*</span> u.degree</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>phi2_max <span class="op">=</span> <span class="dv">5</span> <span class="op">*</span> u.degree</span></code></pre>
</div>
<p>We selected these bounds by trial and error, defining the largest
region we can process in a single query.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>phi1_rect, phi2_rect <span class="op">=</span> make_rectangle(</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>    phi1_min, phi1_max, phi2_min, phi2_max)</span></code></pre>
</div>
<p>Here is how we transform it to ICRS, as we saw in episode 2.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>corners <span class="op">=</span> SkyCoord(phi1<span class="op">=</span>phi1_rect, </span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>                   phi2<span class="op">=</span>phi2_rect, </span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>                   frame<span class="op">=</span>gd1_frame)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>corners_icrs <span class="op">=</span> corners.transform_to(<span class="st">'icrs'</span>)</span></code></pre>
</div>
<p>To use <code>corners_icrs</code> as part of an ADQL query, we have to
convert it to a string. Fortunately, we wrote a function,
<code>skycoord_to_string</code> to do this in episode 2 which we will
call now.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>sky_point_list <span class="op">=</span> skycoord_to_string(corners_icrs)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>sky_point_list</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="st">'135.306, 8.39862, 126.51, 13.4449, 163.017, 54.2424, 172.933, 46.4726, 135.306, 8.39862'</span></span></code></pre>
</div>
<p>Here are the columns we want to select.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>columns <span class="op">=</span> <span class="st">'source_id, ra, dec, pmra, pmdec'</span></span></code></pre>
</div>
<p>Now we have everything we need to assemble the query, but <strong>DO
NOT try to run this query</strong>. Because it selects a larger region,
there are too many stars to handle in a single query. Until we select by
proper motion, that is.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>candidate_coord_query <span class="op">=</span> candidate_coord_query_base.<span class="bu">format</span>(columns<span class="op">=</span>columns, </span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>                            sky_point_list<span class="op">=</span>sky_point_list)</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="bu">print</span>(candidate_coord_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SELECT
source_id, ra, dec, pmra, pmdec
FROM gaiadr2.gaia_source
WHERE parallax &lt; 1
  AND bp_rp BETWEEN -0.75 AND 2
  AND 1 = CONTAINS(POINT(ra, dec),
                   POLYGON(135.306, 8.39862, 126.51, 13.4449, 163.017, 54.2424, 172.933, 46.4726, 135.306, 8.39862))</code></pre>
</div>
</section><section><h2 class="section-heading" id="selecting-proper-motion">Selecting proper motion<a class="anchor" aria-label="anchor" href="#selecting-proper-motion"></a>
</h2>
<hr class="half-width">
<p>Now we are ready to add a <code>WHERE</code> clause to select stars
whose proper motion falls range we defined in the last exercise.</p>
<div id="exercise-10-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-10-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (10 minutes)</h3>
<div class="callout-content">
<p>Define <code>candidate_coord_pm_query_base</code>, starting with
<code>candidate_coord_query_base</code> and adding two new
<code>BETWEEN</code> clauses to select stars whose coordinates of proper
motion, <code>pmra</code> and <code>pmdec</code>, fall within the region
defined by <code>pmra_min</code>, <code>pmra_max</code>,
<code>pmdec_min</code>, and <code>pmdec_max</code>. In the next exercise
we will use the format statement to fill in the values we defined
above.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>candidate_coord_pm_query_base <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="st">WHERE parallax &lt; 1</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="st">  AND bp_rp BETWEEN -0.75 AND 2 </span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="st">  AND 1 = CONTAINS(POINT(ra, dec), </span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="st">                   POLYGON(</span><span class="sc">{sky_point_list}</span><span class="st">))</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="st">  AND pmra BETWEEN </span><span class="sc">{pmra_min}</span><span class="st"> AND  </span><span class="sc">{pmra_max}</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="st">  AND pmdec BETWEEN </span><span class="sc">{pmdec_min}</span><span class="st"> AND </span><span class="sc">{pmdec_max}</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="exercise-5-minutes-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes-1" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>Use <code>format</code> to format
<code>candidate_coord_pm_query_base</code> and define
<code>candidate_coord_pm_query</code>, filling in the values of
<code>columns</code>, <code>sky_point_list</code>, and
<code>pmra_min</code>, <code>pmra_max</code>, <code>pmdec_min</code>,
<code>pmdec_max</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>candidate_coord_pm_query <span class="op">=</span> candidate_coord_pm_query_base.<span class="bu">format</span>(columns<span class="op">=</span>columns, </span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>                            sky_point_list<span class="op">=</span>sky_point_list,</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>                            pmra_min<span class="op">=</span>pmra_min,</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>                            pmra_max<span class="op">=</span>pmra_max,</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>                            pmdec_min<span class="op">=</span>pmdec_min,</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>                            pmdec_max<span class="op">=</span>pmdec_max)</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="bu">print</span>(candidate_coord_pm_query)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Now we can run the query like this:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>candidate_coord_pm_job <span class="op">=</span> Gaia.launch_job_async(candidate_coord_pm_query)</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="bu">print</span>(candidate_coord_pm_job)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]
&lt;Table length=8409&gt;
   name    dtype    unit                              description
--------- ------- -------- ------------------------------------------------------------------
source_id   int64          Unique source identifier (unique within a particular Data Release)
       ra float64      deg                                                    Right ascension
      dec float64      deg                                                        Declination
     pmra float64 mas / yr                         Proper motion in right ascension direction
    pmdec float64 mas / yr                             Proper motion in declination direction
Jobid: 1616771462206O
Phase: COMPLETED
[Output truncated]</code></pre>
</div>
<p>And get the results.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>candidate_gaia_table <span class="op">=</span> candidate_coord_pm_job.get_results()</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="bu">len</span>(candidate_gaia_table)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">8409</span></span></code></pre>
</div>
<div id="between-vs-polygon" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="between-vs-polygon" class="callout-inner">
<h3 class="callout-title">BETWEEN vs POLYGON</h3>
<div class="callout-content">
<p>You may be wondering why we used <code>BETWEEN</code> for proper
motion when we previously used <code>POLYGON</code> for coordinates.
ADQL intends the <code>POLYGON</code> function to only be used on
coordinates and not on proper motion. To enforce this, it will produce
an error when a negative value is passed into the first argument.</p>
</div>
</div>
</div>
<p>We call the results <code>candidate_gaia_table</code> because it
contains information from the Gaia table for stars that are good
candidates for GD-1.</p>
<p><code>sky_point_list</code>, <code>pmra_min</code>,
<code>pmra_max</code>, <code>pmdec_min</code>, and
<code>pmdec_max</code> are a set of selection criteria that we derived
from data downloaded from the Gaia Database. To make sure we can repeat
our analysis at a later date we should save this information to a
file.</p>
<p>There are several ways we could do that, but since we are already
storing data in an HDF5 file, we will do the same with these
variables.</p>
<p>To save them to an HDF5 file we first need to put them in a Pandas
object. We have seen how to create a <code>Series</code> from a column
in a <code>DataFrame</code>. Now we will build a <code>Series</code>
from scratch. We do not need the full <code>DataFrame</code> format with
multiple rows and columns because we are only storing one string
(<code>sky_point_list</code>). We can store each string as a row in the
<code>Series</code> and save it. One aspect that is nice about
<code>Series</code> is that we can label each row. To do this we need an
object that can define both the name of each row and the data to go in
that row. We can use a Python <code>Dictionary</code> for this, defining
the row names with the dictionary keys and the row data with the
dictionary values.</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>d <span class="op">=</span> <span class="bu">dict</span>(sky_point_list<span class="op">=</span>sky_point_list, pmra_min<span class="op">=</span>pmra_min, pmra_max<span class="op">=</span>pmra_max, pmdec_min<span class="op">=</span>pmdec_min, pmdec_max<span class="op">=</span>pmdec_max)</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>d</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>{'sky_point_list': '135.306, 8.39862, 126.51, 13.4449, 163.017, 54.2424, 172.933, 46.4726, 135.306, 8.39862',
 'pmra_min': -6.7,
 'pmra_max': -3,
 'pmdec_min': -14.31,
 'pmdec_max': -11.2}</code></pre>
</div>
<p>And use this <code>Dictionary</code> to initialize a
<code>Series</code>.</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>point_series <span class="op">=</span> pd.Series(d)</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>point_series</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>sky_point_list    135.306, 8.39862, 126.51, 13.4449, 163.017, 54...
pmra_min                                                       -6.7
pmra_max                                                         -3
pmdec_min                                                    -14.31
pmdec_max                                                     -11.2
dtype: object</code></pre>
</div>
<p>Now we can save our <code>Series</code> using
<code>to_hdf()</code>.</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_data.hdf'</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>point_series.to_hdf(filename, <span class="st">'point_series'</span>)</span></code></pre>
</div>
<div id="performance-warning" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="performance-warning" class="callout-inner">
<h3 class="callout-title">Performance Warning</h3>
<div class="callout-content">
<p>You may see the previous command issue this or a similar performance
warning:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[...] PerformanceWarning:
your performance may suffer as PyTables will pickle object types that it cannot
map directly to c-types [inferred_type-&gt;mixed-integer,key-&gt;values] [items-&gt;None]
  point_series.to_hdf(filename, 'point_series')</code></pre>
</div>
<p>This is because in the Series we just created, we are mixing
variables of different types: <code>sky_point_list</code> is a string
(text), whereas <code>pmra_min</code> etc. are floating point numbers.
While combining different data types in a single Series is somewhat
inefficient, the amount of data is small enough to not matter in this
case, so this warning can be safely ignored.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="plotting-one-more-time">Plotting one more time<a class="anchor" aria-label="anchor" href="#plotting-one-more-time"></a>
</h2>
<hr class="half-width">
<p>Now we can examine the results:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>x <span class="op">=</span> candidate_gaia_table[<span class="st">'ra'</span>]</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>y <span class="op">=</span> candidate_gaia_table[<span class="st">'dec'</span>]</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.3</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>plt.xlabel(<span class="st">'ra (degree ICRS)'</span>)</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>plt.ylabel(<span class="st">'dec (degree ICRS)'</span>)<span class="op">;</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/05-select_files/05-select_66_0.png" alt="Scatter plot of right ascension and declination of selected stars in ICRS frame." class="figure mx-auto d-block"></figure><p>This plot shows why it was useful to transform these coordinates to
the GD-1 frame. In ICRS, it is more difficult to identity the stars near
the centerline of GD-1.</p>
<p>We can use our <code>make_dataframe</code> function from episode 3 to
transform the results back to the GD-1 frame. In addition to doing the
coordinate transformation and reflex correction for us, this function
also compiles everything into a single object (a <code>DataFrame</code>)
to make it easier to use. Note that because we put this code into a
function, we can do all of this with a single line of code!</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>candidate_gaia_df <span class="op">=</span> make_dataframe(candidate_gaia_table)</span></code></pre>
</div>
<p>We can check the results using the <code>plot_pm_selection</code>
function we wrote in episode 3.</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>plot_pm_selection(candidate_gaia_df)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/05-select_files/05-select_72_0.png" alt="Scatter plot of phi1 versus phi2 in GD-1 frame after selecting on proper motion." class="figure mx-auto d-block"></figure><p>We are starting to see GD-1 more clearly. We can compare this figure
with this panel from Figure 1 from the original paper:</p>
<figure><img height="150" src="../fig/gd1-2.png" alt="Figure from Price-Whelan and Bonaca paper showing phi1 vs phi2 in GD-1 after selecting on proper motion." class="figure mx-auto d-block"></figure><p>This panel shows stars selected based on proper motion only, so it is
comparable to our figure (although notice that the original figure
covers a wider region).</p>
<p>In the next episode, we will use photometry data from Pan-STARRS to
do a second round of filtering, and see if we can replicate this
panel.</p>
<figure><img height="150" src="../fig/gd1-4.png" alt="Figure from Price-Whelan and Bonaca paper showing phi1 vs phi2 in GD-1 after selecting on proper motion and photometry." class="figure mx-auto d-block"></figure><p>Later we will learn how to add annotations like the ones in the
figure and customize the style of the figure to present the results
clearly and compellingly.</p>
</section><section><h2 class="section-heading" id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<hr class="half-width">
<p>In the previous episode we downloaded data for a large number of
stars and then selected a small fraction of them based on proper
motion.</p>
<p>In this episode, we improved this process by writing a more complex
query that uses the database to select stars based on proper motion.
This process requires more computation on the Gaia server, but then we
are able to either:</p>
<ol style="list-style-type: decimal">
<li><p>Search the same region and download less data, or</p></li>
<li><p>Search a larger region while still downloading a manageable
amount of data.</p></li>
</ol>
<p>In the next episode, we will learn about the database
<code>JOIN</code> operation, which we will use in later episodes to join
our Gaia data with photometry data from Pan-STARRS.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<span class="callout-header">Key Points</span>
<div class="callout-inner">
<div class="callout-content">
<ul>
<li>When possible, ‘move the computation to the data’; that is, do as
much of the work as possible on the database server before downloading
the data.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-06-join"><p>Content from <a href="06-join.html">Join</a></p>
<hr>
<p>Last updated on 2025-07-16 |

        <a href="https://github.com/datacarpentry/astronomy-python/edit/main/episodes/06-join.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 90 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do we use <code>JOIN</code> to combine information from multiple
tables?</li>
<li>How can we make a selection within a joined table?</li>
<li>How should we save the result?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Write ADQL queries involving <code>JOIN</code> operations.</li>
<li>Save data in CSV format.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>The next step in our analysis is to select candidate stars based on
photometry data. The following figure from the Price-Whelan and Bonaca
paper is a color-magnitude diagram for the stars selected based on
proper motion:</p>
<figure><img width="300" src="../fig/gd1-3.png" alt="Color-magnitude diagram for the stars selected based on proper motion, from Price-Whelan and Bonaca paper." class="figure mx-auto d-block"></figure><p>In red is a <a href="https://en.wikipedia.org/wiki/Stellar_isochrone" class="external-link">stellar
isochrone</a>, showing where we expect the stars in GD-1 to fall based
on the metallicity and age of their original globular cluster.</p>
<p>By selecting stars in the shaded area, we can further distinguish the
main sequence of GD-1 from younger background stars.</p>
<div id="outline" class="callout checklist">
<div class="callout-square">
<i class="callout-icon" data-feather="check-square"></i>
</div>
<span class="callout-header">Checklist</span>
<div id="outline" class="callout-inner">
<h3 class="callout-title">Outline</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li><p>We will reload the candidate stars we identified in the previous
episode.</p></li>
<li><p>Then we will run a query on the Gaia server that uploads the
table of candidates and uses a <code>JOIN</code> operation to select
photometry data for the candidate stars.</p></li>
<li><p>We will write the results to a file for use in the next
episode.</p></li>
</ol>
</div>
</div>
</div>
<div id="starting-from-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<span class="callout-header">Prerequisite</span>
<div id="starting-from-this-episode" class="callout-inner">
<h3 class="callout-title">Starting from this episode</h3>
<div class="callout-content">
<p>If you are starting a new notebook for this episode, expand this
section for information you will need to get started.</p>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> Read me </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler1" aria-labelledby="headingSpoiler1">
<div class="accordion-body">
<p>In the previous episode, we define a rectangle around stars in GD-1
in spatial coordinates and in proper motion which we transformed into
ICRS coordinates and created point lists of the polygon vertices. We
will use that data for this episode. Whether you are working from a new
notebook or coming back from a checkpoint, reloading the data will save
you from having to run the query again.</p>
<p>If you are starting this episode here or starting this episode in a
new notebook, you will need run the following lines of code.</p>
<p>This imports previously imported functions:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">from</span> astroquery.gaia <span class="im">import</span> Gaia</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">from</span> episode_functions <span class="im">import</span> <span class="op">*</span></span></code></pre>
</div>
<p>The following code loads in the data (instructions for downloading
data can be found in the <a href="index.html#setup">setup instructions</a>).
You may need to add a the path to the filename variable below
(e.g. <code>filename = 'student_download/backup-data/gd1_data.hdf'</code>)</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_data.hdf'</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>point_series <span class="op">=</span> pd.read_hdf(filename, <span class="st">'point_series'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>sky_point_list <span class="op">=</span> point_series[<span class="st">'sky_point_list'</span>]</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>pmra_min <span class="op">=</span> point_series[<span class="st">'pmra_min'</span>]</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>pmra_max <span class="op">=</span> point_series[<span class="st">'pmra_max'</span>]</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>pmdec_min <span class="op">=</span> point_series[<span class="st">'pmdec_min'</span>]</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>pmdec_max <span class="op">=</span> point_series[<span class="st">'pmdec_max'</span>]</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>point_series</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="getting-photometry-data">Getting photometry data<a class="anchor" aria-label="anchor" href="#getting-photometry-data"></a>
</h2>
<hr class="half-width">
<p>The Gaia dataset contains some photometry data, including the
variable <code>bp_rp</code>, which contains BP-RP color (the difference
in mean flux between the BP and RP bands). We use this variable to
select stars with <code>bp_rp</code> between -0.75 and 2, which excludes
many class M dwarf stars.</p>
<p>But we can do better than that. Assuming GD-1 is a globular cluster,
all of the stars formed at the same time from the same material, so the
stars’ photometric properties should be consistent with a single
isochrone in a color magnitude diagram. We can use photometric color and
apparent magnitude to select stars with the age and metal richness we
expect in GD-1. However, the broad Gaia photometric bands (G, BP, RP)
are not optimized for this task, instead we will use the more narrow
photometric bands available from the Pan-STARRS survey to obtain the
<code>g-i</code> color and apparent <code>g</code>-band magnitude.</p>
<p>Conveniently, the Gaia server provides data from Pan-STARRS as a
table in the same database we have been using, so we can access it by
making ADQL queries.</p>
<div id="a-caveat-about-matching-stars-between-catalogs" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="a-caveat-about-matching-stars-between-catalogs" class="callout-inner">
<h3 class="callout-title">A caveat about matching stars between
catalogs</h3>
<div class="callout-content">
<p>In general, choosing a star from the Gaia catalog and finding the
corresponding star in the Pan-STARRS catalog is not easy. This kind of
cross matching is not always possible, because a star might appear in
one catalog and not the other. And even when both stars are present,
there might not be a clear one-to-one relationship between stars in the
two catalogs. Additional <a href="https://docs.astropy.org/en/stable/coordinates/matchsep.html#matching-catalogs" class="external-link">catalog
matching tools</a> are available from the Astropy coordinates
package.</p>
<p>Fortunately, people have worked on this problem, and the Gaia
database includes cross-matching tables that suggest a best neighbor in
the Pan-STARRS catalog for many stars in the Gaia catalog.</p>
<p><a href="https://gea.esac.esa.int/archive/documentation/GDR2/Catalogue_consolidation/chap_cu9val_cu9val/ssec_cu9xma/sssec_cu9xma_extcat.html" class="external-link">This
document describes the cross matching process</a>. Briefly, it uses a
cone search to find possible matches in approximately the right
position, then uses attributes like color and magnitude to choose pairs
of observations most likely to be the same star.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="the-best-neighbor-table">The best neighbor table<a class="anchor" aria-label="anchor" href="#the-best-neighbor-table"></a>
</h2>
<hr class="half-width">
<p>So the hard part of cross-matching has been done for us. Using the
results is a little tricky, but it gives us a chance to learn about one
of the most important tools for working with databases: “joining”
tables.</p>
<p>A “join” is an operation where you match up records from one table
with records from another table using as a “key” a piece of information
that is common to both tables, usually some kind of ID code.</p>
<p>In this example:</p>
<ul>
<li><p>Stars in the Gaia dataset are identified by
<code>source_id</code>.</p></li>
<li><p>Stars in the Pan-STARRS dataset are identified by
<code>obj_id</code>.</p></li>
</ul>
<p>For each candidate star we have selected so far, we have the
<code>source_id</code>; the goal is to find the <code>obj_id</code> for
the same star in the Pan-STARRS catalog.</p>
<p>To do that we will:</p>
<ol style="list-style-type: decimal">
<li><p>Use the <code>JOIN</code> operator to look up each Pan-STARRS
<code>obj_id</code> for the stars we are interested in the
<code>panstarrs1_best_neighbour</code> table using the
<code>source_ids</code> that we have already identified.</p></li>
<li><p>Use the <code>JOIN</code> operator again to look up the
Pan-STARRS photometry for these stars in the
<code>panstarrs1_original_valid</code> table using the
<code>obj_ids</code> we just identified.</p></li>
</ol>
<p>Before we get to the <code>JOIN</code> operation, we will explore
these tables.</p>
<div id="british-vs-american-spelling-of-neighbour" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="british-vs-american-spelling-of-neighbour" class="callout-inner">
<h3 class="callout-title">British vs American Spelling of Neighbour</h3>
<div class="callout-content">
<p>The Gaia database was created and is maintained by the European Space
Astronomy Center. For this reason, the table spellings use the British
spelling of neighbour (with a “u”). Do not forget to include it in your
table names in the queries below.</p>
</div>
</div>
</div>
<p>Here is the metadata for <code>panstarrs1_best_neighbour</code>.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>ps_best_neighbour_meta <span class="op">=</span> Gaia.load_table(<span class="st">'gaiadr2.panstarrs1_best_neighbour'</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Retrieving table 'gaiadr2.panstarrs1_best_neighbour'
Parsing table 'gaiadr2.panstarrs1_best_neighbour'...
Done.</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="bu">print</span>(ps_best_neighbour_meta)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>TAP Table name: gaiadr2.gaiadr2.panstarrs1_best_neighbour
Description: Pan-STARRS1 BestNeighbour table lists each matched Gaia object with its
best neighbour in the external catalogue.
There are 1 327 157 objects in the filtered version of Pan-STARRS1 used
to compute this cross-match that have too early epochMean.
Num. columns: 7</code></pre>
</div>
<p>And here are the columns.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> ps_best_neighbour_meta.columns:</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    <span class="bu">print</span>(column.name)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">source_id</span></span>
<span><span class="va">original_ext_source_id</span></span>
<span><span class="va">angular_distance</span></span>
<span><span class="va">number_of_neighbours</span></span>
<span><span class="va">number_of_mates</span></span>
<span><span class="va">best_neighbour_multiplicity</span></span>
<span><span class="va">gaia_astrometric_params</span></span></code></pre>
</div>
<p>Here is the <a href="https://gea.esac.esa.int/archive/documentation/GDR2/Gaia_archive/chap_datamodel/sec_dm_crossmatches/ssec_dm_panstarrs1_best_neighbour.html" class="external-link">documentation
for these variables</a>.</p>
<p>The ones we will use are:</p>
<ul>
<li><p><code>source_id</code>, which we will match up with
<code>source_id</code> in the Gaia table.</p></li>
<li><p><code>best_neighbour_multiplicity</code>, which indicates how
many sources in Pan-STARRS are matched with the same probability to this
source in Gaia.</p></li>
<li><p><code>number_of_mates</code>, which indicates the number of
<em>other</em> sources in Gaia that are matched with the same source in
Pan-STARRS.</p></li>
<li><p><code>original_ext_source_id</code>, which we will match up with
<code>obj_id</code> in the Pan-STARRS table.</p></li>
</ul>
<p>Ideally, <code>best_neighbour_multiplicity</code> should be 1 and
<code>number_of_mates</code> should be 0; in that case, there is a
one-to-one match between the source in Gaia and the corresponding source
in Pan-STARRS.</p>
<div id="number-of-neighbors" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="number-of-neighbors" class="callout-inner">
<h3 class="callout-title">Number of neighbors</h3>
<div class="callout-content">
<p>The table also contains <code>number_of_neighbours</code> which is
the number of stars in Pan-STARRS that match in terms of position,
before using other criteria to choose the most likely match. But we are
more interested in the final match, using both criteria.</p>
</div>
</div>
</div>
<p>Here is a query that selects these columns and returns the first 5
rows.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>ps_best_neighbour_query <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="st">TOP 5</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="st">source_id, best_neighbour_multiplicity, number_of_mates, original_ext_source_id</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="st">FROM gaiadr2.panstarrs1_best_neighbour</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>ps_best_neighbour_job <span class="op">=</span> Gaia.launch_job_async(ps_best_neighbour_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>ps_best_neighbour_results <span class="op">=</span> ps_best_neighbour_job.get_results()</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>ps_best_neighbour_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=5&gt;
     source_id      best_neighbour_multiplicity number_of_mates original_ext_source_id
       int64                  int32                  int16              int64
------------------- --------------------------- --------------- ----------------------
6745938972433480704                           1               0      69742925668851205
6030466788955954048                           1               0      69742509325691172
6756488099308169600                           1               0      69742879438541228
6700154994715046016                           1               0      69743055581721207
6757061941303252736                           1               0      69742856540241198</code></pre>
</div>
</section><section><h2 class="section-heading" id="the-pan-starrs-table">The Pan-STARRS table<a class="anchor" aria-label="anchor" href="#the-pan-starrs-table"></a>
</h2>
<hr class="half-width">
<p>Now that we know the Pan-STARRS <code>obj_id</code>, we are ready to
match this to the photometry in the
<code>panstarrs1_original_valid</code> table. Here is the metadata for
the table that contains the Pan-STARRS data.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>ps_valid_meta <span class="op">=</span> Gaia.load_table(<span class="st">'gaiadr2.panstarrs1_original_valid'</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Retrieving table 'gaiadr2.panstarrs1_original_valid'
Parsing table 'gaiadr2.panstarrs1_original_valid'...
Done.</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="bu">print</span>(ps_valid_meta)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>TAP Table name: gaiadr2.gaiadr2.panstarrs1_original_valid
Description: The Panoramic Survey Telescope and Rapid Response System (Pan-STARRS) is
a system for wide-field astronomical imaging developed and operated by
the Institute for Astronomy at the University of Hawaii. Pan-STARRS1
(PS1) is the first part of Pan-STARRS to be completed and is the basis
for Data Release 1 (DR1). The PS1 survey used a 1.8 meter telescope and
its 1.4 Gigapixel camera to image the sky in five broadband filters (g,
r, i, z, y).

The current table contains a filtered subsample of the 10 723 304 629
entries listed in the original ObjectThin table.
[Output truncated]</code></pre>
</div>
<p>And here are the columns.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> ps_valid_meta.columns:</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>    <span class="bu">print</span>(column.name)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>obj_name
obj_id
ra
dec
ra_error
dec_error
epoch_mean
g_mean_psf_mag
g_mean_psf_mag_error
g_flags
r_mean_psf_mag
[Output truncated]</code></pre>
</div>
<p>Here is the <a href="https://gea.esac.esa.int/archive/documentation/GDR2/Gaia_archive/chap_datamodel/sec_dm_external_catalogues/ssec_dm_panstarrs1_original_valid.html" class="external-link">documentation
for these variables</a> .</p>
<p>The ones we will use are:</p>
<ul>
<li><p><code>obj_id</code>, which we will match up with
<code>original_ext_source_id</code> in the best neighbor table.</p></li>
<li><p><code>g_mean_psf_mag</code>, which contains mean magnitude from
the <code>g</code> filter.</p></li>
<li><p><code>i_mean_psf_mag</code>, which contains mean magnitude from
the <code>i</code> filter.</p></li>
</ul>
<p>Here is a query that selects these variables and returns the first 5
rows.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>ps_valid_query <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="st">TOP 5</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="st">obj_id, g_mean_psf_mag, i_mean_psf_mag </span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="st">FROM gaiadr2.panstarrs1_original_valid</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>ps_valid_job <span class="op">=</span> Gaia.launch_job_async(ps_valid_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>ps_valid_results <span class="op">=</span> ps_valid_job.get_results()</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>ps_valid_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=5&gt;
      obj_id      g_mean_psf_mag  i_mean_psf_mag
                                       mag
      int64          float64         float64
----------------- -------------- ----------------
67130655389101425             -- 20.3516006469727
67553305590067819             --  19.779899597168
67551423248967849             -- 19.8889007568359
67132026238911331             -- 20.9062995910645
67553513677687787             -- 21.2831001281738</code></pre>
</div>
</section><section><h2 class="section-heading" id="joining-tables">Joining tables<a class="anchor" aria-label="anchor" href="#joining-tables"></a>
</h2>
<hr class="half-width">
<p>The following figure shows how these tables are related.</p>
<ul>
<li><p>The orange circles and arrows represent the first
<code>JOIN</code> operation, which takes each <code>source_id</code> in
the Gaia table and finds the same value of <code>source_id</code> in the
best neighbor table.</p></li>
<li><p>The blue circles and arrows represent the second
<code>JOIN</code> operation, which takes each
<code>original_ext_source_id</code> in the best neighbor table and finds
the same value of <code>obj_id</code> in the PanSTARRS photometry
table.</p></li>
</ul>
<p>There is no guarantee that the corresponding rows of these tables are
in the same order, so the <code>JOIN</code> operation involves some
searching. However, ADQL/SQL databases are implemented in a way that
makes this kind of search efficient. If you are curious, you can <a href="https://chartio.com/learn/databases/how-does-indexing-work/" class="external-link">read
more about it</a>.</p>
<figure><img src="../fig/join.png" alt="Diagram showing relationship between the gaia_source, panstarrs1_best_neighbour, and panstarrs1_original_valid tables and result table." class="figure mx-auto d-block"></figure><p>Now we will get to the details of performing a <code>JOIN</code>
operation.</p>
<p>We are about to build a complex query using software that doesn’t
provide us with any helpful information for debugging. For this reason
we are going to start with a simplified version of what we want to do
until we are sure we are joining the tables correctly, then we will
slowly add more layers of complexity, checking at each stage that our
query still works. As a starting place, we will go all the way back to
the cone search from episode 2.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>test_cone_query <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="st">TOP 10 </span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="st">source_id</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="st">WHERE 1=CONTAINS(</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="st">  POINT(ra, dec),</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="st">  CIRCLE(88.8, 7.4, 0.08333333))</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>And we will run it, to make sure we have a working query to build
on.</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>test_cone_job <span class="op">=</span> Gaia.launch_job(test_cone_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>test_cone_results <span class="op">=</span> test_cone_job.get_results()</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>test_cone_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=10&gt;
     source_id
       int64
-------------------
3322773965056065536
3322773758899157120
3322774068134271104
3322773930696320512
3322774377374425728
3322773724537891456
3322773724537891328
[Output truncated]</code></pre>
</div>
<p>Now we can start adding features. First, we will replace
<code>source_id</code> with the format specifier <code>columns</code> so
that we can alter what columns we want to return without having to
modify our base query:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>cone_base_query <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a><span class="st">WHERE 1=CONTAINS(</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a><span class="st">  POINT(ra, dec),</span></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a><span class="st">  CIRCLE(88.8, 7.4, 0.08333333))</span></span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>As a reminder, here are the columns we want from the Gaia table:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>columns <span class="op">=</span> <span class="st">'source_id, ra, dec, pmra, pmdec'</span></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>cone_query <span class="op">=</span> cone_base_query.<span class="bu">format</span>(columns<span class="op">=</span>columns)</span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a><span class="bu">print</span>(cone_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SELECT
source_id, ra, dec, pmra, pmdec
FROM gaiadr2.gaia_source
WHERE 1=CONTAINS(
  POINT(ra, dec),
  CIRCLE(88.8, 7.4, 0.08333333))</code></pre>
</div>
<p>We run the query again.</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>cone_job <span class="op">=</span> Gaia.launch_job_async(cone_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>cone_results <span class="op">=</span> cone_job.get_results()</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>cone_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=594&gt;
     source_id              ra        ...        pmdec
                           deg        ...       mas / yr
       int64             float64      ...       float64
------------------- ----------------- ... -------------------
3322773965056065536 88.78178020183375 ... -2.5057036964736907
3322773758899157120 88.83227057144585 ...                  --
3322774068134271104  88.8206092188033 ... -1.5260889445858044
3322773930696320512 88.80843339290348 ... -0.9292104395445717
3322774377374425728 88.86806108182265 ... -3.8676624830902435
3322773724537891456 88.81308602813434 ... -33.078133430952086
[Output truncated]</code></pre>
</div>
</section><section><h2 class="section-heading" id="adding-the-best-neighbor-table">Adding the best neighbor table<a class="anchor" aria-label="anchor" href="#adding-the-best-neighbor-table"></a>
</h2>
<hr class="half-width">
<p>Now we are ready for the first join. The join operation requires two
clauses:</p>
<ul>
<li><p><code>JOIN</code> specifies the name of the table we want to join
with, and</p></li>
<li><p><code>ON</code> specifies how we will match up rows between the
tables.</p></li>
</ul>
<p>In this example, we join with
<code>gaiadr2.panstarrs1_best_neighbour AS best</code>, which means we
can refer to the best neighbor table with the abbreviated name
<code>best</code>, which will save us a lot of typing. Similarly, we
will be referring to the <code>gaiadr2.gaia_source</code> table by the
abbreviated name <code>gaia</code>.</p>
<p>The <code>ON</code> clause indicates that we will match up the
<code>source_id</code> column from the Gaia table with the
<code>source_id</code> column from the best neighbor table.</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a>neighbours_base_query <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source AS gaia</span></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a><span class="st">JOIN gaiadr2.panstarrs1_best_neighbour AS best</span></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a><span class="st">  ON gaia.source_id = best.source_id</span></span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a><span class="st">WHERE 1=CONTAINS(</span></span>
<span id="cb37-7"><a href="#cb37-7" tabindex="-1"></a><span class="st">  POINT(gaia.ra, gaia.dec),</span></span>
<span id="cb37-8"><a href="#cb37-8" tabindex="-1"></a><span class="st">  CIRCLE(88.8, 7.4, 0.08333333))</span></span>
<span id="cb37-9"><a href="#cb37-9" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<div id="sql-detail" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="sql-detail" class="callout-inner">
<h3 class="callout-title">SQL detail</h3>
<div class="callout-content">
<p>In this example, the <code>ON</code> column has the same name in both
tables, so we could replace the <code>ON</code> clause with a simpler <a href="https://docs.oracle.com/javadb/10.8.3.0/ref/rrefsqljusing.html" class="external-link"><code>USING</code>clause</a>:</p>
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">SQL<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sql" tabindex="0"><code class="sourceCode sql"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a><span class="kw">USING</span>(source_id)</span></code></pre>
</div>
</div>
</div>
</div>
<p>Now that there is more than one table involved, we can’t use simple
column names any more; we have to use <strong>qualified column
names</strong>. In other words, we have to specify which table each
column is in. The column names do not have to be the same and, in fact,
in the next join they will not be. That is one of the reasons that we
explicitly specify them. Here is the complete query, including the
columns we want from the Gaia and best neighbor tables. Here you can
start to see that using the abbreviated names is making our query easier
to read and requires less typing for us. In addition to the spatial
coordinates and proper motion, we are going to return the
<code>best_neighbour_multiplicity</code> and
<code>number_of_mates</code> columns from the
<code>panstarrs1_best_neighbour</code> table in order to evaluate the
quality of the data that we are using by evaluating the number of
one-to-one matches between the catalogs. Recall that
<code>best_neighbour_multiplicity</code> tells us the number of
PanSTARRs objects that match a Gaia object and
<code>number_of_mates</code> tells us the number of Gaia objects that
match a PanSTARRs object.</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>column_list_neighbours <span class="op">=</span> [<span class="st">'gaia.source_id'</span>,</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>               <span class="st">'gaia.ra'</span>,</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>               <span class="st">'gaia.dec'</span>,</span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a>               <span class="st">'gaia.pmra'</span>,</span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a>               <span class="st">'gaia.pmdec'</span>,</span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a>               <span class="st">'best.best_neighbour_multiplicity'</span>,</span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a>               <span class="st">'best.number_of_mates'</span>,</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>              ]</span>
<span id="cb39-9"><a href="#cb39-9" tabindex="-1"></a>columns <span class="op">=</span> <span class="st">', '</span>.join(column_list_neighbours)</span>
<span id="cb39-10"><a href="#cb39-10" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" tabindex="-1"></a>neighbours_query <span class="op">=</span> neighbours_base_query.<span class="bu">format</span>(columns<span class="op">=</span>columns)</span>
<span id="cb39-12"><a href="#cb39-12" tabindex="-1"></a><span class="bu">print</span>(neighbours_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SELECT
gaia.source_id, gaia.ra, gaia.dec, gaia.pmra, gaia.pmdec, best.best_neighbour_multiplicity, best.number_of_mates
FROM gaiadr2.gaia_source AS gaia
JOIN gaiadr2.panstarrs1_best_neighbour AS best
  ON gaia.source_id = best.source_id
WHERE 1=CONTAINS(
  POINT(gaia.ra, gaia.dec),
  CIRCLE(88.8, 7.4, 0.08333333))</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>neighbours_job <span class="op">=</span> Gaia.launch_job_async(neighbours_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>neighbours_results <span class="op">=</span> neighbours_job.get_results()</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a>neighbours_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=490&gt;
     source_id              ra        ... number_of_mates
                           deg        ...
       int64             float64      ...      int16
------------------- ----------------- ... ---------------
3322773965056065536 88.78178020183375 ...               0
3322774068134271104  88.8206092188033 ...               0
3322773930696320512 88.80843339290348 ...               0
3322774377374425728 88.86806108182265 ...               0
3322773724537891456 88.81308602813434 ...               0
3322773724537891328 88.81570329208743 ...               0
[Output truncated]</code></pre>
</div>
<p>This result has fewer rows than the previous result. That is because
there are sources in the Gaia table with no corresponding source in the
Pan-STARRS table.</p>
<p>By default, the result of the join only includes rows where the same
<code>source_id</code> appears in both tables. This default is called an
“inner” join because the results include only the intersection of the
two tables. <a href="https://www.geeksforgeeks.org/sql-join-set-1-inner-left-right-and-full-joins/" class="external-link">You
can read about the other kinds of join here</a>.</p>
</section><section><h2 class="section-heading" id="adding-the-pan-starrs-table">Adding the Pan-STARRS table<a class="anchor" aria-label="anchor" href="#adding-the-pan-starrs-table"></a>
</h2>
<hr class="half-width">
<div id="exercise-15-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-15-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (15 minutes)</h3>
<div class="callout-content">
<p>Now we are ready to bring in the Pan-STARRS table. Starting with the
previous query, add a second <code>JOIN</code> clause that joins with
<code>gaiadr2.panstarrs1_original_valid</code>, gives it the abbreviated
name <code>ps</code>, and matches <code>original_ext_source_id</code>
from the best neighbor table with <code>obj_id</code> from the
Pan-STARRS table.</p>
<p>Add <code>g_mean_psf_mag</code> and <code>i_mean_psf_mag</code> to
the column list, and run the query. The result should contain 490 rows
and 9 columns.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a>join_solution_query_base <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source as gaia</span></span>
<span id="cb45-4"><a href="#cb45-4" tabindex="-1"></a><span class="st">JOIN gaiadr2.panstarrs1_best_neighbour as best</span></span>
<span id="cb45-5"><a href="#cb45-5" tabindex="-1"></a><span class="st">  ON gaia.source_id = best.source_id</span></span>
<span id="cb45-6"><a href="#cb45-6" tabindex="-1"></a><span class="st">JOIN gaiadr2.panstarrs1_original_valid as ps</span></span>
<span id="cb45-7"><a href="#cb45-7" tabindex="-1"></a><span class="st">  ON best.original_ext_source_id = ps.obj_id</span></span>
<span id="cb45-8"><a href="#cb45-8" tabindex="-1"></a><span class="st">WHERE 1=CONTAINS(</span></span>
<span id="cb45-9"><a href="#cb45-9" tabindex="-1"></a><span class="st">  POINT(gaia.ra, gaia.dec),</span></span>
<span id="cb45-10"><a href="#cb45-10" tabindex="-1"></a><span class="st">  CIRCLE(88.8, 7.4, 0.08333333))</span></span>
<span id="cb45-11"><a href="#cb45-11" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb45-12"><a href="#cb45-12" tabindex="-1"></a></span>
<span id="cb45-13"><a href="#cb45-13" tabindex="-1"></a>column_list <span class="op">=</span> [<span class="st">'gaia.source_id'</span>,</span>
<span id="cb45-14"><a href="#cb45-14" tabindex="-1"></a>               <span class="st">'gaia.ra'</span>,</span>
<span id="cb45-15"><a href="#cb45-15" tabindex="-1"></a>               <span class="st">'gaia.dec'</span>,</span>
<span id="cb45-16"><a href="#cb45-16" tabindex="-1"></a>               <span class="st">'gaia.pmra'</span>,</span>
<span id="cb45-17"><a href="#cb45-17" tabindex="-1"></a>               <span class="st">'gaia.pmdec'</span>,</span>
<span id="cb45-18"><a href="#cb45-18" tabindex="-1"></a>               <span class="st">'best.best_neighbour_multiplicity'</span>,</span>
<span id="cb45-19"><a href="#cb45-19" tabindex="-1"></a>               <span class="st">'best.number_of_mates'</span>,</span>
<span id="cb45-20"><a href="#cb45-20" tabindex="-1"></a>               <span class="st">'ps.g_mean_psf_mag'</span>,</span>
<span id="cb45-21"><a href="#cb45-21" tabindex="-1"></a>               <span class="st">'ps.i_mean_psf_mag'</span>]</span>
<span id="cb45-22"><a href="#cb45-22" tabindex="-1"></a></span>
<span id="cb45-23"><a href="#cb45-23" tabindex="-1"></a>columns <span class="op">=</span> <span class="st">', '</span>.join(column_list)</span>
<span id="cb45-24"><a href="#cb45-24" tabindex="-1"></a></span>
<span id="cb45-25"><a href="#cb45-25" tabindex="-1"></a>join_solution_query <span class="op">=</span> join_solution_query_base.<span class="bu">format</span>(columns<span class="op">=</span>columns)</span>
<span id="cb45-26"><a href="#cb45-26" tabindex="-1"></a><span class="bu">print</span>(join_solution_query)</span>
<span id="cb45-27"><a href="#cb45-27" tabindex="-1"></a></span>
<span id="cb45-28"><a href="#cb45-28" tabindex="-1"></a>join_solution_job <span class="op">=</span> Gaia.launch_job_async(join_solution_query)</span>
<span id="cb45-29"><a href="#cb45-29" tabindex="-1"></a>join_solution_results <span class="op">=</span> join_solution_job.get_results()</span>
<span id="cb45-30"><a href="#cb45-30" tabindex="-1"></a>join_solution_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=490&gt;
     source_id              ra        ...  g_mean_psf_mag   i_mean_psf_mag
                           deg        ...                        mag
       int64             float64      ...     float64          float64
------------------- ----------------- ... ---------------- ----------------
3322773965056065536 88.78178020183375 ... 19.9431991577148 17.4221992492676
3322774068134271104  88.8206092188033 ... 18.6212005615234 16.6007995605469
3322773930696320512 88.80843339290348 ...               -- 20.2203998565674
3322774377374425728 88.86806108182265 ... 18.0676002502441 16.9762001037598
3322773724537891456 88.81308602813434 ... 20.1907005310059 17.8700008392334
3322773724537891328 88.81570329208743 ... 22.6308002471924 19.6004009246826
[Output truncated]</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="selecting-by-coordinates-and-proper-motion">Selecting by coordinates and proper motion<a class="anchor" aria-label="anchor" href="#selecting-by-coordinates-and-proper-motion"></a>
</h2>
<hr class="half-width">
<p>We are now going to replace the cone search with the GD-1 selection
that we built in previous episodes. We will start by making sure that
our previous query works, then add in the <code>JOIN</code>. Now we will
bring in the <code>WHERE</code> clause from the previous episode, which
selects sources based on parallax, BP-RP color, sky coordinates, and
proper motion.</p>
<p>Here is <code>candidate_coord_pm_query_base</code> from the previous
episode.</p>
<div class="codewrapper sourceCode" id="cb47">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a>candidate_coord_pm_query_base <span class="op">=</span> <span class="st">"""SELECT </span></span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source</span></span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a><span class="st">WHERE parallax &lt; 1</span></span>
<span id="cb47-5"><a href="#cb47-5" tabindex="-1"></a><span class="st">  AND bp_rp BETWEEN -0.75 AND 2 </span></span>
<span id="cb47-6"><a href="#cb47-6" tabindex="-1"></a><span class="st">  AND 1 = CONTAINS(POINT(ra, dec), </span></span>
<span id="cb47-7"><a href="#cb47-7" tabindex="-1"></a><span class="st">                   POLYGON(</span><span class="sc">{sky_point_list}</span><span class="st">))</span></span>
<span id="cb47-8"><a href="#cb47-8" tabindex="-1"></a><span class="st">  AND pmra BETWEEN </span><span class="sc">{pmra_min}</span><span class="st"> AND  </span><span class="sc">{pmra_max}</span></span>
<span id="cb47-9"><a href="#cb47-9" tabindex="-1"></a><span class="st">  AND pmdec BETWEEN </span><span class="sc">{pmdec_min}</span><span class="st"> AND </span><span class="sc">{pmdec_max}</span></span>
<span id="cb47-10"><a href="#cb47-10" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>Now we can assemble the query using the sky point list and proper
motion range we compiled in episode 5.</p>
<div class="codewrapper sourceCode" id="cb48">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a>columns <span class="op">=</span> <span class="st">'source_id, ra, dec, pmra, pmdec'</span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a>candidate_coord_pm_query <span class="op">=</span> candidate_coord_pm_query_base.<span class="bu">format</span>(columns<span class="op">=</span>columns,</span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a>                            sky_point_list<span class="op">=</span>sky_point_list,</span>
<span id="cb48-5"><a href="#cb48-5" tabindex="-1"></a>                            pmra_min<span class="op">=</span>pmra_min,</span>
<span id="cb48-6"><a href="#cb48-6" tabindex="-1"></a>                            pmra_max<span class="op">=</span>pmra_max,</span>
<span id="cb48-7"><a href="#cb48-7" tabindex="-1"></a>                            pmdec_min<span class="op">=</span>pmdec_min,</span>
<span id="cb48-8"><a href="#cb48-8" tabindex="-1"></a>                            pmdec_max<span class="op">=</span>pmdec_max)</span>
<span id="cb48-9"><a href="#cb48-9" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" tabindex="-1"></a><span class="bu">print</span>(candidate_coord_pm_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SELECT
source_id, ra, dec, pmra, pmdec
FROM gaiadr2.gaia_source
WHERE parallax &lt; 1
  AND bp_rp BETWEEN -0.75 AND 2
  AND 1 = CONTAINS(POINT(ra, dec),
                   POLYGON(135.306, 8.39862, 126.51, 13.4449, 163.017, 54.2424, 172.933, 46.4726, 135.306, 8.39862))
  AND pmra BETWEEN -6.70 AND -3
  AND pmdec BETWEEN -14.31 AND -11.2</code></pre>
</div>
<p>We run it to make sure we are starting with a working query.</p>
<div class="codewrapper sourceCode" id="cb50">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a>candidate_coord_pm_job <span class="op">=</span> Gaia.launch_job_async(candidate_coord_pm_query)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>INFO: Query finished. [astroquery.utils.tap.core]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb52">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a>candidate_coord_pm_results <span class="op">=</span> candidate_coord_pm_job.get_results()</span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a>candidate_coord_pm_results</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Table length=8409&gt;
    source_id              ra         ...        pmdec
                          deg         ...       mas / yr
      int64             float64       ...       float64
------------------ ------------------ ... -------------------
635559124339440000 137.58671691646745 ... -12.490481778113859
635860218726658176  138.5187065217173 ... -11.346409129876392
635674126383965568  138.8428741026386 ... -12.702779525389634
635535454774983040  137.8377518255436 ... -14.492308604905652
635497276810313600  138.0445160213759 ... -12.291499169815987
635614168640132864 139.59219748145836 ... -13.708904908478631
[Output truncated]</code></pre>
</div>
<div id="exercise-15-minutes-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-15-minutes-1" class="callout-inner">
<h3 class="callout-title">Exercise (15 minutes)</h3>
<div class="callout-content">
<p>Create a new query base called <code>candidate_join_query_base</code>
that combines the <code>WHERE</code> clauses from the previous query
with the <code>JOIN</code> clauses for the best neighbor and Pan-STARRS
tables. Format the query base using the column names in
<code>column_list</code>, and call the result
<code>candidate_join_query</code>.</p>
<p>Hint: Make sure you use qualified column names everywhere!</p>
<p>Run your query and download the results. The table you get should
have 4300 rows and 9 columns.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb54">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a>candidate_join_query_base <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a><span class="st">SELECT </span></span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a><span class="sc">{columns}</span></span>
<span id="cb54-4"><a href="#cb54-4" tabindex="-1"></a><span class="st">FROM gaiadr2.gaia_source as gaia</span></span>
<span id="cb54-5"><a href="#cb54-5" tabindex="-1"></a><span class="st">JOIN gaiadr2.panstarrs1_best_neighbour as best</span></span>
<span id="cb54-6"><a href="#cb54-6" tabindex="-1"></a><span class="st">  ON gaia.source_id = best.source_id</span></span>
<span id="cb54-7"><a href="#cb54-7" tabindex="-1"></a><span class="st">JOIN gaiadr2.panstarrs1_original_valid as ps</span></span>
<span id="cb54-8"><a href="#cb54-8" tabindex="-1"></a><span class="st">  ON best.original_ext_source_id = ps.obj_id</span></span>
<span id="cb54-9"><a href="#cb54-9" tabindex="-1"></a><span class="st">WHERE parallax &lt; 1</span></span>
<span id="cb54-10"><a href="#cb54-10" tabindex="-1"></a><span class="st">  AND bp_rp BETWEEN -0.75 AND 2 </span></span>
<span id="cb54-11"><a href="#cb54-11" tabindex="-1"></a><span class="st">  AND 1 = CONTAINS(POINT(gaia.ra, gaia.dec), </span></span>
<span id="cb54-12"><a href="#cb54-12" tabindex="-1"></a><span class="st">                   POLYGON(</span><span class="sc">{sky_point_list}</span><span class="st">))</span></span>
<span id="cb54-13"><a href="#cb54-13" tabindex="-1"></a><span class="st">  AND gaia.pmra BETWEEN </span><span class="sc">{pmra_min}</span><span class="st"> AND  </span><span class="sc">{pmra_max}</span></span>
<span id="cb54-14"><a href="#cb54-14" tabindex="-1"></a><span class="st">  AND gaia.pmdec BETWEEN </span><span class="sc">{pmdec_min}</span><span class="st"> AND </span><span class="sc">{pmdec_max}</span></span>
<span id="cb54-15"><a href="#cb54-15" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb54-16"><a href="#cb54-16" tabindex="-1"></a></span>
<span id="cb54-17"><a href="#cb54-17" tabindex="-1"></a>columns <span class="op">=</span> <span class="st">', '</span>.join(column_list)</span>
<span id="cb54-18"><a href="#cb54-18" tabindex="-1"></a></span>
<span id="cb54-19"><a href="#cb54-19" tabindex="-1"></a>candidate_join_query <span class="op">=</span> candidate_join_query_base.<span class="bu">format</span>(columns<span class="op">=</span>columns,</span>
<span id="cb54-20"><a href="#cb54-20" tabindex="-1"></a>                            sky_point_list<span class="op">=</span> sky_point_list,</span>
<span id="cb54-21"><a href="#cb54-21" tabindex="-1"></a>                            pmra_min<span class="op">=</span>pmra_min,</span>
<span id="cb54-22"><a href="#cb54-22" tabindex="-1"></a>                            pmra_max<span class="op">=</span>pmra_max,</span>
<span id="cb54-23"><a href="#cb54-23" tabindex="-1"></a>                            pmdec_min<span class="op">=</span>pmdec_min,</span>
<span id="cb54-24"><a href="#cb54-24" tabindex="-1"></a>                            pmdec_max<span class="op">=</span>pmdec_max)</span>
<span id="cb54-25"><a href="#cb54-25" tabindex="-1"></a><span class="bu">print</span>(candidate_join_query)</span>
<span id="cb54-26"><a href="#cb54-26" tabindex="-1"></a></span>
<span id="cb54-27"><a href="#cb54-27" tabindex="-1"></a></span>
<span id="cb54-28"><a href="#cb54-28" tabindex="-1"></a>candidate_join_job <span class="op">=</span> Gaia.launch_job_async(candidate_join_query)</span>
<span id="cb54-29"><a href="#cb54-29" tabindex="-1"></a>candidate_table <span class="op">=</span> candidate_join_job.get_results()</span>
<span id="cb54-30"><a href="#cb54-30" tabindex="-1"></a>candidate_table</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="checking-the-match">Checking the match<a class="anchor" aria-label="anchor" href="#checking-the-match"></a>
</h2>
<hr class="half-width">
<p>To get more information about the matching process, we can inspect
<code>best_neighbour_multiplicity</code>, which indicates for each star
in Gaia how many stars in Pan-STARRS are equally likely matches.</p>
<div class="codewrapper sourceCode" id="cb55">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a>candidate_table[<span class="st">'best_neighbour_multiplicity'</span>]</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;MaskedColumn name='best_neighbour_multiplicity' dtype='int16' description='Number of neighbours with same probability as best neighbour' length=4300&gt;
  1
  1
  1
  1
  1
  1
  1
  1
  1
  1
[Output truncated]</code></pre>
</div>
<p>Most of the values are <code>1</code>, which is good; that means that
for each candidate star we have identified exactly one source in
Pan-STARRS that is likely to be the same star.</p>
<p>To check whether there are any values other than <code>1</code>, we
can convert this column to a Pandas <code>Series</code> and use
<code>describe</code>, which we saw in in episode 3.</p>
<div class="codewrapper sourceCode" id="cb57">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a>multiplicity <span class="op">=</span> pd.Series(candidate_table[<span class="st">'best_neighbour_multiplicity'</span>])</span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a>multiplicity.describe()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>count    4300.0
mean        1.0
std         0.0
min         1.0
25%         1.0
50%         1.0
75%         1.0
max         1.0
dtype: float64</code></pre>
</div>
<p>In fact, <code>1</code> is the only value in the <code>Series</code>,
so every candidate star has a single best match.</p>
<div id="numpy-mask-warning" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="numpy-mask-warning" class="callout-inner">
<h3 class="callout-title">Numpy Mask Warning</h3>
<div class="callout-content">
<p>You may see a warning that ends with the following phrase:</p>
<p><code>site-packages/numpy/lib/function_base.py:4650:</code></p>
<p><code>UserWarning: Warning: 'partition' will ignore the 'mask' of the MaskedColumn.</code>
<code>arr.partition(</code></p>
<p>This is because astroquery is returning a table with masked columns
(which are really fancy masked numpy arrays). When we turn this column
into a pandas Series, it maintains its mask. Describe calls numpy
functions to perform statistics. Numpy recently implemented this warning
to let you know that the mask is not being considered in the calculation
its performing.</p>
</div>
</div>
</div>
<p>Similarly, <code>number_of_mates</code> indicates the number of
<em>other</em> stars in Gaia that match with the same star in
Pan-STARRS.</p>
<div class="codewrapper sourceCode" id="cb59">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a>mates <span class="op">=</span> pd.Series(candidate_table[<span class="st">'number_of_mates'</span>])</span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a>mates.describe()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>count    4300.0
mean        0.0
std         0.0
min         0.0
25%         0.0
50%         0.0
75%         0.0
max         0.0
dtype: float64</code></pre>
</div>
<p>All values in this column are <code>0</code>, which means that for
each match we found in Pan-STARRS, there are no other stars in Gaia that
also match.</p>
</section><section><h2 class="section-heading" id="saving-the-dataframe">Saving the DataFrame<a class="anchor" aria-label="anchor" href="#saving-the-dataframe"></a>
</h2>
<hr class="half-width">
<p>We can make a <code>DataFrame</code> from our Astropy
<code>Table</code> and save our results so we can pick up where we left
off without running this query again. Once again, we will make use of
our <code>make_dataframe</code> function.</p>
<div class="codewrapper sourceCode" id="cb61">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a>candidate_df <span class="op">=</span> make_dataframe(candidate_table)</span></code></pre>
</div>
<p>The HDF5 file should already exist, so we’ll add
<code>candidate_df</code> to it.</p>
<div class="codewrapper sourceCode" id="cb62">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_data.hdf'</span></span>
<span id="cb62-2"><a href="#cb62-2" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" tabindex="-1"></a>candidate_df.to_hdf(filename, <span class="st">'candidate_df'</span>)</span></code></pre>
</div>
<p>We can use <code>getsize</code> to confirm that the file exists and
check the size:</p>
<div class="codewrapper sourceCode" id="cb63">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a><span class="im">from</span> os.path <span class="im">import</span> getsize</span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" tabindex="-1"></a>MB <span class="op">=</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span></span>
<span id="cb63-4"><a href="#cb63-4" tabindex="-1"></a>getsize(filename) <span class="op">/</span> MB</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">15.422508239746094</span></span></code></pre>
</div>
</section><section><h2 class="section-heading" id="another-file-format---csv">Another file format - CSV<a class="anchor" aria-label="anchor" href="#another-file-format---csv"></a>
</h2>
<hr class="half-width">
<p>Pandas can write a variety of other formats, <a href="https://pandas.pydata.org/pandas-docs/stable/user_guide/io.html" class="external-link">which
you can read about here</a>. We won’t cover all of them, but one other
important one is <a href="https://en.wikipedia.org/wiki/Comma-separated_values" class="external-link">CSV</a>,
which stands for “comma-separated values”.</p>
<p>CSV is a plain-text format that can be read and written by pretty
much any tool that works with data. In that sense, it is the “least
common denominator” of data formats.</p>
<p>However, it has an important limitation: some information about the
data gets lost in translation, notably the data types. If you read a CSV
file from someone else, you might need some additional information to
make sure you are getting it right.</p>
<p>Also, CSV files tend to be big, and slow to read and write.</p>
<p>With those caveats, here is how to write one:</p>
<div class="codewrapper sourceCode" id="cb65">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a>candidate_df.to_csv(<span class="st">'gd1_data.csv'</span>)</span></code></pre>
</div>
<p>We can check the file size like this:</p>
<div class="codewrapper sourceCode" id="cb66">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a>getsize(<span class="st">'gd1_data.csv'</span>) <span class="op">/</span> MB</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">0.8787498474121094</span></span></code></pre>
</div>
<p>We can read the CSV file back like this:</p>
<div class="codewrapper sourceCode" id="cb68">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a>read_back_csv <span class="op">=</span> pd.read_csv(<span class="st">'gd1_data.csv'</span>)</span></code></pre>
</div>
<p>We will compare the first few rows of <code>candidate_df</code> and
<code>read_back_csv</code></p>
<div class="codewrapper sourceCode" id="cb69">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a>candidate_df.head(<span class="dv">3</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>            source_id          ra        dec      pmra      pmdec  \
0  635860218726658176  138.518707  19.092339 -5.941679 -11.346409
1  635674126383965568  138.842874  19.031798 -3.897001 -12.702780
2  635535454774983040  137.837752  18.864007 -4.335041 -14.492309

   best_neighbour_multiplicity  number_of_mates  g_mean_psf_mag  \
0                            1                0         17.8978
1                            1                0         19.2873
2                            1                0         16.9238

   i_mean_psf_mag       phi1      phi2   pm_phi1   pm_phi2
[Output truncated]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb71">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a>read_back_csv.head(<span class="dv">3</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   Unnamed: 0           source_id          ra        dec      pmra      pmdec  \
0           0  635860218726658176  138.518707  19.092339 -5.941679 -11.346409
1           1  635674126383965568  138.842874  19.031798 -3.897001 -12.702780
2           2  635535454774983040  137.837752  18.864007 -4.335041 -14.492309

   best_neighbour_multiplicity  number_of_mates  g_mean_psf_mag  \
0                            1                0         17.8978
1                            1                0         19.2873
2                            1                0         16.9238

   i_mean_psf_mag       phi1      phi2   pm_phi1   pm_phi2
[Output truncated]</code></pre>
</div>
<p>The CSV file contains the names of the columns, but not the data
types. A keen observer may note that the <code>dataframe</code> that we
wrote to the CSV file did not contain data types, so it is unsurprising
that the CSV file also does not. However, even if we had written a CSV
file from an astropy <code>Table</code>, which does contain data type,
data type would not appear in the CSV file, highlighting a limitation of
this format. Additionally, notice that the index in
<code>candidate_df</code> has become an unnamed column in
<code>read_back_csv</code> and a new index has been created. The Pandas
functions for writing and reading CSV files provide options to avoid
that problem, but this is an example of the kind of thing that can go
wrong with CSV files.</p>
</section><section><h2 class="section-heading" id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<hr class="half-width">
<p>In this episode, we used database <code>JOIN</code> operations to
select photometry data for the stars we’ve identified as candidates to
be in GD-1.</p>
<p>In the next episode, we will use this data for a second round of
selection, identifying stars that have photometry data consistent with
GD-1.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<span class="callout-header">Key Points</span>
<div class="callout-inner">
<div class="callout-content">
<ul>
<li>Use <code>JOIN</code> operations to combine data from multiple
tables in a database, using some kind of identifier to match up records
from one table with records from another. This is another example of a
practice we saw in the previous notebook, moving the computation to the
data.</li>
<li>For most applications, saving data in FITS or HDF5 is better than
CSV. FITS and HDF5 are binary formats, so the files are usually smaller,
and they store metadata, so you don’t lose anything when you read the
file back.</li>
<li>On the other hand, CSV is a ‘least common denominator’ format; that
is, it can be read by practically any application that works with
data.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-07-photo"><p>Content from <a href="07-photo.html">Photometry</a></p>
<hr>
<p>Last updated on 2024-03-08 |

        <a href="https://github.com/datacarpentry/astronomy-python/edit/main/episodes/07-photo.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 40 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do we use Matplotlib to define a polygon and select points that
fall inside it?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Use isochrone data to specify a polygon and determine which points
fall inside it.</li>
<li>Use Matplotlib features to customize the appearance of figures.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>In the previous episode we downloaded photometry data from
Pan-STARRS, which is available from the same server we have been using
to get Gaia data.</p>
<p>The next step in the analysis is to select candidate stars based on
the photometry data. The following figure from the paper is a
color-magnitude diagram showing the stars we previously selected based
on proper motion:</p>
<figure><img width="300" src="../fig/gd1-3.png" alt="Color-magnitude diagram for the stars selected based on proper motion, from Price-Whelan and Bonaca paper." class="figure mx-auto d-block"></figure><p>In red is a <a href="https://en.wikipedia.org/wiki/Stellar_isochrone" class="external-link">theoretical
isochrone</a>, showing where we expect the stars in GD-1 to fall based
on the metallicity and age of their original globular cluster.</p>
<p>By selecting stars in the shaded area, we can further distinguish the
main sequence of GD-1 from mostly younger background stars.</p>
<div id="outline" class="callout checklist">
<div class="callout-square">
<i class="callout-icon" data-feather="check-square"></i>
</div>
<span class="callout-header">Checklist</span>
<div id="outline" class="callout-inner">
<h3 class="callout-title">Outline</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li><p>We will reload the data from the previous episode and make a
color-magnitude diagram.</p></li>
<li><p>We will use an isochrone computed by MIST to specify a polygonal
region in the color-magnitude diagram and select the stars inside of
it.</p></li>
</ol>
</div>
</div>
</div>
<div id="starting-from-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<span class="callout-header">Prerequisite</span>
<div id="starting-from-this-episode" class="callout-inner">
<h3 class="callout-title">Starting from this episode</h3>
<div class="callout-content">
<p>If you are starting a new notebook for this episode, expand this
section for information you will need to get started.</p>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> Read me </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" aria-labelledby="headingSpoiler1" data-bs-parent="#accordionSpoiler1">
<div class="accordion-body">
<p>In the previous episode, we selected stars in GD-1 based on proper
motion and downloaded the spatial, proper motion, and photometry
information by joining the Gaia and PanSTARRs datasets. We will use that
data for this episode. Whether you are working from a new notebook or
coming back from a checkpoint, reloading the data will save you from
having to run the query again.</p>
<p>If you are starting this episode here or starting this episode in a
new notebook, you will need run the following lines of code.</p>
<p>This imports previously imported functions:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">from</span> os.path <span class="im">import</span> getsize</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="im">from</span> episode_functions <span class="im">import</span> <span class="op">*</span></span></code></pre>
</div>
<p>The following code loads in the data (instructions for downloading
data can be found in the <a href="index.html#setup">setup instructions</a>).
You may need to add a the path to the filename variable below
(e.g. <code>filename = 'student_download/backup-data/gd1_data.hdf'</code>)</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_data.hdf'</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>candidate_df <span class="op">=</span> pd.read_hdf(filename, <span class="st">'candidate_df'</span>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="plotting-photometry-data">Plotting photometry data<a class="anchor" aria-label="anchor" href="#plotting-photometry-data"></a>
</h2>
<hr class="half-width">
<p>Now that we have photometry data from Pan-STARRS, we can produce a <a href="https://coolwiki.ipac.caltech.edu/index.php/Color-Magnitude_and_Color-Color_plots_Overview" class="external-link">color-magnitude
diagram</a> to replicate the diagram from the original paper:</p>
<figure><img width="300" src="../fig/gd1-3.png" alt="Color-magnitude diagram for the stars selected based on proper motion, from Price-Whelan and Bonaca paper." class="figure mx-auto d-block"></figure><p>The y-axis shows the apparent magnitude of each source with the <a href="https://en.wikipedia.org/wiki/Photometric_system" class="external-link">g
filter</a>.</p>
<p>The x-axis shows the difference in apparent magnitude between the g
and i filters, which indicates color.</p>
<div id="a-slight-detour-for-non-domain-experts" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<span class="callout-header">Discussion</span>
<div id="a-slight-detour-for-non-domain-experts" class="callout-inner">
<h3 class="callout-title">A slight detour for non-domain experts</h3>
<div class="callout-content">
<p>If you are wondering (as a non-domain expert) how to interpret this
color-magnitude diagram, please expand the section below.</p>
<div id="accordionSpoiler2" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler2" aria-expanded="false" aria-controls="collapseSpoiler2">
  <h3 class="accordion-header" id="headingSpoiler2">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> The color magnitude diagram of GD-1 and foreground stars </h3>
</button>
<div id="collapseSpoiler2" class="accordion-collapse collapse" aria-labelledby="headingSpoiler2" data-bs-parent="#accordionSpoiler2">
<div class="accordion-body">
<p>As a pathologist can easily point to tumor on a biopsy slide, so too
can astronomers who study stellar populations see two stellar main
groups of stars in this color magnitude diagram, one from an old star
cluster (presumably, GD-1), and the other, stars much closer, but at
every distance between the Earth and the cluster (“foreground”). The
color magnitude diagram is a technique developed to separate these
features out just as pathologists have techniques to contrast human
tissue. The color of a star is primarily related to the star’s surface
temperature, with bluer stars indicating higher temperatures and redder
stars indicating lower temperatures. This logic is not too far off from
the color at the bottom of a match flame compared to the top.</p>
<p>Foreground Stars: To know the temperature of a star, you first need
to know its distance and to account for the dust between us and the
star. You can guess the effect of distance. A star farther away will be
fainter (lower y-axis value) than the same star closer (think of car
headlights as they approach). Dust will remove light from the star’s
path to our telescopes, which makes the star seem like it has less
energy than it otherwise would have, which makes it do two things on
this diagram: 1) look fainter (lower on the y-axis; larger magnitude
value) and 2) look cooler (higher x-axis value). The stars spread
throughout the diagram are all stars bright enough to be detected in our
Milky Way between GD-1 and us but made fainter and redder (spread to the
lower-right) by their spread in distance from us and the amount dust in
the line of sight.</p>
<p>GD-1: The pile up of stars in the lower-left quadrant of this diagram
are interesting because it suggests something is at the same distance
with the same amount of dust in the way. When we use our knowledge of
theoretical astrophysics (independently calculated outside this work) to
estimate how bright a population of old stars would be if it were at the
distance of GD-1, we get that solid red line. The exact values of age
and metallicity ([Fe/H] value) is a variable needed to reproduce the
theoretical isochrone, but frankly, the choice could vary a lot and
still would fit the data well.</p>
<p><a href="https://spiff.rit.edu/classes/ladder/lectures/ordinary_stars/ordinary.html" class="external-link">More
on color-magnitude diagrams and their theoretical counterpart,
here.</a></p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>With the photometry we downloaded from the PanSTARRS table into
<code>candidate_df</code> we can now recreate this plot.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>x <span class="op">=</span> candidate_df[<span class="st">'g_mean_psf_mag'</span>] <span class="op">-</span> candidate_df[<span class="st">'i_mean_psf_mag'</span>]</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>y <span class="op">=</span> candidate_df[<span class="st">'g_mean_psf_mag'</span>]</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.3</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>plt.ylabel(<span class="st">'Magnitude (g)'</span>)</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>plt.xlabel(<span class="st">'Color (g-i)'</span>)</span></code></pre>
</div>
<figure><img src="../fig/07-photo_files/07-cmd_no_lims.png" alt="Color magnitude diagram of our selected stars showing all of the stars selected" class="figure mx-auto d-block"></figure><p>We have assigned the color and magnitude to variables <code>x</code>
and <code>y</code>, respectively.<br>
We have done this out of convenience and to keep the code readable since
the table variables and column names are long and <code>x</code>
includes an operation between two columns.</p>
<p>We can zoom in on the region of interest by setting the range of x
and y values displayed with the <code>xlim</code> and <code>ylim</code>
functions. If we put the higher value first in the <code>ylim</code>
call, this will invert the y-axis, putting fainter magnitudes at the
bottom.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>x <span class="op">=</span> candidate_df[<span class="st">'g_mean_psf_mag'</span>] <span class="op">-</span> candidate_df[<span class="st">'i_mean_psf_mag'</span>]</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>y <span class="op">=</span> candidate_df[<span class="st">'g_mean_psf_mag'</span>]</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.3</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>plt.ylabel(<span class="st">'Magnitude (g)'</span>)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>plt.xlabel(<span class="st">'Color (g-i)'</span>)</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>plt.xlim([<span class="dv">0</span>, <span class="fl">1.5</span>])</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>plt.ylim([<span class="dv">22</span>, <span class="dv">14</span>])</span></code></pre>
</div>
<figure><img src="../fig/07-photo_files/07-cmd_lims.png" alt="Color magnitude diagram of our selected stars showing overdense region in lower left." class="figure mx-auto d-block"></figure><p>Our figure does not look exactly like the one in the paper because we
are working with a smaller region of the sky, so we have fewer stars.
But the main sequence of GD-1 appears as an overdense region in the
lower left.</p>
<p>We want to be able to make this plot again, with any selection of
PanSTARRs photometry, so this is a natural time to put it into a
function that accepts as input an Astropy <code>Table</code> or Pandas
<code>DataFrame</code>, as long as it has columns named
<code>g_mean_psf_mag</code> and <code>i_mean_psf_mag</code>. To do this
we will change our variable name from <code>candidate_df</code> to the
more generic <code>dataframe</code>.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">def</span> plot_cmd(dataframe):</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    <span class="co">"""Plot a color magnitude diagram.</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">    dataframe: DataFrame or Table with photometry data</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    y <span class="op">=</span> dataframe[<span class="st">'g_mean_psf_mag'</span>]</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    x <span class="op">=</span> dataframe[<span class="st">'g_mean_psf_mag'</span>] <span class="op">-</span> dataframe[<span class="st">'i_mean_psf_mag'</span>]</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.3</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>    plt.xlim([<span class="dv">0</span>, <span class="fl">1.5</span>])</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>    plt.ylim([<span class="dv">22</span>, <span class="dv">14</span>])</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>    plt.ylabel(<span class="st">'Magnitude (g)'</span>)</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>    plt.xlabel(<span class="st">'Color (g-i)'</span>)</span></code></pre>
</div>
<p>Here are the results:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>plot_cmd(candidate_df)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/07-photo_files/07-photo_12_0.png" alt="Color magnitude diagram of our selected stars showing overdense region in lower left." class="figure mx-auto d-block"></figure><p>In the next section we will use an isochrone to specify a polygon
that contains this overdense region.</p>
</section><section><h2 class="section-heading" id="isochrone">Isochrone<a class="anchor" aria-label="anchor" href="#isochrone"></a>
</h2>
<hr class="half-width">
<p>Given our understanding of the age, metallicity, and distance to GD-1
we can overlay a theoretical isochrone for GD-1 from the MESA Isochrones
and Stellar Tracks and better identify the main sequence of GD-1.</p>
<div id="calculating-isochrone" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="calculating-isochrone" class="callout-inner">
<h3 class="callout-title">Calculating Isochrone</h3>
<div class="callout-content">
<p>In fact, we can use <a href="https://waps.cfa.harvard.edu/MIST/" class="external-link">MESA
Isochrones &amp; Stellar Tracks</a> (MIST) to compute it for us. Using
the <a href="https://waps.cfa.harvard.edu/MIST/interp_isos.html" class="external-link">MIST
Version 1.2 web interface</a>, we computed an isochrone with the
following parameters:</p>
<ul>
<li>Rotation initial v/v_crit = 0.4</li>
<li>Single age, linear scale = 12e9</li>
<li>Composition [Fe/H] = -1.35</li>
<li>Synthetic Photometry, PanStarrs</li>
<li>Extinction av = 0</li>
</ul>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="making-a-polygon">Making a polygon<a class="anchor" aria-label="anchor" href="#making-a-polygon"></a>
</h2>
<hr class="half-width">
<p>The MIST isochrone files available on the website above can not be
directly plotted over our data. We have selected the relevant part of
the isochrone, the filters we are interested in, and scaled the
photometry to the distance of GD-1 (<a href="calculating_MIST_isochrone.html">details here</a>). Now we can
read in the results which you downloaded as part of the <a href="index.html#setup">setup instructions</a>:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_isochrone.hdf5'</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>iso_df <span class="op">=</span> pd.read_hdf(filename, <span class="st">'iso_df'</span>)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>iso_df.head()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>       mag_g  color_g_i
0  28.294743   2.195021
1  28.189718   2.166076
2  28.051761   2.129312
3  27.916194   2.093721
4  27.780024   2.058585</code></pre>
</div>
<p>Here is what the isochrone looks like on the color-magnitude
diagram.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>plot_cmd(candidate_df)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>plt.plot(iso_df[<span class="st">'color_g_i'</span>], iso_df[<span class="st">'mag_g'</span>])<span class="op">;</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/07-photo_files/07-photo_52_0.png" alt="Color magnitude diagram of our selected stars with theoretical isochrone overlaid as blue curve." class="figure mx-auto d-block"></figure><p>In the bottom half of the figure, the isochrone passes through the
overdense region where the stars are likely to belong to GD-1.</p>
<p>Although some stars near the top half of the isochrone likely belong
to GD-1, these represent stars that have evolved off the main sequence.
The density of GD-1 stars in this region is therefore much less and the
contamination with other stars much greater. So to get the purest sample
of GD-1 stars we will select only stars on the main sequence.</p>
<p>So we will select the part of the isochrone that lies in the
overdense region.</p>
<p><code>g_mask</code> is a Boolean Series that is <code>True</code>
where <code>g</code> is between 18.0 and 21.5.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>g_all <span class="op">=</span> iso_df[<span class="st">'mag_g'</span>]</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>g_mask <span class="op">=</span> (g_all <span class="op">&gt;</span> <span class="fl">18.0</span>) <span class="op">&amp;</span> (g_all <span class="op">&lt;</span> <span class="fl">21.5</span>)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>g_mask.<span class="bu">sum</span>()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">117</span></span></code></pre>
</div>
<p>We can use it to select the corresponding rows in
<code>iso_df</code>:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>iso_masked <span class="op">=</span> iso_df[g_mask]</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>iso_masked.head()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>        mag_g  color_g_i
94  21.411746   0.692171
95  21.322466   0.670238
96  21.233380   0.648449
97  21.144427   0.626924
98  21.054549   0.605461</code></pre>
</div>
<p>Now, to select the stars in the overdense region, we have to define a
polygon that includes stars near the isochrone.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>g <span class="op">=</span> iso_masked[<span class="st">'mag_g'</span>]</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>left_color <span class="op">=</span> iso_masked[<span class="st">'color_g_i'</span>] <span class="op">-</span> <span class="fl">0.06</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>right_color <span class="op">=</span> iso_masked[<span class="st">'color_g_i'</span>] <span class="op">+</span> <span class="fl">0.12</span></span></code></pre>
</div>
<p>Here is our plot with these boundaries:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>plot_cmd(candidate_df)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>plt.plot(left_color, g, label<span class="op">=</span><span class="st">'left color'</span>)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>plt.plot(right_color, g, label<span class="op">=</span><span class="st">'right color'</span>)</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/07-photo_files/07-photo_62_0.png" alt="Color magnitude diagram of our selected stars showing left boundary as blue curve and right boundary as orange curve." class="figure mx-auto d-block"></figure></section><section><h2 class="section-heading" id="which-points-are-in-the-polygon">Which points are in the polygon?<a class="anchor" aria-label="anchor" href="#which-points-are-in-the-polygon"></a>
</h2>
<hr class="half-width">
<p>Matplotlib provides a <code>Polygon</code> object that we can use to
check which points fall in the polygon we just constructed.</p>
<p>To make a <code>Polygon</code>, we need to assemble <code>g</code>,
<code>left_color</code>, and <code>right_color</code> into a loop, so
the points in <code>left_color</code> are connected to the points of
<code>right_color</code> in reverse order.</p>
<p>We will use a “slice index” to reverse the elements of
<code>right_color</code>. As explained in the <a href="https://numpy.org/doc/stable/reference/arrays.indexing.html" class="external-link">NumPy
documentation</a>, a slice index has three parts separated by
colons:</p>
<ul>
<li><p><code>start</code>: The index of the element where the slice
starts.</p></li>
<li><p><code>stop</code>: The index of the element where the slice
ends.</p></li>
<li><p><code>step</code>: The step size between elements.</p></li>
</ul>
<pre><code>reverse_right_color = right_color[::-1]</code></pre>
<p>{:.language-python}</p>
<p>In this example, <code>start</code> and <code>stop</code> are
omitted, which means all elements are selected.</p>
<p>And <code>step</code> is <code>-1</code>, which means the elements
are in reverse order.</p>
<p>To combine the <code>left_color</code> and <code>right_color</code>
arrays we will use the NumPy <code>append</code> function which takes
two arrays as input, and outputs them combined into a single array.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>color_loop <span class="op">=</span> np.append(left_color, reverse_right_color)</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>color_loop.shape</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>(234,)</code></pre>
</div>
<p>We can repeat combine these two lines of code into a single line to
create a corresponding loop with the elements of <code>g</code> in
forward and reverse order.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>mag_loop <span class="op">=</span> np.append(g, g[::<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>mag_loop.shape</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>(234,)</code></pre>
</div>
<p>Here is the loop on our plot:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>plot_cmd(candidate_df)</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>plt.plot(color_loop, mag_loop)<span class="op">;</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/07-photo_files/07-photo_70_0.png" alt="Color magnitude diagram of our selected stars showing polygon defined by boundaries as blue curve." class="figure mx-auto d-block"></figure><p>To make a <code>Polygon</code>, it will be useful to put
<code>color_loop</code> and <code>mag_loop</code> into a
<code>DataFrame</code>. This is convenient for two reasons - first,
<code>Polygon</code> is expecting an Nx2 array and the
<code>DataFrame</code> provides an easy way for us to pass that in that
is also descriptive for us. Secondly, for reproducibility of our work,
we may want to save the region we use to select stars, and the
<code>DataFrame</code>, as we have already seen, allows us to save into
a variety of formats.</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>loop_df <span class="op">=</span> pd.DataFrame()</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>loop_df[<span class="st">'color_loop'</span>] <span class="op">=</span> color_loop</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>loop_df[<span class="st">'mag_loop'</span>] <span class="op">=</span> mag_loop</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>loop_df.head()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   color_loop   mag_loop
0    0.632171  21.411746
1    0.610238  21.322466
2    0.588449  21.233380
3    0.566924  21.144427
4    0.545461  21.054549</code></pre>
</div>
<p>Now we can pass <code>loop_df</code> to <code>Polygon</code>:</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Polygon</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>polygon <span class="op">=</span> Polygon(loop_df)</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>polygon</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;matplotlib.patches.Polygon at 0x7f439d33fdf0&gt;</code></pre>
</div>
<p>The result is a <code>Polygon</code> object which has a
<code>contains_points</code> method. This allows us to pass
<code>polygon.contains_points</code> a list of points and for each point
it will tell us if the point is contained within the polygon. A point is
a tuple with two elements, x and y.</p>
<div id="exercise-5-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>When we encounter a new object, it is good to create a toy example to
test that it does what we think it does. Define a list of two points
(represented as two tuples), one that should be inside the polygon and
one that should be outside the polygon. Call
<code>contains_points</code> on the polygon we just created, passing it
the list of points you defined, to verify that the results are as
expected.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>test_points <span class="op">=</span> [(<span class="fl">0.4</span>, <span class="dv">20</span>), </span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>           (<span class="fl">0.4</span>, <span class="dv">16</span>)]</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>test_inside_mask <span class="op">=</span> polygon.contains_points(test_points)</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>test_inside_mask</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>array([ True, False])</code></pre>
</div>
<p>The result is an array of Boolean values, and is as expected.</p>
</div>
</div>
</div>
</div>
<p>We are almost ready to select stars whose photometry data falls in
this polygon. But first we need to do some data cleaning.</p>
</section><section><h2 class="section-heading" id="save-the-polygon">Save the polygon<a class="anchor" aria-label="anchor" href="#save-the-polygon"></a>
</h2>
<hr class="half-width">
<p><a href="https://en.wikipedia.org/wiki/Reproducibility#Reproducible_research" class="external-link">Reproducibile
research</a> is “the idea that … the full computational environment used
to produce the results in the paper such as the code, data, etc. can be
used to reproduce the results and create new work based on the
research.”</p>
<p>This lesson is an example of reproducible research because it
contains all of the code needed to reproduce the results, including the
database queries that download the data and the analysis.</p>
<p>In this episode, we used an isochrone to derive a polygon, which we
used to select stars based on photometry. So it is important to record
the polygon as part of the data analysis pipeline.</p>
<p>Here is how we can save it in an HDF5 file.</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_data.hdf'</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>loop_df.to_hdf(filename, <span class="st">'loop_df'</span>)</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="selecting-based-on-photometry">Selecting based on photometry<a class="anchor" aria-label="anchor" href="#selecting-based-on-photometry"></a>
</h2>
<hr class="half-width">
<p>Now we will check how many of the candidate stars are inside the
polygon we chose. <code>contains_points</code> expects a list of (x,y)
pairs. As with creating the <code>Polygon</code>,
<code>DataFrames</code> are a convenient way to pass the colors and
magnitudes for all of our stars in <code>candidates_df</code> to our
<code>Polygon</code> to see which candidates are inside the polygon. We
will start by putting color and magnitude data from
<code>candidate_df</code> into a new <code>DataFrame</code>.</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>cmd_df <span class="op">=</span> pd.DataFrame()</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a>cmd_df[<span class="st">'color'</span>] <span class="op">=</span> candidate_df[<span class="st">'g_mean_psf_mag'</span>] <span class="op">-</span> candidate_df[<span class="st">'i_mean_psf_mag'</span>]</span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a>cmd_df[<span class="st">'mag'</span>] <span class="op">=</span> candidate_df[<span class="st">'g_mean_psf_mag'</span>]</span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a>cmd_df.head()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>    color      mag
0  0.3804  17.8978
1  1.6092  19.2873
2  0.4457  16.9238
3  1.5902  19.9242
4  1.4853  16.1516</code></pre>
</div>
<p>Which we can pass to <code>contains_points</code>:</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a>inside_mask <span class="op">=</span> polygon.contains_points(cmd_df)</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>inside_mask</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>array([False, False, False, ..., False, False, False])</code></pre>
</div>
<p>The result is a Boolean array.</p>
<div id="exercise-5-minutes-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes-1" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>Boolean values are stored as 0s and 1s. <code>FALSE</code> = 0 and
<code>TRUE</code> = 1. Use this information to determine the number of
stars that fall inside the polygon.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>inside_mask.<span class="bu">sum</span>()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">486</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Now we can use <code>inside_mask</code> as a mask to select stars
that fall inside the polygon.</p>
<div class="codewrapper sourceCode" id="cb40">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a>winner_df <span class="op">=</span> candidate_df[inside_mask]</span></code></pre>
</div>
<p>We will make a color-magnitude plot one more time, highlighting the
selected stars with green markers.</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>plot_cmd(candidate_df)</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a>plt.plot(iso_df[<span class="st">'color_g_i'</span>], iso_df[<span class="st">'mag_g'</span>])</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a>plt.plot(color_loop, mag_loop)</span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a>x <span class="op">=</span> winner_df[<span class="st">'g_mean_psf_mag'</span>] <span class="op">-</span> winner_df[<span class="st">'i_mean_psf_mag'</span>]</span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a>y <span class="op">=</span> winner_df[<span class="st">'g_mean_psf_mag'</span>]</span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a>plt.plot(x, y, <span class="st">'go'</span>, markersize<span class="op">=</span><span class="fl">0.5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)<span class="op">;</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 432x288 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/07-photo_files/07-photo_91_0.png" alt="Color magnitude diagram showing our selected stars in green, inside our polygon." class="figure mx-auto d-block"></figure><p>The selected stars are, in fact, inside the polygon, which means they
have photometry data consistent with GD-1.</p>
<p>Finally, we can plot the coordinates of the selected stars:</p>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="fl">2.5</span>))</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a>x <span class="op">=</span> winner_df[<span class="st">'phi1'</span>]</span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a>y <span class="op">=</span> winner_df[<span class="st">'phi2'</span>]</span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a>plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.7</span>, alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb43-6"><a href="#cb43-6" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" tabindex="-1"></a>plt.xlabel(<span class="st">'$\phi_1$ [deg]'</span>)</span>
<span id="cb43-8"><a href="#cb43-8" tabindex="-1"></a>plt.ylabel(<span class="st">'$\phi_2$ [deg]'</span>)</span>
<span id="cb43-9"><a href="#cb43-9" tabindex="-1"></a>plt.title(<span class="st">'Proper motion + photometry selection'</span>, fontsize<span class="op">=</span><span class="st">'medium'</span>)</span>
<span id="cb43-10"><a href="#cb43-10" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" tabindex="-1"></a>plt.axis(<span class="st">'equal'</span>)<span class="op">;</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 1000x250 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/08-plot_files/08-plot_13_0.png" alt="phi 1 and phi 2 of selected stars in the GD-1 frame after selecting for both proper motion and photometry." class="figure mx-auto d-block"></figure><p>This example includes the new Matplotlib command <code>figure</code>,
which creates the larger canvas that the subplots are placed on. In
previous examples, we didn’t have to use this function; the figure was
created automatically. But when we call it explicitly, we can provide
arguments like <code>figsize</code>, which sets the size of the figure.
It also returns a figure object which we will use to further customize
our plotting in the next episode.</p>
<p>In the example above we also used TeX markup in our axis labels so
that they render as the Greek letter <code>$\phi$</code> with subscripts
for <code>1</code> and <code>2</code>. Matplotlib also allows us to
write basic TeX markup by wrapping the text we want rendered as TeX with
<code>$</code> and then using TeX commands inside. This basic rendering
is performed with <a href="https://matplotlib.org/stable/tutorials/text/mathtext.html" class="external-link">mathtext</a>;
more advanced rendering with LaTex can be done with the
<code>usetex</code> option in <code>rcParams</code> which we will
discuss in Episode 7.</p>
<p>In the next episode we are going to make this plot several more
times, so it makes sense to make a function. As we have done with
previous functions we can copy and paste what we just wrote, replacing
the specific variable <code>winner_df</code> with the more generic
<code>df</code>.</p>
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="kw">def</span> plot_cmd_selection(df):</span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>    x <span class="op">=</span> df[<span class="st">'phi1'</span>]</span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a>    y <span class="op">=</span> df[<span class="st">'phi2'</span>]</span>
<span id="cb45-4"><a href="#cb45-4" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" tabindex="-1"></a>    plt.plot(x, y, <span class="st">'ko'</span>, markersize<span class="op">=</span><span class="fl">0.7</span>, alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb45-6"><a href="#cb45-6" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" tabindex="-1"></a>    plt.xlabel(<span class="st">'$\phi_1$ [deg]'</span>)</span>
<span id="cb45-8"><a href="#cb45-8" tabindex="-1"></a>    plt.ylabel(<span class="st">'$\phi_2$ [deg]'</span>)</span>
<span id="cb45-9"><a href="#cb45-9" tabindex="-1"></a>    plt.title(<span class="st">'Proper motion + photometry selection'</span>, fontsize<span class="op">=</span><span class="st">'medium'</span>)</span>
<span id="cb45-10"><a href="#cb45-10" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" tabindex="-1"></a>    plt.axis(<span class="st">'equal'</span>)</span></code></pre>
</div>
<p>And here is how we use the function.</p>
<div class="codewrapper sourceCode" id="cb46">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="fl">2.5</span>))</span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a>plot_cmd_selection(winner_df)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 1000x250 with 1 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/08-plot_files/08-plot_13_0.png" alt="phi 1 and phi 2 of selected stars in the GD-1 frame after selecting for both proper motion and photometry." class="figure mx-auto d-block"></figure></section><section><h2 class="section-heading" id="write-the-data">Write the data<a class="anchor" aria-label="anchor" href="#write-the-data"></a>
</h2>
<hr class="half-width">
<p>Finally, we will write the selected stars to a file.</p>
<div class="codewrapper sourceCode" id="cb48">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_data.hdf'</span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a>winner_df.to_hdf(filename, <span class="st">'winner_df'</span>)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb49">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a>MB <span class="op">=</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span></span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a>getsize(filename) <span class="op">/</span> MB</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">15.486198425292969</span></span></code></pre>
</div>
</section><section><h2 class="section-heading" id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<hr class="half-width">
<p>In this episode, we used photometry data from Pan-STARRS to draw a
color-magnitude diagram. We used an isochrone to define a polygon and
select stars we think are likely to be in GD-1. Plotting the results, we
have a clearer picture of GD-1, similar to Figure 1 in the original
paper.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<span class="callout-header">Key Points</span>
<div class="callout-inner">
<div class="callout-content">
<ul>
<li>Matplotlib provides operations for working with points, polygons,
and other geometric entities, so it is not just for making figures.</li>
<li>Use Matplotlib options to control the size and aspect ratio of
figures to make them easier to interpret.</li>
<li>Record every element of the data analysis pipeline that would be
needed to replicate the results.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-08-plot"><p>Content from <a href="08-plot.html">Visualization</a></p>
<hr>
<p>Last updated on 2025-09-30 |

        <a href="https://github.com/datacarpentry/astronomy-python/edit/main/episodes/08-plot.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 130 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What elements make a compelling visualization that authentically
reports scientific results ready for scientific presentation and
publication?</li>
<li>What tools and techniques are available to save time on creating
presentation and publication-ready figures?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Design a figure that tells a compelling story.</li>
<li>Use Matplotlib features to customize the appearance of figures.</li>
<li>Generate a figure with multiple subplots.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>In the previous episode, we selected photometry data from Pan-STARRS
and used it to identify stars we think are likely to be in GD-1.</p>
<p>In this episode, we will take the results from previous episodes and
use them to make a figure that tells a compelling scientific story.</p>
<div id="outline" class="callout checklist">
<div class="callout-square">
<i class="callout-icon" data-feather="check-square"></i>
</div>
<span class="callout-header">Checklist</span>
<div id="outline" class="callout-inner">
<h3 class="callout-title">Outline</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li><p>Starting with the figure from the previous episode, we will add
annotations to present the results more clearly.</p></li>
<li><p>Then we will learn several ways to customize figures to make them
more appealing and effective.</p></li>
<li><p>Finally, we will learn how to make a figure with multiple
panels.</p></li>
</ol>
</div>
</div>
</div>
<div id="starting-from-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<span class="callout-header">Prerequisite</span>
<div id="starting-from-this-episode" class="callout-inner">
<h3 class="callout-title">Starting from this episode</h3>
<div class="callout-content">
<p>If you are starting a new notebook for this episode, expand this
section for information you will need to get started.</p>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> Read me </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" aria-labelledby="headingSpoiler1" data-bs-parent="#accordionSpoiler1">
<div class="accordion-body">
<p>In the previous episode, we selected stars in GD-1 based on proper
motion and downloaded the spatial, proper motion, and photometry
information by joining the Gaia and PanSTARRs datasets. We will use that
data for this episode. Whether you are working from a new notebook or
coming back from a checkpoint, reloading the data will save you from
having to run the query again.</p>
<p>If you are starting this episode here or starting this episode in a
new notebook, you will need to run the following lines of code.</p>
<p>This imports previously imported functions:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Polygon</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="im">from</span> episode_functions <span class="im">import</span> <span class="op">*</span></span></code></pre>
</div>
<p>The following code loads in the data (instructions for downloading
data can be found in the <a href="index.html#setup">setup instructions</a>).
You may need to add a the path to the filename variable below
(e.g. <code>filename = 'student_download/backup-data/gd1_data.hdf'</code>)</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'gd1_data.hdf'</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>winner_df <span class="op">=</span> pd.read_hdf(filename, <span class="st">'winner_df'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>centerline_df <span class="op">=</span> pd.read_hdf(filename, <span class="st">'centerline_df'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>candidate_df <span class="op">=</span> pd.read_hdf(filename, <span class="st">'candidate_df'</span>)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>loop_df <span class="op">=</span> pd.read_hdf(filename, <span class="st">'loop_df'</span>)</span></code></pre>
</div>
<p>This defines previously defined quantities:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>pm1_min <span class="op">=</span> <span class="op">-</span><span class="fl">8.9</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>pm1_max <span class="op">=</span> <span class="op">-</span><span class="fl">6.9</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>pm2_min <span class="op">=</span> <span class="op">-</span><span class="fl">2.2</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>pm2_max <span class="op">=</span>  <span class="fl">1.0</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>pm1_rect, pm2_rect <span class="op">=</span> make_rectangle(</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>    pm1_min, pm1_max, pm2_min, pm2_max)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="making-figures-that-tell-a-story">Making Figures That Tell a Story<a class="anchor" aria-label="anchor" href="#making-figures-that-tell-a-story"></a>
</h2>
<hr class="half-width">
<p>The figures we have made so far have been “quick and dirty”. Mostly
we have used Matplotlib’s default style, although we have adjusted a few
parameters, like <code>markersize</code> and <code>alpha</code>, to
improve legibility.</p>
<p>Now that the analysis is done, it is time to think more about:</p>
<ol style="list-style-type: decimal">
<li><p>Making professional-looking figures that are ready for
publication.</p></li>
<li><p>Making figures that communicate a scientific result clearly and
compellingly.</p></li>
</ol>
<p>Not necessarily in that order.</p>
<p>We will start by reviewing Figure 1 from the original paper. We have
seen the individual panels, but now we will look at the whole figure,
along with the caption:</p>
<figure><img style="max-width: 100%;" src="../fig/gd1-5.png" alt="Figure 1 from Price-Whelan and Bonaca paper with four panels and caption. Caption reads: On-sky positions of likely GD-1 members in the GD-1 coordinate system. GD-1 is apparent as an overdensity in negative proper motions (top-right panel, orange box), so selecting on proper motion already reveals the stream in positions of individual stars (top-left panel). The stream also stands out in the color–magnitude diagram (bottom-right panel) as older and more metal-poor than the background. Selecting the main sequence of GD-1 (orange, shaded region in the bottom-right panel) along with proper motion cuts unveils the stream in unprecedented detail (bottom-left panel)." class="figure mx-auto d-block"></figure><div id="exercise-10-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-10-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (10 minutes)</h3>
<div class="callout-content">
<p>Think about the following questions:</p>
<ol style="list-style-type: decimal">
<li><p>What is the primary scientific result of this work?</p></li>
<li><p>What story is this figure telling?</p></li>
<li><p>In the design of this figure, can you identify 1 or 2 choices the
authors made that you think are effective? Think about big-picture
elements, like the number of panels and how they are arranged, as well
as details like the choice of typeface.</p></li>
<li><p>Can you identify 1 or 2 elements that could be improved, or that
you might have done differently?</p></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>No figure is perfect, and everyone can be a critic. Here are some
topics that could come up in this discussion:</p>
<ol style="list-style-type: decimal">
<li><p>The primary result is that adding physical selection criteria
makes it possible to separate likely candidates from the background more
effectively than in previous work, which makes it possible to see the
structure of GD-1 in “unprecedented detail,” allowing the authors to
detect that the stream is larger than previously observed.</p></li>
<li><p>The figure documents the selection process as a sequence of
reproducible steps, containing enough information for a skeptical reader
to understand the authors’ choices. Reading right-to-left,
top-to-bottom, we see selection based on proper motion, the results of
the first selection, selection based on stellar surface properties
(color and magnitude), and the results of the second selection. So this
figure documents the methodology, presents the primary result, and
serves as reference for other parts of the paper (and presumably, talk,
if this figure is reused for colloquia).</p></li>
<li><p>The figure is mostly black and white, with minimal use of color,
and mostly uses large fonts. It will likely work well in print and only
needs a few adjustments to be accessible to low vision readers and none
to accommodate those with poor color vision. The annotations in the
bottom left panel guide the reader to the results discussed in the
text.</p></li>
<li><p>The panels that can have the same units, dimensions, and their
axes are aligned, do.</p></li>
<li><p>The on-sky positions likely do not need so much white
space.</p></li>
<li><p>Axes ticks for the on-sky position figures are not necessary
since this is not in an intuitive coordinate system or a finder chart.
Instead, we would suggest size bar annotations for each dimension to
give the reader the needed scale.</p></li>
<li><p>The text annotations could be darker for more contrast and appear
only over white background to increase accessibility</p></li>
<li><p>The legend in the bottom right panel has a font too small for
low-vision readers. At the very least, those details (and the isochrone
line) could be called out in the caption.</p></li>
</ol>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="plotting-gd-1-with-annotations">Plotting GD-1 with Annotations<a class="anchor" aria-label="anchor" href="#plotting-gd-1-with-annotations"></a>
</h2>
<hr class="half-width">
<p>The lower left panel in the paper uses three other features to
present the results more clearly and compellingly:</p>
<ul>
<li><p>A vertical dashed line to distinguish the previously undetected
region of GD-1,</p></li>
<li><p>A label that identifies the new region, and</p></li>
<li><p>Several annotations that combine text and arrows to identify
features of GD-1.</p></li>
</ul>
<div id="exercise-20-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-20-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (20 minutes)</h3>
<div class="callout-content">
<p>Plot the selected stars in <code>winner_df</code> using the
<code>plot_cmd_selection</code> function and then choose any or all of
these features and add them to the figure:</p>
<ul>
<li><p>To draw vertical lines, see <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.vlines.html" class="external-link"><code>plt.vlines</code></a>
and <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.axvline.html" class="external-link"><code>plt.axvline</code></a>.</p></li>
<li><p>To add text, see <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.text.html" class="external-link"><code>plt.text</code></a>.</p></li>
<li><p>To add an annotation with text and an arrow, see <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.annotate.html" class="external-link"><code>plt.annotate</code></a>.</p></li>
</ul>
<p>Here is some <a href="https://matplotlib.org/stable/tutorials/text/annotations.html" class="external-link">additional
information about text and arrows</a>.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="fl">2.5</span>))</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>plot_cmd_selection(winner_df)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>plt.axvline(<span class="op">-</span><span class="dv">55</span>, ls<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'gray'</span>, </span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>            alpha<span class="op">=</span><span class="fl">0.4</span>, dashes<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">4</span>), lw<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>plt.text(<span class="op">-</span><span class="dv">60</span>, <span class="fl">5.5</span>, <span class="st">'Previously</span><span class="ch">\n</span><span class="st">undetected'</span>, </span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>         fontsize<span class="op">=</span><span class="st">'small'</span>, ha<span class="op">=</span><span class="st">'right'</span>, va<span class="op">=</span><span class="st">'top'</span>)</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>arrowprops<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'gray'</span>, shrink<span class="op">=</span><span class="fl">0.05</span>, width<span class="op">=</span><span class="fl">1.5</span>, </span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>                headwidth<span class="op">=</span><span class="dv">6</span>, headlength<span class="op">=</span><span class="dv">8</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>plt.annotate(<span class="st">'Spur'</span>, xy<span class="op">=</span>(<span class="op">-</span><span class="dv">33</span>, <span class="dv">2</span>), xytext<span class="op">=</span>(<span class="op">-</span><span class="dv">35</span>, <span class="fl">5.5</span>),</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>             arrowprops<span class="op">=</span>arrowprops,</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="st">'small'</span>)</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>plt.annotate(<span class="st">'Gap'</span>, xy<span class="op">=</span>(<span class="op">-</span><span class="dv">22</span>, <span class="op">-</span><span class="dv">1</span>), xytext<span class="op">=</span>(<span class="op">-</span><span class="dv">25</span>, <span class="op">-</span><span class="fl">5.5</span>),</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>             arrowprops<span class="op">=</span>arrowprops,</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="st">'small'</span>)<span class="op">;</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="customization">Customization<a class="anchor" aria-label="anchor" href="#customization"></a>
</h2>
<hr class="half-width">
<p>Matplotlib provides a default style that determines things like the
colors of lines, the placement of labels and ticks on the axes, and many
other properties.</p>
<p>There are several ways to override these defaults and customize your
figures:</p>
<ul>
<li><p>To customize only the current figure, you can call functions like
<code>tick_params</code>, which we will demonstrate below.</p></li>
<li><p>To customize all figures in a notebook, you can use
<code>rcParams</code>.</p></li>
<li><p>To override more than a few defaults at the same time, you can
use a style sheet.</p></li>
</ul>
<p>As a simple example, notice that Matplotlib puts ticks on the outside
of the figures by default, and only on the left and bottom sides of the
axes.</p>
<div id="note-on-accessibility" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="note-on-accessibility" class="callout-inner">
<h3 class="callout-title">Note on Accessibility</h3>
<div class="callout-content">
<p>Customization offers a high degree of personalization for creating
scientific visualizations. It is important to also create accessible
visualizations for a broad audience that may include low-vision or
color-blind individuals. The AAS Journals provide a Graphics Guide for
authors with tips and external links that can help you produce more
accessible graphics: <a href="https://journals.aas.org/graphics-guide/" class="external-link">https://journals.aas.org/graphics-guide/</a></p>
</div>
</div>
</div>
<p>So far, everything we have wanted to do we could call directly from
the pyplot module with <code>plt.</code>. As you do more and more
customization you may need to run some methods on plotting objects
themselves. To use the method that changes the direction of the ticks we
need an <code>axes</code> object. So far, Matplotlib has implicitly
created our <code>axes</code> object when we called
<code>plt.plot</code>. To explicitly create an <code>axes</code> object
we can first create our <code>figure</code> object and then add an
<code>axes</code> object to it.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="fl">2.5</span>))</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span></code></pre>
</div>
<div id="subplot-and-axes" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="subplot-and-axes" class="callout-inner">
<h3 class="callout-title">
<code>subplot</code> and
<code>axes</code>
</h3>
<div class="callout-content">
<p>Confusingly, in Matplotlib the objects <code>subplot</code> and
<code>axes</code> are often used interchangeably. This is because a
<code>subplot</code> is an <code>axes</code> object with additional
methods and attributes.</p>
</div>
</div>
</div>
<p>You can use the <a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.add_subplot" class="external-link"><code>add_subplot</code></a>
method to add more than one <code>axes</code> object to a figure. For
this reason you have to specify the total number of columns, total
number of rows, and which plot number you are creating
(<code>fig.add_subplot(ncols, nrows, pltnum)</code>). The plot number
starts in the upper left corner and goes left to right and then top to
bottom. In the example above we have one column, one row, and we’re
plotting into the first plot space.</p>
<p>Now we are ready to change the direction of the ticks to the inside
of the axes using our new axes object.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="fl">2.5</span>))</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>ax.tick_params(direction<span class="op">=</span><span class="st">'in'</span>)</span></code></pre>
</div>
<div id="exercise-5-minutes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>Read the documentation of <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.tick_params.html" class="external-link"><code>tick_params</code></a>
and use it to put ticks on the top and right sides of the axes.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="fl">2.5</span>))</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>ax.tick_params(top<span class="op">=</span><span class="va">True</span>, right<span class="op">=</span><span class="va">True</span>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="rcparams">rcParams<a class="anchor" aria-label="anchor" href="#rcparams"></a>
</h2>
<hr class="half-width">
<p>If you want to make a customization that applies to all figures in a
notebook, you can use <code>rcParams</code>. When you import Matplotlib,
a dictionary is created with default values for everything you can
change about your plot. This is what you are overriding with
<code>tick_params</code> above.</p>
<p>Here is an example that reads the current font size from
<code>rcParams</code>:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>plt.rcParams[<span class="st">'font.size'</span>]</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">10.0</span></span></code></pre>
</div>
<p>And sets it to a new value:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>plt.rcParams[<span class="st">'font.size'</span>] <span class="op">=</span> <span class="dv">14</span></span></code></pre>
</div>
<div id="exercise-5-minutes-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes-1" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>Plot the previous figure again, and see what font sizes have changed.
Look up any other element of <code>rcParams</code>, change its value,
and check the effect on the figure.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Show me the solution </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" aria-labelledby="headingSolution4" data-bs-parent="#accordionSolution4">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="fl">2.5</span>))</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>ax.tick_params(top<span class="op">=</span><span class="va">True</span>, right<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co"># Looking up the 'axes.edgecolor' rcParams value</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="bu">print</span>(plt.rcParams[<span class="st">'axes.edgecolor'</span>])</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>plt.rcParams[<span class="st">'axes.edgecolor'</span>] <span class="op">=</span> <span class="st">'red'</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="fl">2.5</span>))</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>ax.tick_params(top<span class="op">=</span><span class="va">True</span>, right<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="co"># changing the rcParams value back to its original value</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>plt.rcParams[<span class="st">'axes.edgecolor'</span>] <span class="op">=</span> <span class="st">'black'</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>When you import Matplotlib, <code>plt.rcParams</code> is populated
from a matplotlibrc file. If you want to permanently change a setting
for every plot you make, you can set that in your matplotlibrc file. To
find out where your matplotlibrc file lives type:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>mpl.matplotlib_fname()</span></code></pre>
</div>
<p>If the file doesn’t exist, you can download <a href="https://matplotlib.org/stable/tutorials/introductory/customizing.html#matplotlibrc-sample" class="external-link">a
sample matplotlibrc file</a> to modify.</p>
</section><section><h2 class="section-heading" id="style-sheets">Style sheets<a class="anchor" aria-label="anchor" href="#style-sheets"></a>
</h2>
<hr class="half-width">
<p>It is possible that you would like multiple sets of defaults, for
example, one default for plots for scientific papers and another for
talks or posters. Because the <code>matplotlibrc</code> file is read
when you import Matplotlib, it is not easy to switch from one set of
options to another.</p>
<p>The solution to this problem is style sheets, <a href="https://matplotlib.org/stable/tutorials/introductory/customizing.html" class="external-link">which
you can read about here</a>.</p>
<p>Matplotlib provides a set of predefined style sheets, or you can make
your own. The <a href="https://matplotlib.org/stable/gallery/style_sheets/style_sheets_reference.html" class="external-link">style
sheets reference</a> shows a gallery of plots generated by common style
sheets.</p>
<p>You can display a list of style sheets installed on your system.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>plt.style.available</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>['Solarize_Light2',
 '_classic_test_patch',
 'bmh',
 'classic',
 'dark_background',
 'fast',
 'fivethirtyeight',
 'ggplot',
 'grayscale',
 'seaborn',
 'seaborn-bright',
[Output truncated]</code></pre>
</div>
<p>Note that <code>seaborn-paper</code>, <code>seaborn-talk</code> and
<code>seaborn-poster</code> are particularly intended to prepare
versions of a figure with text sizes and other features that work well
in papers, talks, and posters.</p>
<p>To use any of these style sheets, run <code>plt.style.use</code> like
this:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>plt.style.use(<span class="st">'fivethirtyeight'</span>)</span></code></pre>
</div>
<p>The style sheet you choose will affect the appearance of all figures
you plot after calling <code>use</code>, unless you override any of the
options or call <code>use</code> again.</p>
<div id="return-to-default" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<span class="callout-header">Callout</span>
<div id="return-to-default" class="callout-inner">
<h3 class="callout-title">Return to Default</h3>
<div class="callout-content">
<p>To switch back to the default style use</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>plt.style.use(<span class="st">'default'</span>)</span></code></pre>
</div>
</div>
</div>
</div>
<div id="exercise-5-minutes-2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes-2" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>Choose one of the styles on the list and select it by calling
<code>use</code>. Then go back and plot one of the previous figures to
see what changes in the figure’s appearance.</p>
</div>
</div>
</div>
<div id="accordionSolution5" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution5" aria-expanded="false" aria-controls="collapseSolution5">
  <h4 class="accordion-header" id="headingSolution5"> Show me the solution </h4>
</button>
<div id="collapseSolution5" class="accordion-collapse collapse" aria-labelledby="headingSolution5" data-bs-parent="#accordionSolution5">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>plt.style.use(<span class="st">'seaborn-bright'</span>)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>plot_cmd(candidate_df)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>plt.plot(left_color, g, label<span class="op">=</span><span class="st">'left color'</span>)</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>plt.plot(right_color, g, label<span class="op">=</span><span class="st">'right color'</span>)</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code></pre>
</div>
<p>If you cannot find a style sheet that is exactly what you want, you
can make your own. This repository includes a style sheet called
<code>az-paper-twocol.mplstyle</code>, with customizations chosen by
Azalee Bostroem for publication in astronomy journals.</p>
</div>
</div>
</div>
</div>
<p>You can use it like this:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>plt.style.use(<span class="st">'./az-paper-twocol.mplstyle'</span>)</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>plot_cmd(candidate_df)</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>plt.plot(left_color, g, label<span class="op">=</span><span class="st">'left color'</span>)</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>plt.plot(right_color, g, label<span class="op">=</span><span class="st">'right color'</span>)</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code></pre>
</div>
<p>The prefix <code>./</code> tells Matplotlib to look for the file in
the current directory.</p>
<p>As an alternative, you can install a style sheet for your own use by
putting it into a directory named <code>stylelib/</code> in your
configuration directory.<br>
To find out where the Matplotlib configuration directory is, you can run
the following command:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>mpl.get_configdir()</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="multiple-panels">Multiple panels<a class="anchor" aria-label="anchor" href="#multiple-panels"></a>
</h2>
<hr class="half-width">
<p>So far we have been working with one figure at a time, but the figure
we are replicating contains multiple panels. We will create each of
these panels as a different subplot. Matplotlib has multiple functions
for making figures with multiple panels. We have already used <a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.add_subplot" class="external-link"><code>add_subplot</code></a>
- however, this creates equal sized panels. For this reason, we will use
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplot2grid.html" class="external-link"><code>subplot2grid</code></a>
which allows us to control the relative sizes of the panels.</p>
<p>Since we have already written functions that generate each panel of
this figure, we can now create the full multi-panel figure by creating
each subplot and then run our plotting function.</p>
<p>Like <a href="https://matplotlib.org/stable/api/figure_api.html#matplotlib.figure.Figure.add_subplot" class="external-link"><code>add_subplot</code></a>,
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.subplot2grid.html" class="external-link"><code>subplot2grid</code></a>
requires us to specify the total number of columns and rows in the grid
(this time as a tuple called <code>shape</code>), and the location of
the subplot (<code>loc</code>) - a tuple identifying the location in the
grid we are about to fill.</p>
<p>In this example, <code>shape</code> is <code>(2, 2)</code> to create
two rows and two columns.</p>
<p>For the first panel, <code>loc</code> is <code>(0, 0)</code>, which
indicates row 0 and column 0, which is the upper-left panel.</p>
<p>Here is how we use this function to draw the four panels.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>plt.style.use(<span class="st">'default'</span>)</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>shape <span class="op">=</span> (<span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>ax1 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>plot_pm_selection(candidate_df)</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>ax2 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>plot_proper_motion(centerline_df)</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>ax3 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>plot_cmd_selection(winner_df)</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>ax4 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a>plot_cmd(candidate_df)</span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a>plt.tight_layout()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 640x480 with 4 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/08-plot_files/08-plot_equal_size_fig1.png" alt="Four paneled plot showing our first recreation of figure 1 from the Price-Whelan and Bonaca paper." class="figure mx-auto d-block"></figure><p>We use <a href="https://matplotlib.org/stable/tutorials/intermediate/tight_layout_guide.html" class="external-link"><code>plt.tight_layout</code></a>
at the end, which adjusts the sizes of the panels to make sure the
titles and axis labels don’t overlap. Notice how convenient it is that
we have written functions to plot each panel. This code is concise and
readable: we can tell what is being plotted in each panel thanks to our
explicit function names and we know what function to investigate if we
want to see the mechanics of exactly how the plotting is done.</p>
<div id="exercise-5-minutes-3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes-3" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>What happens if you leave out <code>tight_layout</code>?</p>
</div>
</div>
</div>
<div id="accordionSolution6" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution6" aria-expanded="false" aria-controls="collapseSolution6">
  <h4 class="accordion-header" id="headingSolution6"> Show me the solution </h4>
</button>
<div id="collapseSolution6" class="accordion-collapse collapse" aria-labelledby="headingSolution6" data-bs-parent="#accordionSolution6">
<div class="accordion-body">
<p>Without <code>tight_layout</code> the space between the panels is too
small. In this situation, the titles from the lower plots overlap with
the x-axis labels from the upper panels and the axis labels from the
right-hand panels overlap with the plots in the left-hand panels.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="adjusting-proportions">Adjusting proportions<a class="anchor" aria-label="anchor" href="#adjusting-proportions"></a>
</h2>
<hr class="half-width">
<p>In the previous figure, the panels are all the same size. To get a
better view of GD-1, we would like to stretch the panels on the left and
compress the ones on the right.</p>
<p>To do that, we will use the <code>colspan</code> argument to make a
panel that spans multiple columns in the grid. To do this we will need
more columns so we will change the <code>shape</code> from (2,2) to
(2,4).</p>
<p>The panels on the left span three columns, so they are three times
wider than the panels on the right.</p>
<p>At the same time, we use <code>figsize</code> to adjust the aspect
ratio of the whole figure.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="fl">4.5</span>))</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>shape <span class="op">=</span> (<span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>ax1 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">0</span>, <span class="dv">0</span>), colspan<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>plot_pm_selection(candidate_df)</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>ax2 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">0</span>, <span class="dv">3</span>))</span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a>plot_proper_motion(centerline_df)</span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>ax3 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">1</span>, <span class="dv">0</span>), colspan<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a>plot_cmd_selection(winner_df)</span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>ax4 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a>plot_cmd(candidate_df)</span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a>plt.tight_layout()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 900x450 with 4 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/08-plot_files/08-plot_adjusted_size_fig1.png" alt="Four paneled plot we created above with two left-hand panels increased in width." class="figure mx-auto d-block"></figure><p>This is looking more and more like the figure in the paper.</p>
<div id="exercise-5-minutes-4" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes-4" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>In this example, the ratio of the widths of the panels is 3:1. How
would you adjust it if you wanted the ratio to be 3:2?</p>
</div>
</div>
</div>
<div id="accordionSolution7" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution7" aria-expanded="false" aria-controls="collapseSolution7">
  <h4 class="accordion-header" id="headingSolution7"> Show me the solution </h4>
</button>
<div id="collapseSolution7" class="accordion-collapse collapse" aria-labelledby="headingSolution7" data-bs-parent="#accordionSolution7">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="fl">4.5</span>))</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>shape <span class="op">=</span> (<span class="dv">2</span>, <span class="dv">5</span>)                                   <span class="co"># CHANGED</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>ax1 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">0</span>, <span class="dv">0</span>), colspan<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>plot_pm_selection(candidate_df)</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>ax2 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">0</span>, <span class="dv">3</span>), colspan<span class="op">=</span><span class="dv">2</span>)       <span class="co"># CHANGED</span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>plot_proper_motion(centerline_df)</span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>ax3 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">1</span>, <span class="dv">0</span>), colspan<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>plot_cmd_selection(winner_df)</span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a>ax4 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">1</span>, <span class="dv">3</span>), colspan<span class="op">=</span><span class="dv">2</span>)       <span class="co"># CHANGED</span></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>plot_cmd(candidate_df)</span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a>plt.tight_layout()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="adding-the-shaded-regions">Adding the shaded regions<a class="anchor" aria-label="anchor" href="#adding-the-shaded-regions"></a>
</h2>
<hr class="half-width">
<p>The one thing our figure is missing is the shaded regions showing the
stars selected by proper motion and around the isochrone in the color
magnitude diagram.</p>
<p>In episode 4 we defined a rectangle in proper motion space around the
stars in GD-1. We stored the x-values of the vertices of this rectangle
in <code>pm1_rect</code> and the y-values as <code>pm2_rect</code>.</p>
<p>To plot this rectangle, we will use the Matplotlib
<code>Polygon</code> object which we used in episode 7 to check which
points were inside the polygon. However, this time we will be plotting
the <code>Polygon</code>.</p>
<p>To create a <code>Polygon</code>, we have to put the coordinates of
the rectangle in an array with <code>x</code> values in the first column
and <code>y</code> values in the second column.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>vertices <span class="op">=</span> np.transpose([pm1_rect, pm2_rect])</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>vertices</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>array([[-8.9, -2.2],
       [-8.9,  1. ],
       [-6.9,  1. ],
       [-6.9, -2.2]])</code></pre>
</div>
<p>We will now create the <code>Polygon</code>, specifying its display
properties which will be used when it is plotted. We will specify
<code>closed=True</code> to make sure the shape is closed,
<code>facecolor='orange</code> to color the inside of the
<code>Polygon</code> orange, and <code>alpha=0.4</code> to make the
<code>Polygon</code> semi-transparent.</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>poly <span class="op">=</span> Polygon(vertices, closed<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>                   facecolor<span class="op">=</span><span class="st">'orange'</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span></code></pre>
</div>
<p>Then to plot the <code>Polygon</code> we call the
<code>add_patch</code> method. <code>add_patch</code> like
<code>tick_params</code> must be called on an <code>axes</code> or
<code>subplot</code> object, so we will create a <code>subplot</code>
and then add the <code>Patch</code> to the <code>subplot</code>.</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>poly <span class="op">=</span> Polygon(vertices, closed<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>                   facecolor<span class="op">=</span><span class="st">'orange'</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>ax.add_patch(poly)</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>ax.set_xlim(<span class="op">-</span><span class="dv">10</span>, <span class="fl">7.5</span>)</span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>ax.set_ylim(<span class="op">-</span><span class="dv">10</span>, <span class="dv">10</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 900x450 with 4 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/08-plot_files/08-poly_example.png" alt="An orange rectangle at the coordinates used to select stars based on proper motion." class="figure mx-auto d-block"></figure><p>We can now call our plot_proper_motion function to plot the proper
motion for each star, and the add a shaded <code>Polygon</code> to show
the region we selected.</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>plot_proper_motion(centerline_df)</span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>poly <span class="op">=</span> Polygon(vertices, closed<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>               facecolor<span class="op">=</span><span class="st">'C1'</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>ax.add_patch(poly)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 900x450 with 4 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/08-plot_files/08-plot_53_0.png" alt="Proper motion with overlaid polygon showing our selected stars." class="figure mx-auto d-block"></figure><div id="exercise-5-minutes-5" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes-5" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>Add a few lines to be run after the <code>plot_cmd</code> function to
show the polygon we selected as a shaded area.</p>
<p>Hint: pass <code>loop_df</code> as an argument to
<code>Polygon</code> as we did in episode 7 and then plot it using
<code>add_patch</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution8" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution8" aria-expanded="false" aria-controls="collapseSolution8">
  <h4 class="accordion-header" id="headingSolution8"> Show me the solution </h4>
</button>
<div id="collapseSolution8" class="accordion-collapse collapse" aria-labelledby="headingSolution8" data-bs-parent="#accordionSolution8">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a>poly_cmd <span class="op">=</span> Polygon(loop_df, closed<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>              facecolor<span class="op">=</span><span class="st">'C1'</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>ax.add_patch(poly_cmd)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="exercise-5-minutes-6" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<span class="callout-header">Challenge</span>
<div id="exercise-5-minutes-6" class="callout-inner">
<h3 class="callout-title">Exercise (5 minutes)</h3>
<div class="callout-content">
<p>Add the <code>Polygon</code> patches you just created to the right
panels of the four panel figure.</p>
</div>
</div>
</div>
<div id="accordionSolution9" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution9" aria-expanded="false" aria-controls="collapseSolution9">
  <h4 class="accordion-header" id="headingSolution9"> Show me the solution </h4>
</button>
<div id="collapseSolution9" class="accordion-collapse collapse" aria-labelledby="headingSolution9" data-bs-parent="#accordionSolution9">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="fl">4.5</span>))</span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>shape <span class="op">=</span> (<span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a>ax1 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">0</span>, <span class="dv">0</span>), colspan<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a>plot_pm_selection(candidate_df)</span>
<span id="cb33-6"><a href="#cb33-6" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" tabindex="-1"></a>ax2 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">0</span>, <span class="dv">3</span>))</span>
<span id="cb33-8"><a href="#cb33-8" tabindex="-1"></a>plot_proper_motion(centerline_df)</span>
<span id="cb33-9"><a href="#cb33-9" tabindex="-1"></a>poly <span class="op">=</span> Polygon(vertices, closed<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb33-10"><a href="#cb33-10" tabindex="-1"></a>               facecolor<span class="op">=</span><span class="st">'orange'</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb33-11"><a href="#cb33-11" tabindex="-1"></a>ax2.add_patch(poly)</span>
<span id="cb33-12"><a href="#cb33-12" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" tabindex="-1"></a>ax3 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">1</span>, <span class="dv">0</span>), colspan<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb33-14"><a href="#cb33-14" tabindex="-1"></a>plot_cmd_selection(winner_df)</span>
<span id="cb33-15"><a href="#cb33-15" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" tabindex="-1"></a>ax4 <span class="op">=</span> plt.subplot2grid(shape, (<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb33-17"><a href="#cb33-17" tabindex="-1"></a>plot_cmd(candidate_df)</span>
<span id="cb33-18"><a href="#cb33-18" tabindex="-1"></a>poly_cmd <span class="op">=</span> Polygon(loop_df, closed<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb33-19"><a href="#cb33-19" tabindex="-1"></a>               facecolor<span class="op">=</span><span class="st">'orange'</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb33-20"><a href="#cb33-20" tabindex="-1"></a>ax4.add_patch(poly_cmd)</span>
<span id="cb33-21"><a href="#cb33-21" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" tabindex="-1"></a>plt.tight_layout()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;Figure size 900x450 with 4 Axes&gt;</code></pre>
</div>
<figure><img src="../fig/08-plot_files/08-plot_72_0.png" alt="Four paneled plot we created above with two left-hand panels increased in width." class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<hr class="half-width">
<p>In this episode, we reverse-engineered the figure we have been
replicating, identifying elements that seem effective and others that
could be improved.</p>
<p>We explored features Matplotlib provides for adding annotations to
figures – including text, lines, arrows, and polygons – and several ways
to customize the appearance of figures. And we learned how to create
figures that contain multiple panels.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<span class="callout-header">Key Points</span>
<div class="callout-inner">
<div class="callout-content">
<ul>
<li>Effective figures focus on telling a single story clearly and
authentically. The major decisions needed in creating an effective
summary figure like this one can be done away from a computer and built
up from low fidelity (hand drawn) to high (tweaking rcParams,
etc.).</li>
<li>Consider using annotations to guide the reader’s attention to the
most important elements of a figure, while keeping in mind accessibility
issues that such detail may introduce.</li>
<li>The default Matplotlib style generates good quality figures, but
there are several ways you can override the defaults.</li>
<li>If you find yourself making the same customizations on several
projects, you might want to create your own style sheet.</li>
</ul>
</div>
</div>
</div>
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/datacarpentry/astronomy-python/edit/main/README.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/datacarpentry/astronomy-python/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/datacarpentry/astronomy-python/" class="external-link">Source</a></p>
				<p><a href="https://github.com/datacarpentry/astronomy-python/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.17.1" class="external-link">sandpaper (0.17.1)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.7" class="external-link">varnish (1.0.7)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "LearningResource",
  "@id": "https://datacarpentry.github.io/astronomy-python/instructor/aio.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/LearningResource/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://datacarpentry.github.io/astronomy-python/instructor/aio.html",
  "identifier": "https://datacarpentry.github.io/astronomy-python/instructor/aio.html",
  "dateCreated": "2020-05-11",
  "dateModified": "2025-10-14",
  "datePublished": "2025-10-14"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo --><script>
          var _paq = window._paq = window._paq || [];
          /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
          _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
          _paq.push(["setDomains", ["*.lessons.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
          _paq.push(["setDoNotTrack", true]);
          _paq.push(["disableCookies"]);
          _paq.push(["trackPageView"]);
          _paq.push(["enableLinkTracking"]);
          (function() {
              var u="https://matomo.carpentries.org/";
              _paq.push(["setTrackerUrl", u+"matomo.php"]);
              _paq.push(["setSiteId", "1"]);
              var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0];
              g.async=true; g.src="https://matomo.carpentries.org/matomo.js"; s.parentNode.insertBefore(g,s);
          })();
        </script><!-- End Matomo Code -->
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

